<!DOCTYPE html>
<!--
GÜVENLİK NOTU: Bu uygulama bir web sunucusu üzerinden çalıştırılacaksa,
aşağıdaki HTTP response header'larının sunucu tarafında ayarlanması önerilir:

- Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' https://pagead2.googlesyndication.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://www.googleapis.com https://openlibrary.org https://api.allorigins.win https://api.codetabs.com https://cors-anywhere.herokuapp.com https://corsproxy.io https://api.cors.sh https://proxycors.com https://yacdn.org https://thingproxy.freeboard.io https://allorigins.win https://covers.openlibrary.org https://www.dr.com.tr https://www.bkmkitap.com https://www.kitapyurdu.com https://www.hepsiburada.com https://www.trendyol.com https://www.amazon.com.tr https://googleads.g.doubleclick.net https://tpc.googlesyndication.com;

- X-Content-Type-Options: nosniff

- Referrer-Policy: strict-origin-when-cross-origin

- X-Frame-Options: DENY (veya SAMEORIGIN)

Bu header'lar XSS, clickjacking ve diğer güvenlik açıklarını önlemeye yardımcı olur.
-->
<html lang="tr">
    <head>
        <meta charset="UTF-8">
        <meta name="google-site-verification" content="71BV-5hmgGKA50aZUcpz3ESUpO30q9id2KsjXlpw8Ck" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Arama Uygulaması</title>
        <link rel="stylesheet" href="./styles/badges.css?v=2.0.0">
        <!-- Google AdSense -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-xxxxxxxxxx" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --text-white: white;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.3);
            --card-bg: white;
            --input-bg: white;
            --input-border: #ddd;
            --safe-area-inset-top: 0px !important;
        }

        #banner-space {
            width: 100%;
            height: 65px;
            pointer-events: none;
        }

        @media (prefers-color-scheme: dark) {
            body:not(.light-mode):not(.dark-mode) {
                --bg-primary: linear-gradient(135deg, #2d1b4e 0%, #1a0f2e 100%);
                --bg-secondary: #1e1e1e;
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-white: #e0e0e0;
                --border-color: #444;
                --shadow: rgba(0,0,0,0.6);
                --card-bg: #2d2d2d;
                --input-bg: #2d2d2d;
                --input-border: #555;
            }
        }

        /* Manuel koyu mod */
        body.dark-mode {
            --bg-primary: linear-gradient(135deg, #2d1b4e 0%, #1a0f2e 100%);
            --bg-secondary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-white: #e0e0e0;
            --border-color: #444;
            --shadow: rgba(0,0,0,0.6);
            --card-bg: #2d2d2d;
            --input-bg: #2d2d2d;
            --input-border: #555;
        }

        /* Manuel açık mod (prefers-color-scheme: dark olsa bile) */
        body.light-mode {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --text-white: white;
            --border-color: #ddd;
            --shadow: rgba(0,0,0,0.3);
            --card-bg: white;
            --input-bg: white;
            --input-border: #ddd;
        }

        html {
            margin: 0;
            padding: 0;
            padding-top: 0 !important;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 0;
            position: relative;
        }

        .header-actions {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .favorites-btn {
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            color: #222;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: 28px;
            display: flex;
            align-items: center;
        }

        body.dark-mode .favorites-btn {
            background: rgba(255,255,255,0.2);
            color: #ddd;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .favorites-btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        body.dark-mode .favorites-btn:hover {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .favorites-btn .badge {
            background: #e74c3c;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }

        .theme-toggle-btn {
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            color: #222;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: 28px;
        }

        body.dark-mode .theme-toggle-btn {
            background: rgba(255,255,255,0.2);
            color: #ddd;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .theme-toggle-btn:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        body.dark-mode .theme-toggle-btn:hover {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .theme-toggle-btn .icon {
            font-size: 16px;
        }

        .badge-button {
            background: #3a3a3a;
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            width: fit-content;
            margin: 10px auto;
            border: none;
            transition: all 0.3s;
        }

        .badge-button:hover {
            background: #4a4a4a;
            transform: translateY(-1px);
        }

        .badge-notif {
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            display: none;
        }

        .badge-notif.active {
            display: inline-block;
        }

        .badges-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .modal-content {
            width: 85%;
            background: #2e2e2e;
            padding: 20px;
            border-radius: 12px;
            color: white;
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .badge-card {
            background: #1f1f1f;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            opacity: 0.4;
            border: 2px solid #444;
        }

        .badge-card.unlocked {
            opacity: 1;
            border-color: gold;
        }

        .badge-card button {
            margin-top: 8px;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background: #ff9800;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn {
            background: #e53935;
            padding: 10px;
            border-radius: 8px;
            color: white;
            width: 100%;
            border: none;
            margin-top: 10px;
            cursor: pointer;
        }

        .user-title-box {
            background: #242424;
            padding: 10px 15px;
            margin: 10px auto;
            width: fit-content;
            border-radius: 12px;
            color: #ffd54f;
            font-size: 15px;
            font-weight: bold;
            text-align: center;
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .search-container {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow);
            margin-bottom: 30px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .quote-box {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            margin-top: 0;
            padding: 15px;
            background: white;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Günün sözü kutucuğu - tıklanabilir değil */

        .quote-text {
            font-size: 16px;
            color: var(--text-primary);
            font-style: italic;
            margin-bottom: 10px;
            line-height: 1.6;
            text-align: center;
        }

        .quote-author {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: right;
            font-weight: 500;
            margin-top: 5px;
        }

        .quote-author::before {
            content: "— ";
        }

        body.dark-mode .quote-box {
            background: #2d2d2d;
            border-color: #555;
        }

        @media (prefers-color-scheme: dark) {
            body:not(.light-mode):not(.dark-mode) .quote-box {
                background: #2d2d2d;
                border-color: #555;
            }
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .search-history-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--input-border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 5px 15px var(--shadow);
            display: none;
            margin-top: -2px;
        }

        .search-history-dropdown.show {
            display: block;
        }

        .search-history-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            border-left: 3px solid transparent;
            color: var(--text-primary);
            transition: background 0.2s, border-left 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .search-history-item:hover,
        .search-history-item:focus {
            background: var(--input-bg);
            border-left-color: #667eea;
        }

        .search-history-item:active {
            background: var(--input-bg);
            border-left-color: #764ba2;
            border-left-width: 4px;
        }

        .search-history-item:last-child {
            border-bottom: none;
        }

        .search-history-item .icon {
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .search-history-item:hover .icon,
        .search-history-item:focus .icon {
            opacity: 1;
        }

        .sort-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            position: relative;
            top: auto;
            left: auto;
            z-index: 10;
        }

        .sort-label {
            font-size: 12px;
            color: #1a1a2e;
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
        }

        body.dark-mode .sort-label {
            color: #f8f9fa;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .sort-select {
            padding: 8px 32px 8px 14px;
            border: 2px solid rgba(102, 126, 234, 0.4);
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #1a1a2e;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            min-height: 36px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        body.dark-mode .sort-select {
            border: 2px solid rgba(255, 255, 255, 0.35);
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.95) 0%, rgba(40, 40, 70, 0.95) 100%);
            color: #f8f9fa;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a5b4fc' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .sort-select:hover {
            border-color: rgba(102, 126, 234, 0.7);
            background: linear-gradient(135deg, #ffffff 0%, #eef1ff 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
            transform: translateY(-1px);
        }

        body.dark-mode .sort-select:hover {
            border-color: rgba(255, 255, 255, 0.55);
            background: linear-gradient(135deg, rgba(40, 40, 70, 0.98) 0%, rgba(50, 50, 90, 0.98) 100%);
            box-shadow: 0 5px 16px rgba(0,0,0,0.5);
        }

        .sort-select:focus {
            border-color: #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2), 0 4px 12px rgba(102, 126, 234, 0.25);
        }

        body.dark-mode .sort-select:focus {
            border-color: #a5b4fc;
            background: linear-gradient(135deg, rgba(40, 40, 70, 1) 0%, rgba(55, 55, 100, 1) 100%);
            box-shadow: 0 0 0 3px rgba(165, 180, 252, 0.25), 0 5px 16px rgba(0,0,0,0.5);
        }

        /* Select option stilleri */
        .sort-select option {
            padding: 10px 14px;
            background: #ffffff;
            color: #1a1a2e;
            font-weight: 500;
        }

        body.dark-mode .sort-select option {
            background: #2a2a4a;
            color: #f8f9fa;
        }

        @media (max-width: 768px) {
            .sort-container {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 10px;
            }
            
            .sort-select {
                padding: 6px 28px 6px 12px;
                font-size: 12px;
                min-height: 32px;
            }
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.15s ease;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .search-btn:active:not(:disabled) {
            transform: scale(0.97);
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.15s ease, background 0.3s, color 0.3s, border-color 0.3s;
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            flex-shrink: 0;
            position: relative;
        }

        body.dark-mode .filter-btn {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .filter-btn.active::after {
            content: ' ✓';
            font-weight: bold;
        }

        .filter-btn:active {
            transform: scale(0.97);
            box-shadow: 0 0 0 rgba(0,0,0,0);
        }

        /* Erişilebilirlik için görsel olarak gizli ama ekran okuyucu için görünür */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .popular-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.5);
            vertical-align: middle;
            white-space: nowrap;
            animation: pulse 2s ease-in-out infinite;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }

        .popular-book {
            border: 3px solid #ff6b6b !important;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4) !important;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 107, 107, 0.08) 100%) !important;
            position: relative;
        }

        .popular-book::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f, #ff6b6b);
            border-radius: 15px 15px 0 0;
        }

        .popular-book:hover {
            box-shadow: 0 10px 35px rgba(255, 107, 107, 0.5) !important;
            transform: translateY(-6px) !important;
            border-color: #ff5252 !important;
        }

        .book-title {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            line-height: 1.5;
        }

        .book-card {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            position: relative;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
        }

        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.18);
        }

        /* Favoriler için küçük kart görünümü */
        .book-card.favorite-small {
            padding: 12px;
            border-radius: 10px;
        }

        .book-card.favorite-small .book-cover {
            max-width: 80px;
            height: 110px;
            margin: 0 auto 8px;
        }

        .book-card.favorite-small .book-cover-placeholder {
            max-width: 80px;
            height: 110px;
            margin: 0 auto 8px;
            font-size: 24px;
        }

        .book-card.favorite-small .book-title {
            font-size: 1.1em;
            margin-bottom: 6px;
        }

        .book-card.favorite-small .book-author {
            font-size: 0.9em;
            margin-bottom: 6px;
        }

        .book-card.favorite-small .book-year {
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        .book-card.favorite-small .book-summary {
            font-size: 0.85em;
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .book-card.favorite-small .purchase-link {
            padding: 6px 8px;
            font-size: 11px;
        }

        .book-card.favorite-small .favorite-btn {
            width: 36px;
            height: 36px;
            top: 8px;
            right: 8px;
            font-size: 18px;
        }

        /* Koyu modda kompakt kart görünümü */
        body.dark-mode .book-card:not(.favorite-small) {
            padding: 18px;
            border-radius: 12px;
        }

        body.dark-mode .book-card:not(.favorite-small) .book-cover {
            max-width: 135px;
            height: 180px;
            margin: 0 auto 12px;
        }

        body.dark-mode .book-card:not(.favorite-small) .book-cover-placeholder {
            max-width: 135px;
            height: 180px;
            margin: 0 auto 12px;
            font-size: 38px;
        }

        body.dark-mode .book-card:not(.favorite-small) .book-title {
            font-size: 1.25em;
            margin-bottom: 8px;
        }

        body.dark-mode .book-card:not(.favorite-small) .book-author {
            font-size: 1em;
            margin-bottom: 8px;
        }

        body.dark-mode .book-card:not(.favorite-small) .book-year {
            font-size: 0.85em;
            margin-bottom: 12px;
        }

        body.dark-mode .book-card:not(.favorite-small) .book-summary {
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        body.dark-mode .book-card:not(.favorite-small) .purchase-link {
            padding: 10px;
            font-size: 13px;
        }

        .book-cover {
            width: 100%;
            max-width: 150px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin: 0 auto 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .book-cover-placeholder {
            width: 100%;
            max-width: 150px;
            height: 200px;
            border-radius: 8px;
            margin: 0 auto 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 42px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 2px;
            position: relative;
        }

        .book-cover-placeholder.show {
            display: flex;
        }

        .book-cover-placeholder::before {
            content: '📚';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            opacity: 0.3;
        }

        .book-info {
            flex: 1;
        }

        .book-title {
            font-size: 1.4em;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .book-author {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .book-year {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .book-summary {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: justify;
        }

        .purchase-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .purchase-link {
            flex: 1;
            padding: 12px;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
            font-size: 14px;
        }

        .purchase-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .dr-link {
            background: #e74c3c;
        }

        .bkm-link {
            background: #3498db;
        }

        .kitapyurdu-link {
            background: #2ecc71;
        }

        .hepsiburada-link {
            background: #ff6600;
        }

        .trendyol-link {
            background: #ff6000;
        }

        .amazon-link {
            background: #ff9900;
        }

        .favorite-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 2px solid rgba(0, 0, 0, 0.08);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #888;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            z-index: 10;
        }

        .favorite-btn:hover {
            transform: scale(1.15);
            background: linear-gradient(145deg, #ffffff, #e8e8e8);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .favorite-btn:active {
            transform: scale(0.95);
        }

        .favorite-btn.active {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            border-color: #d63031;
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .favorite-btn.active:hover {
            background: linear-gradient(145deg, #ff5252, #e53935);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
        }

        /* Dark mode için favori butonu */
        body.dark-mode .favorite-btn {
            background: linear-gradient(145deg, #3d3d3d, #2d2d2d);
            border-color: rgba(255, 255, 255, 0.1);
            color: #aaa;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .favorite-btn:hover {
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            color: #ffd700;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .favorite-btn.active {
            background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
            border-color: #ff6b6b;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        body.dark-mode .favorite-btn.active:hover {
            background: linear-gradient(145deg, #ff5252, #e53935);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
        }

        /* Sistem dark mode tercihine göre */
        @media (prefers-color-scheme: dark) {
            body:not(.light-mode):not(.dark-mode) .favorite-btn {
                background: linear-gradient(145deg, #3d3d3d, #2d2d2d);
                border-color: rgba(255, 255, 255, 0.1);
                color: #aaa;
                box-shadow: 0 3px 12px rgba(0, 0, 0, 0.3);
            }

            body:not(.light-mode):not(.dark-mode) .favorite-btn:hover {
                background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
                color: #ffd700;
            }

            body:not(.light-mode):not(.dark-mode) .favorite-btn.active {
                background: linear-gradient(145deg, #ff6b6b, #ee5a5a);
                color: white;
            }
        }

        /* Fiyat Karşılaştırma Stilleri */
        .price-compare-btn {
            background: #1db954;
            color: #fff;
            padding: 7px 12px;
            border-radius: 6px;
            margin-top: 6px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .price-compare-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3);
            background: #1ed760;
        }

        .go-buy-btn {
            background: #ff6b35;
            color: #fff;
            padding: 6px 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .go-buy-btn:hover {
            background: #ff8659;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }

        /* Fiyat yükleme animasyonları */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .price-loading-container {
            text-align: center;
            padding: 30px 20px;
        }

        .price-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(29, 185, 84, 0.2);
            border-top-color: #1db954;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .price-loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            animation: pulse 2s ease-in-out infinite;
        }

        .price-loading-stores {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
        }

        .price-loading-store {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(29, 185, 84, 0.1);
            border-radius: 6px;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        }

        .price-loading-store.active {
            background: rgba(29, 185, 84, 0.2);
        }

        .price-loading-store .store-name {
            font-weight: 500;
        }

        .price-loading-store .store-status {
            font-size: 12px;
            color: #1db954;
        }

        .price-loading-store .store-status::after {
            content: '...';
            animation: pulse 1.5s ease-in-out infinite;
        }

        .price-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, .6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .price-content {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 300px;
            animation: pop .25s ease;
            color: var(--text-primary);
        }

        @keyframes pop {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .price-row:last-of-type {
            border-bottom: none;
        }

        .go-buy-btn {
            background: #ff6b35;
            color: #fff;
            padding: 6px 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.2s;
            white-space: nowrap;
            margin-left: 10px;
        }

        .go-buy-btn:hover {
            background: #ff8659;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }

        .price-row span {
            flex: 1;
        }

        .price-row strong {
            flex: 1;
            text-align: center;
            color: var(--text-primary);
        }

        .price-row a {
            background: #1db954;
            color: #fff;
            padding: 4px 7px;
            border-radius: 4px;
            text-decoration: none;
            margin-left: 10px;
            font-size: 12px;
        }

        .price-row a:hover {
            background: #1ed760;
        }

        .price-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-primary);
        }

        .close-modal {
            margin-top: 15px;
            width: 100%;
            background: #444;
            color: #fff;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .close-modal:hover {
            background: #555;
        }

        .no-results {
            text-align: center;
            color: var(--text-white);
            font-size: 1.2em;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }

        .loading {
            text-align: center;
            color: var(--text-white);
            font-size: 1.2em;
            padding: 40px;
        }

        .favorites-view {
            display: none;
        }

        .favorites-view.active {
            display: block;
        }

        .search-view.active {
            display: block;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
        }

        .view-header h2 {
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .back-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .empty-favorites {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }

        .favorites-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .favorites-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
        }

        .favorites-modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 1400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            position: relative;
            transition: background 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 2em;
            margin: 0;
        }

        .close-modal-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .close-modal-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .price-comparison-section {
            margin-top: 20px;
            padding: 20px;
            background: var(--input-bg);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .price-comparison-title {
            font-size: 1.3em;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .price-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .price-input-group {
            display: flex;
            flex-direction: column;
        }

        .price-input-group label {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .price-input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
        }

        .price-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .price-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .price-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .price-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .price-table tr:hover {
            background: #f8f9fa;
        }

        .price-value {
            font-weight: bold;
            color: #2ecc71;
            font-size: 1.1em;
        }

        .price-value.empty {
            color: #999;
            font-weight: normal;
        }

        .best-price {
            background: #d4edda !important;
            font-weight: bold;
        }

        .save-prices-btn {
            padding: 10px 20px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .save-prices-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .compare-all-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .compare-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .fetch-prices-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .fetch-prices-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .fetch-prices-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .price-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .price-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .price-status.success {
            color: #2ecc71;
        }

        .price-status.error {
            color: #e74c3c;
        }


        .single-book-price-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1001;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .single-book-price-modal.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .single-book-price-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 20px 60px var(--shadow);
            position: relative;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .search-box {
                flex-direction: column;
            }

            .results-container {
                grid-template-columns: 1fr;
            }

            .header-actions {
                position: static;
                justify-content: center;
                margin-top: 0;
            }

            .view-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .filter-buttons {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 5px;
            }

            .filter-buttons::-webkit-scrollbar {
                display: none;
            }

            .filter-btn {
                min-width: fit-content;
                font-size: 13px;
                padding: 8px 16px;
            }
        }



        /* Gizlilik açıklaması stilleri */
        .privacy-notice {
            margin-top: 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            color: rgba(255, 255, 255, 0.95);
            font-size: 13px;
            line-height: 1.6;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            transition: background 0.3s ease, color 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .privacy-notice strong {
            color: rgba(255, 255, 255, 1);
            font-weight: 600;
        }

        .privacy-notice-icon {
            font-size: 18px;
            margin-bottom: 10px;
            display: block;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        @media (max-width: 768px) {
            .privacy-notice {
                font-size: 12px;
                padding: 15px;
                margin-top: 0;
            }
        }

        /* AdMob Reklam Stilleri */
        #native-ad-card {
            grid-column: 1 / -1;
            width: 100%;
            max-width: 100%;
            display: flex;
            align-items: center;
            gap: 24px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.9);
            color: #0f172a;
            padding: 24px;
        }

        body.dark-mode #native-ad-card {
            background: rgba(15, 23, 42, 0.85);
            border-color: rgba(148, 163, 184, 0.3);
            color: #e2e8f0;
        }

        #native-ad-card .book-cover,
        #native-ad-card .book-cover-placeholder {
            flex: 0 0 180px;
            max-width: 180px;
            height: 240px;
            margin: 0;
        }

        #native-ad-card .book-info {
            flex: 1 1 320px;
            text-align: left;
        }

        #native-ad-card .purchase-links {
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        #native-ad-card .purchase-link {
            flex: 0 0 auto;
        }

        .ad-label {
            font-size: 11px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(15, 23, 42, 0.65);
            text-align: right;
        }

        body.dark-mode .ad-label {
            color: rgba(226, 232, 240, 0.65);
        }

        /* Empty ad slots should collapse gracefully */
        /* Empty ad containers should collapse gracefully */
        .ad-slot,
        #native-ad-card:empty,
        #ad-placeholder:empty {
            min-height: 0 !important;
            height: auto !important;
        }
        
        /* Ensure ad containers can collapse when empty */
        [id*="ad-container"] {
            min-height: 0 !important;
            height: auto !important;
        }


        /* Ad placeholder styles */
        #ad-placeholder {
            width: 100%;
            min-height: 120px;
            height: auto;
            background: #f5f5f5;
            margin: 20px auto;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.dark-mode #ad-placeholder {
            background: #2d2d2d;
        }

        @media (max-width: 768px) {
            #native-ad-card {
                flex-direction: column;
                padding: 18px;
                gap: 16px;
                text-align: center;
            }

            #native-ad-card .book-info {
                text-align: center;
            }

            #native-ad-card .purchase-links {
                justify-content: center;
            }
        }

        /* ===== NEON SPLASH SCREEN (Optimized) ===== */
        #splash-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            background: linear-gradient(135deg, #0a0f1a 0%, #000000 100%);
            transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            will-change: opacity;
        }

        .splash-visible {
            opacity: 1;
        }

        .splash-hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Splash tamamen gizlendiğinde */
        .splash-removed {
            display: none !important;
        }

        /* Basitleştirilmiş parçacıklar - sadece 5 adet */
        .splash-particles {
            position: absolute;
            inset: 0;
            overflow: hidden;
            will-change: transform;
        }

        .splash-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #39ff14;
            border-radius: 50%;
            opacity: 0.4;
            animation: float-particle 5s ease-in-out infinite;
            will-change: transform, opacity;
        }

        .splash-particle:nth-child(1) { left: 15%; top: 25%; animation-delay: 0s; }
        .splash-particle:nth-child(2) { left: 75%; top: 20%; animation-delay: 1s; }
        .splash-particle:nth-child(3) { left: 25%; top: 70%; animation-delay: 2s; }
        .splash-particle:nth-child(4) { left: 80%; top: 65%; animation-delay: 1.5s; }
        .splash-particle:nth-child(5) { left: 50%; top: 85%; animation-delay: 0.5s; }

        @keyframes float-particle {
            0%, 100% { transform: translateY(0); opacity: 0.3; }
            50% { transform: translateY(-20px); opacity: 0.7; }
        }

        /* Logo container - basitleştirilmiş animasyon */
        .splash-logo-container {
            position: relative;
            animation: logo-entrance 0.8s ease-out forwards;
            opacity: 0;
            transform: scale(0.8);
            will-change: transform, opacity;
        }

        @keyframes logo-entrance {
            to { opacity: 1; transform: scale(1); }
        }

        /* Neon SVG Logo - optimize edilmiş glow */
        .splash-neon-logo {
            width: 160px;
            height: 160px;
            filter: drop-shadow(0 0 15px #39ff14) drop-shadow(0 0 30px rgba(57, 255, 20, 0.4));
            animation: neon-pulse 3s ease-in-out infinite;
            will-change: filter;
        }

        .splash-neon-logo path,
        .splash-neon-logo circle,
        .splash-neon-logo line {
            stroke: #39ff14;
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        @keyframes neon-pulse {
            0%, 100% { filter: drop-shadow(0 0 15px #39ff14) drop-shadow(0 0 30px rgba(57, 255, 20, 0.4)); }
            50% { filter: drop-shadow(0 0 25px #39ff14) drop-shadow(0 0 50px rgba(57, 255, 20, 0.6)); }
        }

        /* Çizim animasyonu - daha hızlı */
        .splash-neon-logo .book-outline {
            stroke-dasharray: 800;
            stroke-dashoffset: 800;
            animation: draw-logo 1.2s ease-out forwards 0.2s;
        }

        .splash-neon-logo .magnifier {
            stroke-dasharray: 400;
            stroke-dashoffset: 400;
            animation: draw-logo 0.8s ease-out forwards 0.6s;
        }

        @keyframes draw-logo {
            to { stroke-dashoffset: 0; }
        }

        /* Uygulama adı - basitleştirilmiş */
        .splash-title {
            margin-top: 25px;
            font-size: 2.4em;
            font-weight: 700;
            letter-spacing: 3px;
            color: #39ff14;
            text-shadow: 0 0 20px rgba(57, 255, 20, 0.8), 0 0 40px rgba(57, 255, 20, 0.4);
            animation: fade-in-up 0.6s ease-out forwards 0.4s;
            opacity: 0;
            will-change: transform, opacity;
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Alt yazı */
        .splash-subtitle {
            margin-top: 8px;
            font-size: 1em;
            color: rgba(57, 255, 20, 0.6);
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: fade-in 0.6s ease-out forwards 0.6s;
            opacity: 0;
        }

        @keyframes fade-in {
            to { opacity: 1; }
        }

        /* Yükleme çubuğu */
        .splash-loader-container {
            margin-top: 40px;
            width: 180px;
            height: 3px;
            background: rgba(57, 255, 20, 0.15);
            border-radius: 3px;
            overflow: hidden;
            animation: fade-in 0.4s ease-out forwards 0.8s;
            opacity: 0;
        }

        .splash-loader-bar {
            height: 100%;
            background: #39ff14;
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.6);
            animation: loader-progress 1.8s ease-out forwards 1s;
            width: 0%;
            will-change: width;
        }

        @keyframes loader-progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* Yükleniyor yazısı */
        .splash-loading-text {
            margin-top: 12px;
            font-size: 0.8em;
            color: rgba(57, 255, 20, 0.5);
            letter-spacing: 1px;
            animation: fade-in 0.4s ease-out forwards 0.8s;
            opacity: 0;
        }

        /* Halka efekti - sadece 1 tane, daha hafif */
        .splash-ring {
            position: absolute;
            width: 250px;
            height: 250px;
            border: 1px solid rgba(57, 255, 20, 0.08);
            border-radius: 50%;
            animation: ring-expand 4s ease-out infinite;
            will-change: transform, opacity;
        }

        .splash-ring:nth-child(2) { animation-delay: 1.3s; }
        .splash-ring:nth-child(3) { display: none; }

        @keyframes ring-expand {
            0% { transform: scale(0.6); opacity: 0.5; }
            100% { transform: scale(1.8); opacity: 0; }
        }
            </style>
        </head>
        <body>
            <div id="userTitleBox" class="user-title-box">
                Ünvan: <span id="activeTitle">—</span>
            </div>
            <!-- Splash Screen -->
    <script>
        // Mobilde hemen çalışacak inline script - splash screen'i kapat
        // Bu script body'nin başında çalışır, ana script'ten bağımsızdır
        (function() {
            function hideSplash() {
                try {
                    var splash = document.getElementById('splash-screen');
                    if (splash && !splash.classList.contains('splash-hidden')) {
                        // Önce fade-out başlat
                        splash.classList.remove('splash-visible');
                        splash.classList.add('splash-hidden');
                        
                        // Fade-out animasyonu bittikten sonra tamamen kaldır
                        setTimeout(function() {
                            if (splash) {
                                splash.classList.add('splash-removed');
                            }
                        }, 1200); // CSS transition süresi kadar bekle
                    }
                } catch(e) {
                    // Hata durumunda direkt gizle
                    try {
                        var splash = document.getElementById('splash-screen');
                        if (splash) {
                            splash.style.display = 'none';
                        }
                    } catch(e2) {}
                }
            }

            // Optimize edilmiş zamanlama - 2.8 saniye
            var SPLASH_DURATION = 2800;
            
            // DOM hazır olduğunda başlat
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                setTimeout(hideSplash, SPLASH_DURATION);
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(hideSplash, SPLASH_DURATION);
                }, false);
            }
            
            // Güvenlik: 4 saniye sonra kesinlikle kapat
            setTimeout(hideSplash, 4000);
        })();
        </script>
        <div id="splash-screen" class="splash-visible">
            <!-- Halka efektleri -->
            <div class="splash-ring"></div>
            <div class="splash-ring"></div>
            
            <!-- Arka plan parçacıkları (azaltılmış) -->
            <div class="splash-particles">
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
                <div class="splash-particle"></div>
            </div>
            
            <!-- Logo -->
            <div class="splash-logo-container">
                <svg class="splash-neon-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Kitap ana gövdesi -->
                    <path class="book-outline" d="M15 20 L15 75 Q15 80 20 80 L65 80 Q70 80 70 75 L70 25 Q70 20 65 20 L20 20 Q15 20 15 25" />
                    <!-- Kitap orta çizgisi (cilt) -->
                    <path class="book-outline" d="M42 20 L42 80" />
                    <!-- Kitap sayfaları sol -->
                    <line class="book-outline" x1="22" y1="32" x2="38" y2="32" />
                    <line class="book-outline" x1="22" y1="42" x2="38" y2="42" />
                    <line class="book-outline" x1="22" y1="52" x2="38" y2="52" />
                    <line class="book-outline" x1="22" y1="62" x2="35" y2="62" />
                    <!-- Kitap arka sayfalar efekti -->
                    <path class="book-outline" d="M18 22 L18 77" />
                    <path class="book-outline" d="M21 24 L21 76" />
                    <!-- Büyüteç -->
                    <circle class="magnifier" cx="62" cy="52" r="18" />
                    <line class="magnifier" x1="75" y1="65" x2="88" y2="82" style="stroke-width: 5;" />
                    <!-- Büyüteç içi parlaklık -->
                    <path class="magnifier" d="M52 45 Q56 40 62 42" style="stroke-width: 2; opacity: 0.6;" />
                </svg>
            </div>
            
            <!-- Uygulama adı -->
            <div class="splash-title">KitapMatik</div>
            <div class="splash-subtitle">Ara • Bul • Al</div>
            
            <!-- Yükleme çubuğu -->
            <div class="splash-loader-container">
                <div class="splash-loader-bar"></div>
            </div>
            <div class="splash-loading-text">Yükleniyor...</div>
        </div>
                    <div class="container">
                        <div class="header">
                            <div class="header-actions">
                                <button class="theme-toggle-btn" onclick="toggleTheme()" aria-label="Tema değiştir" title="Koyu/Açık tema değiştir">
                                    <span class="icon" id="themeIcon">🌙</span>
                                        <span id="themeText">Koyu Mod</span>
                                        </button>
                                        <button class="favorites-btn" onclick="showFavorites()">
                                            ⭐ Favorilerim <span class="badge" id="favoritesCount">0</span>
                                        </button>
                                    </div>
                                            <div id="badgeButton" class="badge-button" onclick="openBadges()">
                                                🏅 Rozetler
                                                <span id="badgeNotif" class="badge-notif"></span>
                                            </div>
                                            <div id="quoteBox" class="quote-box" aria-label="Günün sözü" style="position:relative; overflow:hidden; background:linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:18px; padding:22px 28px 18px; box-shadow:0 15px 35px rgba(0,0,0,0.2); margin-bottom:18px; backdrop-filter:blur(6px);">
                                                <span aria-hidden="true" style="position:absolute; inset:0; background:radial-gradient(circle at top left, rgba(255,255,255,0.35), transparent 55%); opacity:0.7;"></span>
                                                    <span aria-hidden="true" style="position:absolute; inset:10px; border:1px dashed rgba(255,255,255,0.25); border-radius:14px; pointer-events:none;"></span>
                                                        <div style="position:relative; z-index:1;">
                                                            <div class="quote-text" id="quoteText" style="font-size:1.15rem; line-height:1.6; font-weight:600; letter-spacing:0.4px;">Okumak, ruhun gıdasıdır.</div>
                                                                <div class="quote-author" id="quoteAuthor" style="margin-top:8px; font-size:0.95rem; letter-spacing:1px; text-transform:uppercase; font-weight:600; color:var(--quote-author-color, #1f2a37); text-shadow:0 3px 8px rgba(0,0,0,0.35); transition:color 0.3s ease;">Cicero</div>
                                                                </div>
                                                            </div>
                                                        </div>


                                                        <!-- Arama Görünümü -->
                                                        <div id="searchView" class="search-view active">
                                                            <div class="search-container">
                                                                <div class="sort-container">
                                                                    <label for="sortSelect" class="sort-label">📊 Sıralama:</label>
                                                                        <select id="sortSelect" class="sort-select" aria-label="Sıralama seçeneği">
                                                                            <option value="relevance">🎯 İlgililik</option>
                                                                            <option value="newest">🆕 En Yeni</option>
                                                                            <option value="popular">🔥 Popüler</option>
                                                                        </select>
                                                                                <button class="filter-btn" id="trend-raft-btn" onclick="openTrendSection()" aria-pressed="false" aria-label="Trend Rafı" style="padding: 6px 12px; font-size: 12px; height: 28px; line-height: 1;">🔥 Trend Rafı</button>
                                                                                <button class="filter-btn" onclick="openBlog()" aria-label="Blog" style="padding: 6px 12px; font-size: 12px; height: 28px; line-height: 1;">📚 Blog</button>
                                                                                </div>
                                                                                <div class="search-box">
                                                                                    <div class="search-input-wrapper">
                                                                                        <label for="searchInput" class="visually-hidden">Arama</label>
                                                                                            <input type="text" id="searchInput" class="search-input" placeholder="Adı, yazar, yayınevi veya test kitabı arayın..." aria-label="Arama kutusu" maxlength="100" autocomplete="off">
                                                                                            <div id="searchHistoryDropdown" class="search-history-dropdown" role="listbox" aria-label="Arama geçmişi"></div>
                                                                                            </div>
                                                                                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                                                                                <button id="searchBtn" onclick="searchBooks()" class="search-btn" aria-label="Ara">Ara</button>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div class="filter-buttons" role="group" aria-label="Arama filtreleri">
                                                                                                    <button class="filter-btn active" onclick="setFilter('all', this)" aria-pressed="true" aria-label="Tümü filtresi (seçili)">Tümü</button>
                                                                                                        <button class="filter-btn" onclick="setFilter('book', this)" aria-pressed="false" aria-label="Adı filtresi">Adı</button>
                                                                                                            <button class="filter-btn" onclick="setFilter('author', this)" aria-pressed="false" aria-label="Yazar filtresi">Yazar</button>
                                                                                                                <button class="filter-btn" onclick="setFilter('publisher', this)" aria-pressed="false" aria-label="Yayınevi filtresi">Yayınevi</button>
                                                                                                                    <button class="filter-btn" onclick="setFilter('test', this)" aria-pressed="false" aria-label="Test Kitabı filtresi">Test Kitabı</button>
                                                                                                                    </div>
                                                                                                                </div>

                                                                                                                <!-- AdSense Banner - Arama Alanı Altı -->
                                                                                                                <div class="ad-container ad-banner-top" data-ad-slot="banner-top">
                                                                                                                    <ins class="adsbygoogle"
                                                                                                                         style="display:block"
                                                                                                                         data-ad-client="ca-pub-xxxxxxxxxx"
                                                                                                                         data-ad-slot="YYYYYYYY"
                                                                                                                         data-ad-format="auto"
                                                                                                                         data-full-width-responsive="true"></ins>
                                                                                                                </div>

                                                                                                                <!-- Sonuç Bölümleri -->
                                                                                                                <div id="results-normal" class="results-container" role="list" aria-label="Arama sonuçları" style="display: none;"></div>
                                                                                                                        <div id="results-trend" class="results-container" role="list" aria-label="Trend kitaplar" style="display: none;"></div>

                                                                                                                        <!-- Ad Placeholder -->
                                                                                                                        <div id="ad-placeholder"></div>



                                                                                                                        </div>

                                                                                                                        <!-- Favoriler Görünümü -->
                                                                                                                        <div id="favoritesView" class="favorites-view">
                                                                                                                            <div class="view-header">
                                                                                                                                <h2>⭐ Favorilerim</h2>
                                                                                                                                    <button class="back-btn" onclick="showSearch()">← Arama Sayfasına Dön</button>
                                                                                                                                    </div>
                                                                                                                                    <div id="favoritesContainer" class="results-container" role="list" aria-label="Favori kitaplar"></div>
                                                                                                                                    </div>

                                                                                                                                    <!-- Favoriler Modal -->
                                                                                                                                    <div id="favoritesModal" class="favorites-modal">
                                                                                                                                        <div class="favorites-modal-content">
                                                                                                                                            <div class="modal-header">
                                                                                                                                                <h2>⭐ Favorilerim</h2>
                                                                                                                                                    <button class="close-modal-btn" onclick="closeFavoritesModal()">✕ Kapat</button>
                                                                                                                                                    </div>
                                                                                                                                                    <div id="favoritesModalContainer" class="results-container"></div>
                                                                                                                                                    </div>
                                                                                                                                                </div>

                                                                                                                                                <!-- Tekil Kitap Fiyat Karşılaştırma Modal -->
                                                                                                                                                <div id="singleBookPriceModal" class="single-book-price-modal">
                                                                                                                                                    <div class="single-book-price-content">
                                                                                                                                                        <div class="modal-header">
                                                                                                                                                            <h2>💰 Fiyat Karşılaştırma</h2>
                                                                                                                                                                <button class="close-modal-btn" onclick="closeSingleBookPriceModal()">✕ Kapat</button>
                                                                                                                                                                </div>
                                                                                                                                                                <!-- AdSense Modal Ad -->
                                                                                                                                                                <div class="ad-container ad-modal-top" data-ad-slot="modal-ad-top">
                                                                                                                                                                    <ins class="adsbygoogle"
                                                                                                                                                                         style="display:block"
                                                                                                                                                                         data-ad-client="ca-pub-xxxxxxxxxx"
                                                                                                                                                                         data-ad-slot="YYYYYYYY"
                                                                                                                                                                         data-ad-format="auto"
                                                                                                                                                                         data-full-width-responsive="true"></ins>
                                                                                                                                                                </div>
                                                                                                                                                                <!-- Sponsor Box -->
                                                                                                                                                                <div class="sponsor-box">
                                                                                                                                                                    🔥 <b>Uygun fiyat önerisi:</b><br>
                                                                                                                                                                    <a href="https://google.com" target="_blank">📦 Kitap indirimlerini karşılaştır →</a>
                                                                                                                                                                </div>
                                                                                                                                                                <div id="singleBookPriceContent"></div>
                                                                                                                                                                </div>
                                                                                                                                                            </div>



                                                                                                                                                            <!-- Badges Modal -->
                                                                                                                                                            <div id="badgesModal" class="badges-modal" style="display:none;">
                                                                                                                                                                <div class="modal-content">
                                                                                                                                                                    <h2>Rozetlerim</h2>
                                                                                                                                                                    <div id="badgeGrid" class="badge-grid"></div>
                                                                                                                                                                    <button class="close-btn" onclick="closeBadges()">Kapat</button>
                                                                                                                                                                </div>
                                                                                                                                                            </div>

                                                                                                                                                            <!-- Gizlilik Açıklaması -->
                                                                                                                                                            <div class="privacy-notice" role="contentinfo" aria-label="Gizlilik açıklaması">
                                                                                                                                                                <span class="privacy-notice-icon">🔒</span>
                                                                                                                                                                    <strong>Gizlilik ve Veri Güvenliği:</strong> Uygulama kullanıcı verilerini sunuculara göndermez. Favoriler, tema seçimi ve arama geçmişi yalnızca cihazda yerel olarak saklanır.
                                                                                                                                                                    </div>
                                                                                                                                                                </div>



    <script>
        // Popüler sözler listesi
        const POPULAR_QUOTES = [
            // Atatürk sözleri (ağırlıklı)
            { text: "Eğitimdir ki, bir milleti ya hür, bağımsız, şanlı, yüksek bir toplum halinde yaşatır ya da esaret ve sefalete terk eder.", author: "Mustafa Kemal Atatürk", weight: 3 },
            { text: "Hayatta en hakiki mürşit ilimdir, fendir.", author: "Mustafa Kemal Atatürk", weight: 3 },
            { text: "Okumak demek, bence, insanın kendi kendisiyle konuşması demektir.", author: "Mustafa Kemal Atatürk", weight: 3 },
            { text: "Bir millet irfan ordusuna sahip olmadıkça savaş meydanlarında ne kadar parlak zaferler elde ederse etsin, o zaferlerin kalıcı sonuçlar vermesi mümkün değildir.", author: "Mustafa Kemal Atatürk", weight: 3 },
            { text: "Uyuyan milletler ya ölür, ya da köle olarak uyanırlar.", author: "Mustafa Kemal Atatürk", weight: 3 },
            
            // Türk yazarlar
            { text: "İnsan okumalı, ama yaşamak için okumalı.", author: "Sabahattin Ali" },
            { text: "Kitap, insanın içine açılan penceredir.", author: "Yaşar Kemal" },
            { text: "Her kitap, binlerce yılın birikimidir.", author: "Cemil Meriç" },
            { text: "Okumak, düşünmenin ta kendisidir.", author: "Ahmet Hamdi Tanpınar" },
            { text: "Bir kitap bazen bir ömre bedeldir.", author: "Oğuz Atay" },
            { text: "Kelimeler, insanı insan yapan tek şeydir.", author: "Nazım Hikmet" },
            { text: "İnsan ancak sevdiği şeyi iyi anlar.", author: "Orhan Pamuk" },
            { text: "Edebiyat, insanın kendini arama yolculuğudur.", author: "Ahmet Ümit" },
            { text: "Her şiir, ruhun bir parçasıdır.", author: "Cemal Süreya" },
            { text: "Söz, insanın aynasıdır.", author: "Attila İlhan" },
            { text: "Okumak, başka hayatları yaşamaktır.", author: "Zülfü Livaneli" },
            
            // Klasik dünya yazarları
            { text: "Okumak, ruhun gıdasıdır.", author: "Cicero" },
            { text: "Kitaplar, uygarlığın gemisidir.", author: "Carl Sagan" },
            { text: "Bir kitap okumak, yazarın beyniyle düşünmektir.", author: "Arthur Schopenhauer" },
            { text: "Kitaplar olmasaydı, dünya karanlıkta kalırdı.", author: "Thomas Carlyle" },
            { text: "Bazı kitaplar tadılmalı, bazıları yutulmalı, çok azı ise çiğnenip sindirilmelidir.", author: "Francis Bacon" },
            { text: "Kitaplar, sessiz öğretmenlerdir.", author: "Aulus Gellius" },
            { text: "Gerçek cennet, kaybettiğimiz cennet değil, okuduğumuz kitaplardır.", author: "Marcel Proust" },
            { text: "Kitaplar, insanlığın hafızasıdır.", author: "Isaac Asimov" },
            { text: "Okumayan insan, sadece bir hayat yaşar. Okuyan ise binlerce hayat yaşar.", author: "George R.R. Martin" },
            { text: "Bir oda kitapsızsa, ruhsuz bir beden gibidir.", author: "Cicero" },
            { text: "Kitaplar gemilerin taşıyamadığı yükleri taşır.", author: "Emily Dickinson" },
            
            // Modern dünya yazarları
            { text: "Bir kitap, sonsuz bir yolculuktur.", author: "Jorge Luis Borges" },
            { text: "Kitaplar, hayal gücünün kapılarını açar.", author: "J.K. Rowling" },
            { text: "Bir kitap, bir hayattır.", author: "Maya Angelou" },
            { text: "Kitaplar, düşüncelerin evidir.", author: "Mark Twain" },
            { text: "Okuyan bir insan, iki hayat yaşar.", author: "Umberto Eco" },
            { text: "Her kitap, yeni bir yolculuktur.", author: "Paulo Coelho" },
            { text: "Kitaplar, en sadık arkadaşlardır.", author: "Ernest Hemingway" },
            { text: "Bir roman, hayatın yoğunlaştırılmış halidir.", author: "Milan Kundera" },
            { text: "İyi edebiyat, insanlığın aynasıdır.", author: "Virginia Woolf" },
            { text: "Kitaplar, ölümsüzlüğün kanıtıdır.", author: "Carl Sagan" },
            
            // Filozoflar
            { text: "Okumak, bilginin anahtarıdır.", author: "Konfüçyüs" },
            { text: "Kitaplar, hayatın rehberidir.", author: "Seneca" },
            { text: "Kitaplar, bilgeliğin kaynağıdır.", author: "Platon" },
            { text: "Okumak, bilgeliğin başlangıcıdır.", author: "Sokrates" },
            { text: "Okumak, zihni özgürleştirir.", author: "Ralph Waldo Emerson" },
            { text: "Bilgi güçtür.", author: "Francis Bacon" },
            
            // Şairler
            { text: "Okumak, ruhu yükseltir.", author: "Victor Hugo" },
            { text: "Dün akıllıydım, dünyayı değiştirmek istedim. Bugün bilgeyim, kendimi değiştiriyorum.", author: "Mevlana" },
            { text: "Şiir, kelimelerin müziğidir.", author: "Pablo Neruda" },
            { text: "Bir kitap, sessiz bir devrimdir.", author: "Fyodor Dostoyevski" },
            { text: "Edebiyat, insanlığın vicdanıdır.", author: "Lev Tolstoy" },
            
            // İlham verici
            { text: "Bugün okuduğun bir satır, yarın hayatını değiştirebilir.", author: "Anonim" },
            { text: "Her okunan sayfa, zihnine eklenen bir tuğladır.", author: "Anonim" },
            { text: "En güzel yolculuklar, sayfalarda yapılır.", author: "Anonim" },
            { text: "Kitaplar ölmez, sadece yeni okuyucularını bekler.", author: "Anonim" },
            { text: "Okumak, kendi sesini başka seslerde bulmaktır.", author: "Anonim" }
        ];

        // Günlük söz sistemi - Her gün aynı söz gösterilir
        function getDailyQuote() {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const storedData = localStorage.getItem('dailyQuote_v1');
            
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    // Eğer bugünün sözü zaten varsa, onu göster
                    if (data.date === today && data.quote) {
                        return data.quote;
                    }
                } catch (e) {
                    console.error('Günlük söz verisi okunamadı:', e);
                }
            }
            
            // Yeni gün için söz seç
            // Tarihe göre deterministik index hesapla (her gün farklı ama tutarlı)
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const year = new Date().getFullYear();
            const seed = (dayOfYear * 31 + year) % POPULAR_QUOTES.length;
            
            // Ağırlıklı seçim için index'i ayarla
            let selectedQuote = POPULAR_QUOTES[seed];
            
            // Atatürk sözleri ağırlıklı olsun (her 3 günde 1 Atatürk sözü)
            if (dayOfYear % 3 === 0) {
                const ataturkQuotes = POPULAR_QUOTES.filter(q => q.author === "Mustafa Kemal Atatürk");
                if (ataturkQuotes.length > 0) {
                    selectedQuote = ataturkQuotes[dayOfYear % ataturkQuotes.length];
                }
            }
            
            // Günün sözünü kaydet
            localStorage.setItem('dailyQuote_v1', JSON.stringify({
                date: today,
                quote: selectedQuote
            }));
            
            return selectedQuote;
        }

        // Günlük sözü göster
        function showDailyQuote() {
            const quote = getDailyQuote();
            if (quote) {
                document.getElementById('quoteText').textContent = quote.text;
                document.getElementById('quoteAuthor').textContent = quote.author;
            }
        }

        // Sayfa yüklendiğinde günlük sözü göster
        document.addEventListener('DOMContentLoaded', function() {
            showDailyQuote();
        });

        let currentFilter = 'all';
        let isSearching = false; // Çift tıklama koruması için flag
        const API_BASE_URL = 'https://www.googleapis.com/books/v1/volumes';
        const OPEN_LIBRARY_API_URL = 'https://openlibrary.org/search.json';

        // API kodları kaldırıldı

        // Popüler kitaplar listesi (mağazalarda çok satanlar)
        const POPULAR_BOOKS = [
            // Adam Fawer
            { title: 'Empati', author: 'Adam Fawer', isbn: '9786254258992' },
            { title: 'Empati', author: 'Fawer', isbn: '9786254258992' },
            { title: 'Empati', author: 'Adam', isbn: '9786254258992' },
            { title: 'Kontr', author: 'Adam Fawer' },
            { title: 'Kaos', author: 'Adam Fawer' },
            { title: 'Obsesif', author: 'Adam Fawer' },
            // Şebnem İşigüzel
            { title: 'Hanım Hanımcık', author: 'Şebnem İşigüzel' },
            { title: 'Civan', author: 'Şebnem İşigüzel' },
            // Ahmet Ümit
            { title: 'İstanbul Hatırası', author: 'Ahmet Ümit' },
            { title: 'Bab-ı Esrar', author: 'Ahmet Ümit' },
            { title: 'Sis ve Gece', author: 'Ahmet Ümit' },
            // Elif Şafak
            { title: 'Aşk', author: 'Elif Şafak' },
            { title: 'Kırk Kural', author: 'Elif Şafak' },
            { title: 'Ustam ve Ben', author: 'Elif Şafak' },
            // Orhan Pamuk
            { title: 'Kırmızı Saçlı Kadın', author: 'Orhan Pamuk' },
            { title: 'Kafamda Bir Tuhaflık', author: 'Orhan Pamuk' },
            { title: 'Kar', author: 'Orhan Pamuk' },
            // İhsan Oktay Anar
            { title: 'Puslu Kıtalar Atlası', author: 'İhsan Oktay Anar' },
            { title: 'Efrâsiyab\'ın Hikayeleri', author: 'İhsan Oktay Anar' },
            // Zülfü Livaneli
            { title: 'Serenad', author: 'Zülfü Livaneli' },
            { title: 'Mutluluk', author: 'Zülfü Livaneli' },
            // Kürşat Başar
            { title: 'Benim Adım Kırmızı', author: 'Orhan Pamuk' },
            // Tuna Kiremitçi
            { title: 'Gizli Ajanda', author: 'Tuna Kiremitçi' },
            // Hakan Günday
            { title: 'Zargana', author: 'Hakan Günday' },
            { title: 'Daha', author: 'Hakan Günday' },
            // Oğuz Atay
            { title: 'Tutunamayanlar', author: 'Oğuz Atay' },
            { title: 'Tehlikeli Oyunlar', author: 'Oğuz Atay' },
            // Yaşar Kemal
            { title: 'İnce Memed', author: 'Yaşar Kemal' },
            { title: 'Teneke', author: 'Yaşar Kemal' },
            // Sabahattin Ali
            { title: 'Kürk Mantolu Madonna', author: 'Sabahattin Ali' },
            { title: 'İçimizdeki Şeytan', author: 'Sabahattin Ali' },
            // Reşat Nuri Güntekin
            { title: 'Çalıkuşu', author: 'Reşat Nuri Güntekin' },
            // Halide Edib Adıvar
            { title: 'Sinekli Bakkal', author: 'Halide Edib Adıvar' },
            // Yüzüklerin Efendisi (çeviri)
            { title: 'Yüzüklerin Efendisi', author: 'J.R.R. Tolkien' },
            { title: 'Yüzük Kardeşliği', author: 'Tolkien' },
            // Harry Potter (çeviri)
            { title: 'Harry Potter', author: 'J.K. Rowling' },
            { title: 'Harry Potter ve Felsefe Taşı', author: 'Rowling' },
            // Suç ve Ceza (çeviri)
            { title: 'Suç ve Ceza', author: 'Dostoyevski' },
            { title: 'Suç ve Ceza', author: 'Fyodor Dostoyevsky' },
            // Savaş ve Barış (çeviri)
            { title: 'Savaş ve Barış', author: 'Tolstoy' },
            { title: 'Savaş ve Barış', author: 'Leo Tolstoy' },
            // 1984 (çeviri)
            { title: '1984', author: 'George Orwell' },
            // Hayvan Çiftliği (çeviri)
            { title: 'Hayvan Çiftliği', author: 'George Orwell' },
            // Simyacı (çeviri)
            { title: 'Simyacı', author: 'Paulo Coelho' },
            // Küçük Prens (çeviri)
            { title: 'Küçük Prens', author: 'Antoine de Saint-Exupéry' },
            { title: 'Küçük Prens', author: 'Saint-Exupéry' }
        ];

        // Kitap eşleştirme fonksiyonu (başlık ve yazar karşılaştırması)
        function isBookMatch(book, popularBook) {
            if (!book || !popularBook) return false;

            // ISBN eşleşmesi (en kesin)
            if (popularBook.isbn && book.isbn) {
                const bookIsbn = book.isbn.replace(/[-\s]/g, '').substring(0, 13);
                const popularIsbn = popularBook.isbn.replace(/[-\s]/g, '').substring(0, 13);
                if (bookIsbn === popularIsbn || bookIsbn.endsWith(popularIsbn) || popularIsbn.endsWith(bookIsbn)) {
                    return true;
                }
            }

            // Başlık ve yazar eşleşmesi
            let bookTitle = (book.title || '').toLowerCase().trim();
            let popularTitle = (popularBook.title || '').toLowerCase().trim();
            let bookAuthor = (book.author || '').toLowerCase().trim();
            let popularAuthor = (popularBook.author || '').toLowerCase().trim();

            // Özel karakterleri ve fazla boşlukları temizle
            bookTitle = bookTitle.replace(/[^\w\sğüşıöçĞÜŞİÖÇ]/g, '').replace(/\s+/g, ' ');
            popularTitle = popularTitle.replace(/[^\w\sğüşıöçĞÜŞİÖÇ]/g, '').replace(/\s+/g, ' ');
            bookAuthor = bookAuthor.replace(/[^\w\sğüşıöçĞÜŞİÖÇ]/g, '').replace(/\s+/g, ' ');
            popularAuthor = popularAuthor.replace(/[^\w\sğüşıöçĞÜŞİÖÇ]/g, '').replace(/\s+/g, ' ');

            // Başlık eşleşmesi kontrolü (daha toleranslı)
            const titleWords = bookTitle.split(/\s+/).filter(w => w.length > 1);
            const popularTitleWords = popularTitle.split(/\s+/).filter(w => w.length > 1);

            // Tam eşleşme
            let titleMatch = bookTitle === popularTitle;

            // Normalize edilmiş eşleşme (boşluklar ve özel karakterler olmadan)
            if (!titleMatch) {
                const normalizedBookTitle = bookTitle.replace(/\s+/g, '').replace(/[^\wğüşıöçĞÜŞİÖÇ]/g, '');
                const normalizedPopularTitle = popularTitle.replace(/\s+/g, '').replace(/[^\wğüşıöçĞÜŞİÖÇ]/g, '');
                titleMatch = normalizedBookTitle === normalizedPopularTitle;
            }

            // Kelime bazlı eşleşme (başlığın %60'ı eşleşiyorsa kabul et - daha esnek)
            if (!titleMatch && titleWords.length > 0 && popularTitleWords.length > 0) {
                const matchingWords = titleWords.filter(word =>
                    popularTitleWords.some(popWord =>
                        word === popWord ||
                        word.includes(popWord) ||
                        popWord.includes(word) ||
                        (word.length >= 3 && popWord.length >= 3 && word.substring(0, 3) === popWord.substring(0, 3))
                    )
                );
                // Daha esnek: en az %60 eşleşme veya tek kelimelik başlıklar için tam eşleşme
                const minMatch = Math.min(titleWords.length, popularTitleWords.length);
                titleMatch = matchingWords.length >= Math.max(1, Math.ceil(minMatch * 0.6)) ||
                           (titleWords.length === 1 && popularTitleWords.length === 1 && titleWords[0] === popularTitleWords[0]);
            }

            // İçerme kontrolü (daha esnek)
            if (!titleMatch) {
                titleMatch = bookTitle.includes(popularTitle) ||
                           popularTitle.includes(bookTitle) ||
                           bookTitle.replace(/\s+/g, '').includes(popularTitle.replace(/\s+/g, '')) ||
                           popularTitle.replace(/\s+/g, '').includes(bookTitle.replace(/\s+/g, ''));
            }

            if (!titleMatch) return false;

            // Yazar eşleşmesi kontrolü (yazar bilgisi varsa)
            if (popularAuthor && bookAuthor) {
                // Yazar adlarını kelimelere ayır (daha esnek - 2 karakterden uzun kelimeler)
                const authorWords = popularAuthor.split(/\s+/).filter(w => w.length > 1);
                const bookAuthorWords = bookAuthor.split(/\s+/).filter(w => w.length > 1);

                // Yazar kelimelerinin eşleşmesini kontrol et
                const hasAuthorMatch = authorWords.some(word => {
                    return bookAuthorWords.some(bookWord => {
                        // Tam eşleşme
                        if (word === bookWord) return true;
                        // İçerme kontrolü
                        if (word.includes(bookWord) || bookWord.includes(word)) return true;
                        // İlk 3 karakter eşleşmesi (daha esnek)
                        if (word.length >= 3 && bookWord.length >= 3) {
                            if (word.substring(0, 3) === bookWord.substring(0, 3)) return true;
                        }
                        // Normalize edilmiş eşleşme
                        const normWord = word.replace(/[^\wğüşıöçĞÜŞİÖÇ]/g, '');
                        const normBookWord = bookWord.replace(/[^\wğüşıöçĞÜŞİÖÇ]/g, '');
                        if (normWord === normBookWord || normWord.includes(normBookWord) || normBookWord.includes(normWord)) {
                            return true;
                        }
                        return false;
                    });
                });

                // Yazar eşleşmesi yoksa ama başlık kesin eşleşiyorsa yine kabul et
                if (!hasAuthorMatch && titleMatch) {
                    // Başlık tam eşleşiyorsa yazar kontrolünü atla
                    if (bookTitle === popularTitle ||
                        bookTitle.replace(/\s+/g, '') === popularTitle.replace(/\s+/g, '')) {
                        return true;
                    }
                }

                return hasAuthorMatch;
            }

            // Yazar bilgisi yoksa sadece başlık eşleşmesi yeterli
            // Ama başlık kesin eşleşiyorsa kabul et
            return titleMatch;
        }

        // Google'da popüler olan yazarlar (en çok aranan - Google Trends'e göre)
        const POPULAR_AUTHORS = [
            // Türk yazarlar (en çok aranan)
            'Adam Fawer', 'Fawer', 'Adam',
            'Elif Şafak', 'Şafak', 'Elif',
            'Ahmet Ümit', 'Ümit', 'Ahmet',
            'Orhan Pamuk', 'Pamuk', 'Orhan',
            'İhsan Oktay Anar', 'Anar', 'İhsan Oktay',
            'Zülfü Livaneli', 'Livaneli', 'Zülfü',
            'Hakan Günday', 'Günday', 'Hakan',
            'Oğuz Atay', 'Atay', 'Oğuz',
            'Yaşar Kemal', 'Kemal', 'Yaşar',
            'Sabahattin Ali', 'Ali', 'Sabahattin',
            'Reşat Nuri Güntekin', 'Güntekin', 'Reşat Nuri',
            'Halide Edib Adıvar', 'Adıvar', 'Halide Edib',
            'Tuna Kiremitçi', 'Kiremitçi', 'Tuna',
            'Şebnem İşigüzel', 'İşigüzel', 'Şebnem',
            'Kürşat Başar', 'Başar', 'Kürşat',
            'Buket Uzuner', 'Uzuner', 'Buket',
            'Ayşe Kulin', 'Kulin', 'Ayşe',
            'Canan Tan', 'Tan', 'Canan',
            'Sinek Sekiz Yayınevi', 'Sinek Sekiz',
            'Nazan Bekiroğlu', 'Bekiroğlu', 'Nazan',
            'İskender Pala', 'Pala', 'İskender',
            'Murat Menteş', 'Menteş', 'Murat',
            'Barış Bıçakçı', 'Bıçakçı', 'Barış',
            'Burhan Sönmez', 'Sönmez', 'Burhan',
            'Şermin Yaşar', 'Yaşar', 'Şermin',
            // Yabancı yazarlar (Türkiye'de popüler)
            'J.R.R. Tolkien', 'Tolkien', 'J.R.R', 'JRR Tolkien',
            'J.K. Rowling', 'Rowling', 'J.K', 'JK Rowling',
            'Dostoyevski', 'Fyodor Dostoyevsky', 'Dostoyevsky', 'Fyodor',
            'Tolstoy', 'Leo Tolstoy', 'Lev Tolstoy',
            'George Orwell', 'Orwell', 'George',
            'Paulo Coelho', 'Coelho', 'Paulo',
            'Antoine de Saint-Exupéry', 'Saint-Exupéry', 'Exupéry', 'Saint Exupéry',
            'Gabriel García Márquez', 'Márquez', 'García Márquez',
            'Haruki Murakami', 'Murakami', 'Haruki',
            'Dan Brown', 'Brown', 'Dan',
            'Stephen King', 'King', 'Stephen',
            'Agatha Christie', 'Christie', 'Agatha',
            'Jane Austen', 'Austen', 'Jane',
            'Charles Dickens', 'Dickens', 'Charles',
            'Mark Twain', 'Twain', 'Mark',
            'Ernest Hemingway', 'Hemingway', 'Ernest',
            'Franz Kafka', 'Kafka', 'Franz',
            'Virginia Woolf', 'Woolf', 'Virginia',
            'Marcel Proust', 'Proust', 'Marcel',
            'F. Scott Fitzgerald', 'Fitzgerald', 'Scott Fitzgerald',
            'Aldous Huxley', 'Huxley', 'Aldous',
            'Ray Bradbury', 'Bradbury', 'Ray',
            'Isaac Asimov', 'Asimov', 'Isaac',
            'Jules Verne', 'Verne', 'Jules',
            'H.G. Wells', 'Wells', 'HG Wells',
            'Edgar Allan Poe', 'Poe', 'Edgar Allan',
            'Oscar Wilde', 'Wilde', 'Oscar',
            'Albert Camus', 'Camus', 'Albert',
            'Jean-Paul Sartre', 'Sartre', 'Jean Paul',
            'Milan Kundera', 'Kundera', 'Milan',
            'Umberto Eco', 'Eco', 'Umberto',
            'Italo Calvino', 'Calvino', 'Italo',
            'Isabel Allende', 'Allende', 'Isabel',
            'Mario Vargas Llosa', 'Vargas Llosa', 'Mario Vargas',
            'Jorge Luis Borges', 'Borges', 'Jorge Luis',
            'Gabriel Garcia Marquez', 'Garcia Marquez',
            'Chuck Palahniuk', 'Palahniuk', 'Chuck',
            'Kurt Vonnegut', 'Vonnegut', 'Kurt',
            'Raymond Carver', 'Carver', 'Raymond',
            'John Steinbeck', 'Steinbeck', 'John',
            'William Faulkner', 'Faulkner', 'William',
            'Tennessee Williams', 'Williams', 'Tennessee',
            'Arthur Conan Doyle', 'Conan Doyle', 'Arthur',
            'H.P. Lovecraft', 'Lovecraft', 'HP Lovecraft',
            'Bram Stoker', 'Stoker', 'Bram',
            'Mary Shelley', 'Shelley', 'Mary',
            'Charlotte Brontë', 'Brontë', 'Charlotte',
            'Emily Brontë', 'Emily',
            'Anne Brontë', 'Anne',
            'Victor Hugo', 'Hugo', 'Victor',
            'Alexandre Dumas', 'Dumas', 'Alexandre',
            'Gustave Flaubert', 'Flaubert', 'Gustave',
            'Émile Zola', 'Zola', 'Emile',
            'Honoré de Balzac', 'Balzac', 'Honore',
            'Stendhal', 'Marie-Henri Beyle',
            'Guy de Maupassant', 'Maupassant', 'Guy',
            'Anton Chekhov', 'Chekhov', 'Anton',
            'Ivan Turgenev', 'Turgenev', 'Ivan',
            'Nikolai Gogol', 'Gogol', 'Nikolai',
            'Aleksandr Pushkin', 'Pushkin', 'Aleksandr'
        ];

        // Yazar popülerlik kontrolü
        function isAuthorPopular(author) {
            if (!author) return false;
            const authorLower = author.toLowerCase().trim();

            return POPULAR_AUTHORS.some(popAuthor => {
                const popAuthorLower = popAuthor.toLowerCase().trim();
                // Tam eşleşme
                if (authorLower === popAuthorLower) return true;
                // İçerme kontrolü
                if (authorLower.includes(popAuthorLower) || popAuthorLower.includes(authorLower)) return true;
                // Kelime bazlı eşleşme
                const authorWords = authorLower.split(/\s+/);
                const popAuthorWords = popAuthorLower.split(/\s+/);
                return authorWords.some(word =>
                    popAuthorWords.some(popWord =>
                        word === popWord ||
                        word.includes(popWord) ||
                        popWord.includes(word) ||
                        (word.length >= 3 && popWord.length >= 3 && word.substring(0, 3) === popWord.substring(0, 3))
                    )
                );
            });
        }

        // Google Books popülerlik kriterleri (Google'da popüler olan kitaplar)
        function isGooglePopular(book) {
            if (!book) return false;

            const rating = book.averageRating || 0;
            const ratingsCount = book.ratingsCount || 0;
            const popularityScore = book.popularityScore || 0;

            // Google Books'ta çok popüler olan kitaplar için kriterler (daha esnek):
            // 1. Çok yüksek rating (4.3+) VE çok oy (50+) - iyi kitaplar
            // 2. VEYA çok oy (200+) - çok satan/okunan kitaplar (daha düşük eşik)
            // 3. VEYA yüksek popülerlik skoru (5+) - popüler kitaplar (daha düşük eşik)
            // 4. VEYA çok yüksek rating (4.6+) - en popüler kitaplar
            // 5. VEYA çok oy (500+) - çok popüler kitaplar
            // 6. VEYA orta-yüksek rating (4.0+) VE orta oy (100+) - popüler kitaplar

            const hasVeryHighRating = rating >= 4.3 && ratingsCount >= 50;
            const hasManyRatings = ratingsCount >= 200; // Daha düşük eşik
            const hasHighPopularityScore = popularityScore >= 5; // Daha düşük eşik
            const hasExtremeRating = rating >= 4.6;
            const hasExtremeRatingsCount = ratingsCount >= 500;
            const hasGoodRatingAndRatings = rating >= 4.0 && ratingsCount >= 100;

            return hasVeryHighRating || hasManyRatings || hasHighPopularityScore || hasExtremeRating || hasExtremeRatingsCount || hasGoodRatingAndRatings;
        }

        // Mağazalardaki popüler kitaplarla eşleştirme
        function matchWithPopularBooks(books) {
            if (!books || books.length === 0) return;

            let matchCount = 0;
            let googlePopularCount = 0;
            let authorPopularCount = 0;

            // Her kitap için popüler kitaplar listesini kontrol et
            for (let book of books) {
                let isPopular = false;
                let matchedBook = null;
                let isGooglePop = false;
                let isAuthorPop = false;

                // 1. Popüler kitaplar listesinde var mı?
                for (let popularBook of POPULAR_BOOKS) {
                    if (isBookMatch(book, popularBook)) {
                        isPopular = true;
                        matchedBook = popularBook;
                        matchCount++;
                        console.log(`🔥 Popüler kitap eşleşti: "${book.title}" - ${book.author} (Eşleşen: "${popularBook.title}" - ${popularBook.author})`);
                        break;
                    }
                }

                // 2. Google Books'ta popüler mi? (çok yüksek rating, çok oy, yüksek popülerlik skoru)
                if (!isPopular) {
                    isGooglePop = isGooglePopular(book);
                    if (isGooglePop) {
                        isPopular = true;
                        googlePopularCount++;
                        console.log(`🔥 Google'da popüler: "${book.title}" - ${book.author} (Rating: ${book.averageRating || 0}, Oy: ${book.ratingsCount || 0}, Skor: ${book.popularityScore || 0})`);
                    }
                }

                // 3. Yazar Google'da popüler mi? (en çok aranan yazarlar)
                if (!isPopular && book.author) {
                    isAuthorPop = isAuthorPopular(book.author);
                    if (isAuthorPop) {
                        isPopular = true;
                        authorPopularCount++;
                        console.log(`🔥 Popüler yazar: "${book.title}" - ${book.author}`);
                    }
                }

                book.isPopularInStores = isPopular;

                // Debug: Eşleşmeyen kitapları da göster (isteğe bağlı)
                if (!isPopular && book.title && book.title.toLowerCase().includes('empati')) {
                    console.log(`⚠️ Empati bulundu ama eşleşmedi: "${book.title}" - ${book.author} (Rating: ${book.averageRating || 0}, Oy: ${book.ratingsCount || 0})`);
                }
            }

            console.log(`📊 Popüler kitaplar işaretlendi: ${matchCount + googlePopularCount + authorPopularCount}/${books.length} kitap`);
            console.log(`   - Liste eşleşmesi: ${matchCount}`);
            console.log(`   - Google Books popüler: ${googlePopularCount}`);
            console.log(`   - Popüler yazar: ${authorPopularCount}`);

            // Eğer hiç popüler kitap yoksa uyarı ver
            if (matchCount === 0 && googlePopularCount === 0 && authorPopularCount === 0 && books.length > 0) {
                console.log('⚠️ Uyarı: Hiç popüler kitap eşleşmedi. Listede olmayan kitaplar olabilir.');
            }
        }

        // Birden fazla ücretsiz kaynaktan kitap kapağı görseli alma fonksiyonu
        function getBookCoverFromMultipleSources(isbn, isbn13, isbn10) {
            if (!isbn) return null;

            // Kullanılacak ISBN (öncelik ISBN-13)
            const primaryIsbn = isbn13 || isbn10 || isbn;
            const secondaryIsbn = isbn13 && isbn10 ? isbn10 : null;

            // Birden fazla ücretsiz kaynak (fallback mekanizması)
            // 1. Open Library (en güvenilir ve ücretsiz)
            const openLibraryLarge = `https://covers.openlibrary.org/b/isbn/${primaryIsbn}-L.jpg`;
            const openLibraryMedium = `https://covers.openlibrary.org/b/isbn/${primaryIsbn}-M.jpg`;

            // 2. Google Books Cover API (ISBN ile direkt)
            const googleBooksCover = `https://books.google.com/books/content/images/frontcover/${primaryIsbn}?fife=w400-h600`;
            const googleBooksCoverAlt = `https://books.google.com/books/publisher/content/images/frontcover/${primaryIsbn}?fife=w400-h600`;

            // 3. Open Library alternatif formatlar
            const openLibrarySmall = `https://covers.openlibrary.org/b/isbn/${primaryIsbn}-S.jpg`;

            // 4. ISBN-10 varsa onu da dene
            const openLibraryIsbn10 = secondaryIsbn ? `https://covers.openlibrary.org/b/isbn/${secondaryIsbn}-L.jpg` : null;

            // İlk kaynağı varsayılan olarak döndür (en güvenilir)
            // Gerçek kontrol client-side'da yapılacak (img onerror ile)
            return openLibraryLarge;
        }

        // Kitap kapağı görseli için fallback URL'leri oluştur
        function getBookCoverFallbackUrls(isbn, isbn13, isbn10) {
            if (!isbn) return [];

            const primaryIsbn = isbn13 || isbn10 || isbn;
            const secondaryIsbn = isbn13 && isbn10 ? isbn10 : null;

            const fallbackUrls = [
                // Open Library (en güvenilir)
                `https://covers.openlibrary.org/b/isbn/${primaryIsbn}-L.jpg`,
                `https://covers.openlibrary.org/b/isbn/${primaryIsbn}-M.jpg`,
                // Google Books Cover API
                `https://books.google.com/books/content/images/frontcover/${primaryIsbn}?fife=w400-h600`,
                `https://books.google.com/books/publisher/content/images/frontcover/${primaryIsbn}?fife=w400-h600`,
                // Open Library alternatif
                `https://covers.openlibrary.org/b/isbn/${primaryIsbn}-S.jpg`
            ];

            // ISBN-10 varsa onu da ekle
            if (secondaryIsbn) {
                fallbackUrls.push(`https://covers.openlibrary.org/b/isbn/${secondaryIsbn}-L.jpg`);
                fallbackUrls.push(`https://covers.openlibrary.org/b/isbn/${secondaryIsbn}-M.jpg`);
            }

            return fallbackUrls;
        }

        const MAX_RESULTS = 50;
        const FAVORITES_STORAGE_KEY = 'kitapFavorileri';
        const PRICES_STORAGE_KEY = 'kitapFiyatlari';
        const SEARCH_HISTORY_KEY = 'kitapAramaGecmisi';
        const THEME_STORAGE_KEY = 'kitapTemaTercihi';
        const curatedTestBooksLibrary = [
            {
                title: 'TYT Matematik Soru Bankası 2025',
                author: 'Akıl Fikir Yayınları Uzman Kadro',
                year: '2025',
                summary: 'Yeni nesil mantık soruları, konu özetleri ve akıllı ipuçlarıyla güncel TYT matematik müfredatını birebir takip eder.',
                thumbnail: 'https://dummyimage.com/320x480/1f2933/ffffff&text=TYT+MAT',
                isbn: '9786050000011',
                tags: ['tyt', 'matematik', 'soru bankası', 'yeni nesil'],
                examLevels: ['TYT'],
                publisher: 'Akıl Fikir Yayınları',
                averageRating: 4.9,
                ratingsCount: 1246
            },
            {
                title: 'AYT Fizik 30×40 Deneme Seti',
                author: 'Quantum Sınav Atölyesi',
                year: '2024',
                summary: 'MEB kazanımlarına göre gruplandırılmış 30 fasikül ve 40 özgün denemeden oluşur, video çözüm QR kodları içerir.',
                thumbnail: 'https://dummyimage.com/320x480/143041/ffffff&text=AYT+FIZIK',
                isbn: '9786050000028',
                tags: ['ayt', 'fizik', 'deneme', 'video çözümlü'],
                examLevels: ['AYT', 'YKS'],
                publisher: 'Quantum',
                averageRating: 4.8,
                ratingsCount: 987
            },
            {
                title: 'YKS Paragraf Kampı 8 Haftada',
                author: 'Dilhan Yayıncılık Editör Kurulu',
                year: '2025',
                summary: 'Paragraf hızını artıran 56 günlük kamp programı, günlük takip çizelgesi ve metin çözüm teknikleriyle desteklenir.',
                thumbnail: 'https://dummyimage.com/320x480/1b3a4b/ffffff&text=PARAGRAF',
                isbn: '9786050000035',
                tags: ['tyt', 'yks', 'paragraf', 'kamp programı'],
                examLevels: ['TYT', 'KPSS'],
                publisher: 'Dilhan Yayıncılık',
                averageRating: 4.7,
                ratingsCount: 1632
            },
            {
                title: 'TYT-AYT Kimya Konu Anlatımlı',
                author: 'LabPlus Akademi',
                year: '2025',
                summary: 'Temel kavramlardan ileri organik kimyaya kadar tüm üniteler infografik destekli anlatımla pekiştirilir.',
                thumbnail: 'https://dummyimage.com/320x480/0f2f3d/ffffff&text=KIMYA',
                isbn: '9786050000042',
                tags: ['tyt', 'ayt', 'kimya', 'konu anlatımı'],
                examLevels: ['TYT', 'AYT'],
                publisher: 'LabPlus',
                averageRating: 4.85,
                ratingsCount: 754
            },
            {
                title: 'KPSS Eğitim Bilimleri Tamamı Çözümlü',
                author: 'Uzman Kariyer Akademi',
                year: '2024',
                summary: 'Öğretim yöntemleri, ölçme ve değerlendirme, gelişim psikolojisi konularında tamamı çözümlü 1200 soru içerir.',
                thumbnail: 'https://dummyimage.com/320x480/292524/ffffff&text=KPSS+EB',
                isbn: '9786050000059',
                tags: ['kpss', 'eğitim bilimleri', 'tamamı çözümlü'],
                examLevels: ['KPSS'],
                publisher: 'Uzman Kariyer',
                averageRating: 4.6,
                ratingsCount: 543
            },
            {
                title: 'MSÜ Matematik Hızlı Tekrar Föyleri',
                author: 'Savunma Akademi',
                year: '2025',
                summary: 'MSÜ formatına uygun, 12 modülden oluşan tekrar föyleri ve pratik hız tabloları içerir.',
                thumbnail: 'https://dummyimage.com/320x480/1c2e3f/ffffff&text=MSU+MAT',
                isbn: '9786050000066',
                tags: ['msü', 'matematik', 'föy', 'tekrar'],
                examLevels: ['MSÜ', 'TYT'],
                publisher: 'Savunma Akademi',
                averageRating: 4.75,
                ratingsCount: 412
            },
            {
                title: 'TYT Fen Bilimleri Masterclass',
                author: 'Astera Eğitim Platformu',
                year: '2025',
                summary: 'Biyoloji, fizik ve kimya konularını tek kitapta toplayan, QR kodlu dijital laboratuvar etkinlikleri içerir.',
                thumbnail: 'https://dummyimage.com/320x480/102a43/ffffff&text=FEN',
                isbn: '9786050000073',
                tags: ['tyt', 'fen', 'masterclass', 'video destekli'],
                examLevels: ['TYT'],
                publisher: 'Astera',
                averageRating: 4.85,
                ratingsCount: 628
            },
            {
                title: 'TYT Türkçe Paragraf Soru Bankası',
                author: 'Kelime Kulübü',
                year: '2025',
                summary: 'Zorluk seviyesine göre renklendirilmiş paragraflar ve hız ölçer sayfalarla süre yönetimini geliştirir.',
                thumbnail: 'https://dummyimage.com/320x480/2a3d45/ffffff&text=TURKCE',
                isbn: '9786050000080',
                tags: ['tyt', 'türkçe', 'paragraf', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Kelime Kulübü',
                averageRating: 4.9,
                ratingsCount: 2014
            },
            // ===== POPÜLER TEST KİTABI YAYINEVLERİ =====
            {
                title: 'TYT Matematik Soru Bankası',
                author: 'Tonguç Akademi',
                year: '2025',
                summary: 'Adım adım konu anlatımı ve bolca soru çözümü ile TYT matematiğe hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/e74c3c/ffffff&text=TONGUC',
                isbn: '9786050100001',
                tags: ['tyt', 'matematik', 'soru bankası', 'tonguç'],
                examLevels: ['TYT'],
                publisher: 'Tonguç Akademi',
                averageRating: 4.9,
                ratingsCount: 5420
            },
            {
                title: 'AYT Fizik Konu Anlatımlı',
                author: 'Palme Yayınevi',
                year: '2025',
                summary: 'Detaylı konu anlatımı ve örnek sorularla AYT fiziğe kapsamlı hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/27ae60/ffffff&text=PALME',
                isbn: '9786050100002',
                tags: ['ayt', 'fizik', 'konu anlatımlı'],
                examLevels: ['AYT'],
                publisher: 'Palme Yayınları',
                averageRating: 4.8,
                ratingsCount: 3210
            },
            {
                title: 'TYT-AYT Geometri Soru Bankası',
                author: 'Limit Yayınları',
                year: '2025',
                summary: 'Temel geometriden analitik geometriye tüm konuları kapsayan soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/3498db/ffffff&text=LIMIT',
                isbn: '9786050100003',
                tags: ['tyt', 'ayt', 'geometri', 'soru bankası'],
                examLevels: ['TYT', 'AYT'],
                publisher: 'Limit Yayınları',
                averageRating: 4.85,
                ratingsCount: 2890
            },
            {
                title: 'TYT Türkçe Soru Bankası',
                author: '3D Yayınları',
                year: '2025',
                summary: '3 boyutlu öğrenme sistemiyle Türkçe dersine farklı bir bakış açısı.',
                thumbnail: 'https://dummyimage.com/320x480/9b59b6/ffffff&text=3D',
                isbn: '9786050100004',
                tags: ['tyt', 'türkçe', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: '3D Yayınları',
                averageRating: 4.7,
                ratingsCount: 2150
            },
            {
                title: 'TYT Matematik Video Çözümlü',
                author: 'Benim Hocam Yayınları',
                year: '2025',
                summary: 'QR kodlu video çözümlerle desteklenen interaktif soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/e67e22/ffffff&text=BENIM+HOCAM',
                isbn: '9786050100005',
                tags: ['tyt', 'matematik', 'video çözümlü'],
                examLevels: ['TYT'],
                publisher: 'Benim Hocam Yayınları',
                averageRating: 4.9,
                ratingsCount: 4560
            },
            {
                title: 'AYT Matematik Soru Bankası',
                author: 'Karekök Yayınları',
                year: '2025',
                summary: 'İleri düzey matematik konularını kapsayan kapsamlı soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/1abc9c/ffffff&text=KAREKOK',
                isbn: '9786050100006',
                tags: ['ayt', 'matematik', 'soru bankası'],
                examLevels: ['AYT'],
                publisher: 'Karekök Yayınları',
                averageRating: 4.8,
                ratingsCount: 3780
            },
            {
                title: 'TYT Fen Bilimleri Soru Bankası',
                author: 'FDD Yayınları',
                year: '2025',
                summary: 'Fizik, kimya ve biyoloji konularını bir arada sunan kapsamlı kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/2c3e50/ffffff&text=FDD',
                isbn: '9786050100007',
                tags: ['tyt', 'fen', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'FDD Yayınları',
                averageRating: 4.75,
                ratingsCount: 1980
            },
            {
                title: 'LGS Matematik Soru Bankası',
                author: 'Bilfen Yayıncılık',
                year: '2025',
                summary: 'LGS sınavına özel hazırlanmış matematik soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/16a085/ffffff&text=BILFEN',
                isbn: '9786050100008',
                tags: ['lgs', 'matematik', 'soru bankası'],
                examLevels: ['LGS'],
                publisher: 'Bilfen Yayıncılık',
                averageRating: 4.8,
                ratingsCount: 2340
            },
            {
                title: 'KPSS Genel Yetenek Soru Bankası',
                author: 'Yargı Yayınları',
                year: '2025',
                summary: 'KPSS genel yetenek testine kapsamlı hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/c0392b/ffffff&text=YARGI',
                isbn: '9786050100009',
                tags: ['kpss', 'genel yetenek', 'soru bankası'],
                examLevels: ['KPSS'],
                publisher: 'Yargı Yayınları',
                averageRating: 4.85,
                ratingsCount: 4120
            },
            {
                title: 'KPSS Eğitim Bilimleri',
                author: 'Pegem Akademi',
                year: '2025',
                summary: 'Öğretmenlik sınavlarına kapsamlı hazırlık kaynağı.',
                thumbnail: 'https://dummyimage.com/320x480/8e44ad/ffffff&text=PEGEM',
                isbn: '9786050100010',
                tags: ['kpss', 'eğitim bilimleri', 'öğretmenlik'],
                examLevels: ['KPSS'],
                publisher: 'Pegem Akademi',
                averageRating: 4.9,
                ratingsCount: 3560
            },
            {
                title: 'TYT Matematik Föy Seti',
                author: 'Hız ve Renk Yayınları',
                year: '2025',
                summary: 'Renkli ve hızlı öğrenme için tasarlanmış föy seti.',
                thumbnail: 'https://dummyimage.com/320x480/f39c12/ffffff&text=HIZ+RENK',
                isbn: '9786050100011',
                tags: ['tyt', 'matematik', 'föy'],
                examLevels: ['TYT'],
                publisher: 'Hız ve Renk Yayınları',
                averageRating: 4.7,
                ratingsCount: 1890
            },
            {
                title: 'LGS Tüm Dersler Soru Bankası',
                author: 'Okyanus Yayınları',
                year: '2025',
                summary: 'LGS sınavına tüm derslerden kapsamlı hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/0984e3/ffffff&text=OKYANUS',
                isbn: '9786050100012',
                tags: ['lgs', 'tüm dersler', 'soru bankası'],
                examLevels: ['LGS'],
                publisher: 'Okyanus Yayınları',
                averageRating: 4.8,
                ratingsCount: 2670
            },
            {
                title: 'AYT Kimya Soru Bankası',
                author: 'Çap Yayınları',
                year: '2025',
                summary: 'AYT kimya konularını kapsayan detaylı soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/6c5ce7/ffffff&text=CAP',
                isbn: '9786050100013',
                tags: ['ayt', 'kimya', 'soru bankası'],
                examLevels: ['AYT'],
                publisher: 'Çap Yayınları',
                averageRating: 4.75,
                ratingsCount: 1650
            },
            {
                title: 'TYT-AYT Geometri',
                author: 'Apotemi Yayınları',
                year: '2025',
                summary: 'Geometri konularında uzmanlaşmış kapsamlı kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/00b894/ffffff&text=APOTEMI',
                isbn: '9786050100014',
                tags: ['tyt', 'ayt', 'geometri'],
                examLevels: ['TYT', 'AYT'],
                publisher: 'Apotemi Yayınları',
                averageRating: 4.85,
                ratingsCount: 2340
            },
            {
                title: 'TYT Biyoloji Soru Bankası',
                author: 'Bilgi Sarmal Yayınları',
                year: '2025',
                summary: 'TYT biyoloji konularını kapsayan soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/00cec9/ffffff&text=BILGI+SARMAL',
                isbn: '9786050100015',
                tags: ['tyt', 'biyoloji', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Bilgi Sarmal Yayınları',
                averageRating: 4.7,
                ratingsCount: 1420
            },
            {
                title: 'TYT Matematik Antrenman',
                author: 'Antrenman Yayınları',
                year: '2025',
                summary: 'Matematik problemlerini çözmek için sistematik antrenman programı.',
                thumbnail: 'https://dummyimage.com/320x480/fd79a8/ffffff&text=ANTRENMAN',
                isbn: '9786050100016',
                tags: ['tyt', 'matematik', 'antrenman'],
                examLevels: ['TYT'],
                publisher: 'Antrenman Yayınları',
                averageRating: 4.9,
                ratingsCount: 5890
            },
            {
                title: 'TYT-AYT Fizik Soru Bankası',
                author: 'Esen Yayınları',
                year: '2025',
                summary: 'Fizik konularında kapsamlı soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/a29bfe/ffffff&text=ESEN',
                isbn: '9786050100017',
                tags: ['tyt', 'ayt', 'fizik', 'soru bankası'],
                examLevels: ['TYT', 'AYT'],
                publisher: 'Esen Yayınları',
                averageRating: 4.75,
                ratingsCount: 1780
            },
            {
                title: 'TYT Türkçe Deneme',
                author: 'Açı Yayınları',
                year: '2025',
                summary: 'TYT Türkçe denemelerle sınav pratiği.',
                thumbnail: 'https://dummyimage.com/320x480/fdcb6e/333333&text=ACI',
                isbn: '9786050100018',
                tags: ['tyt', 'türkçe', 'deneme'],
                examLevels: ['TYT'],
                publisher: 'Açı Yayınları',
                averageRating: 4.7,
                ratingsCount: 1340
            },
            {
                title: 'TYT 345 Matematik',
                author: 'Üç Dört Beş Yayınları',
                year: '2025',
                summary: 'Adım adım seviye artışıyla matematik öğrenimi.',
                thumbnail: 'https://dummyimage.com/320x480/74b9ff/333333&text=345',
                isbn: '9786050100019',
                tags: ['tyt', 'matematik', 'seviyeli'],
                examLevels: ['TYT'],
                publisher: 'Üç Dört Beş Yayınları',
                averageRating: 4.8,
                ratingsCount: 2980
            },
            {
                title: 'LGS Fen Bilimleri',
                author: 'Delta Kültür Yayınları',
                year: '2025',
                summary: 'LGS fen bilimleri konularına hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/55efc4/333333&text=DELTA',
                isbn: '9786050100020',
                tags: ['lgs', 'fen', 'soru bankası'],
                examLevels: ['LGS'],
                publisher: 'Delta Kültür Yayınları',
                averageRating: 4.7,
                ratingsCount: 1560
            },
            {
                title: 'TYT Coğrafya Soru Bankası',
                author: 'Kültür Yayınları',
                year: '2025',
                summary: 'TYT coğrafya konularını kapsayan kapsamlı kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/81ecec/333333&text=KULTUR',
                isbn: '9786050100021',
                tags: ['tyt', 'coğrafya', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Kültür Yayınları',
                averageRating: 4.75,
                ratingsCount: 1230
            },
            {
                title: 'AYT Edebiyat Soru Bankası',
                author: 'Birey Yayınları',
                year: '2025',
                summary: 'AYT Türk dili ve edebiyatı konularına hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/fab1a0/333333&text=BIREY',
                isbn: '9786050100022',
                tags: ['ayt', 'edebiyat', 'soru bankası'],
                examLevels: ['AYT'],
                publisher: 'Birey Yayınları',
                averageRating: 4.7,
                ratingsCount: 1890
            },
            {
                title: 'TYT Tarih Soru Bankası',
                author: 'Final Yayınları',
                year: '2025',
                summary: 'TYT tarih konularını kapsayan soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/ffeaa7/333333&text=FINAL',
                isbn: '9786050100023',
                tags: ['tyt', 'tarih', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Final Yayınları',
                averageRating: 4.75,
                ratingsCount: 1670
            },
            {
                title: 'KPSS Vatandaşlık',
                author: 'İsem Yayıncılık',
                year: '2025',
                summary: 'KPSS vatandaşlık konularına kapsamlı hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/dfe6e9/333333&text=ISEM',
                isbn: '9786050100024',
                tags: ['kpss', 'vatandaşlık', 'soru bankası'],
                examLevels: ['KPSS'],
                publisher: 'İsem Yayıncılık',
                averageRating: 4.8,
                ratingsCount: 2340
            },
            {
                title: 'ALES Sayısal Soru Bankası',
                author: 'Yediiklim Yayınları',
                year: '2025',
                summary: 'ALES sayısal bölüm hazırlığı için kapsamlı kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/b2bec3/333333&text=YEDIIKLIM',
                isbn: '9786050100025',
                tags: ['ales', 'sayısal', 'soru bankası'],
                examLevels: ['ALES'],
                publisher: 'Yediiklim Yayınları',
                averageRating: 4.8,
                ratingsCount: 1980
            },
            {
                title: 'LGS İngilizce Soru Bankası',
                author: 'Nitelik Yayınları',
                year: '2025',
                summary: 'LGS İngilizce sınavına hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/636e72/ffffff&text=NITELIK',
                isbn: '9786050100026',
                tags: ['lgs', 'ingilizce', 'soru bankası'],
                examLevels: ['LGS'],
                publisher: 'Nitelik Yayınları',
                averageRating: 4.7,
                ratingsCount: 1120
            },
            {
                title: 'TYT Fen Bilimleri',
                author: 'Fen Bilimleri Yayınları',
                year: '2025',
                summary: 'TYT fen bilimleri konularında uzman kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/2d3436/ffffff&text=FEN+BIL',
                isbn: '9786050100027',
                tags: ['tyt', 'fen', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Fen Bilimleri Yayınları',
                averageRating: 4.8,
                ratingsCount: 2560
            },
            {
                title: 'AYT Biyoloji Soru Bankası',
                author: 'Endemik Yayınları',
                year: '2025',
                summary: 'AYT biyoloji konularında detaylı soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/00b894/ffffff&text=ENDEMIK',
                isbn: '9786050100028',
                tags: ['ayt', 'biyoloji', 'soru bankası'],
                examLevels: ['AYT'],
                publisher: 'Endemik Yayınları',
                averageRating: 4.85,
                ratingsCount: 1780
            },
            {
                title: 'TYT Matematik Problemler',
                author: 'Miray Yayınları',
                year: '2025',
                summary: 'Problem çözme becerisini geliştiren kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/e17055/ffffff&text=MIRAY',
                isbn: '9786050100029',
                tags: ['tyt', 'matematik', 'problem'],
                examLevels: ['TYT'],
                publisher: 'Miray Yayınları',
                averageRating: 4.75,
                ratingsCount: 1340
            },
            {
                title: 'TYT Deneme Seti',
                author: 'Acil Yayınları',
                year: '2025',
                summary: 'TYT sınavına hazırlık için deneme seti.',
                thumbnail: 'https://dummyimage.com/320x480/d63031/ffffff&text=ACIL',
                isbn: '9786050100030',
                tags: ['tyt', 'deneme', 'sınav'],
                examLevels: ['TYT'],
                publisher: 'Acil Yayınları',
                averageRating: 4.7,
                ratingsCount: 1560
            },
            {
                title: 'LGS Deneme Sınavları',
                author: 'Gezegen Yayınları',
                year: '2025',
                summary: 'LGS formatında deneme sınavları.',
                thumbnail: 'https://dummyimage.com/320x480/0652DD/ffffff&text=GEZEGEN',
                isbn: '9786050100031',
                tags: ['lgs', 'deneme', 'sınav'],
                examLevels: ['LGS'],
                publisher: 'Gezegen Yayınları',
                averageRating: 4.8,
                ratingsCount: 1890
            },
            {
                title: 'TYT Sosyal Bilimler',
                author: 'Örnek Akademi',
                year: '2025',
                summary: 'TYT sosyal bilimler konularına hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/1289A7/ffffff&text=ORNEK',
                isbn: '9786050100032',
                tags: ['tyt', 'sosyal', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Örnek Akademi',
                averageRating: 4.7,
                ratingsCount: 1230
            },
            {
                title: 'TYT Türkçe',
                author: 'Aydın Yayınları',
                year: '2025',
                summary: 'TYT Türkçe soru bankası.',
                thumbnail: 'https://dummyimage.com/320x480/5758BB/ffffff&text=AYDIN',
                isbn: '9786050100033',
                tags: ['tyt', 'türkçe', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Aydın Yayınları',
                averageRating: 4.75,
                ratingsCount: 1450
            },
            {
                title: 'LGS Matematik',
                author: 'Test Okul Yayınları',
                year: '2025',
                summary: 'LGS matematik konularına hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/EE5A24/ffffff&text=TEST+OKUL',
                isbn: '9786050100034',
                tags: ['lgs', 'matematik', 'soru bankası'],
                examLevels: ['LGS'],
                publisher: 'Test Okul Yayınları',
                averageRating: 4.7,
                ratingsCount: 980
            },
            {
                title: 'DGS Sayısal Soru Bankası',
                author: 'Kariyer Meslek Yayınları',
                year: '2025',
                summary: 'DGS sınavına sayısal hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/A3CB38/333333&text=KARIYER',
                isbn: '9786050100035',
                tags: ['dgs', 'sayısal', 'soru bankası'],
                examLevels: ['DGS'],
                publisher: 'Kariyer Meslek Yayınları',
                averageRating: 4.75,
                ratingsCount: 1670
            },
            {
                title: 'YDS İngilizce',
                author: 'Yargı Akademi',
                year: '2025',
                summary: 'YDS sınavına kapsamlı İngilizce hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/F79F1F/333333&text=YARGI+AK',
                isbn: '9786050100036',
                tags: ['yds', 'ingilizce', 'soru bankası'],
                examLevels: ['YDS'],
                publisher: 'Yargı Akademi',
                averageRating: 4.8,
                ratingsCount: 2120
            },
            {
                title: 'AYT Felsefe Soru Bankası',
                author: 'Hocalara Geldik',
                year: '2025',
                summary: 'AYT felsefe konularına kapsamlı hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/9980FA/ffffff&text=HG',
                isbn: '9786050100037',
                tags: ['ayt', 'felsefe', 'soru bankası'],
                examLevels: ['AYT'],
                publisher: 'Hocalara Geldik',
                averageRating: 4.85,
                ratingsCount: 1890
            },
            {
                title: 'TYT Problemler',
                author: 'Kırmızı Beyaz Yayınları',
                year: '2025',
                summary: 'TYT matematik problemleri için özel hazırlanmış kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/EA2027/ffffff&text=KIRMIZI',
                isbn: '9786050100038',
                tags: ['tyt', 'matematik', 'problem'],
                examLevels: ['TYT'],
                publisher: 'Kırmızı Beyaz Yayınları',
                averageRating: 4.7,
                ratingsCount: 1230
            },
            {
                title: 'AYT Matematik',
                author: 'Bilgiküpü Yayınları',
                year: '2025',
                summary: 'AYT matematik konularında detaylı kaynak.',
                thumbnail: 'https://dummyimage.com/320x480/006266/ffffff&text=BILGI',
                isbn: '9786050100039',
                tags: ['ayt', 'matematik', 'soru bankası'],
                examLevels: ['AYT'],
                publisher: 'Bilgiküpü Yayınları',
                averageRating: 4.75,
                ratingsCount: 1120
            },
            {
                title: 'TYT Din Kültürü',
                author: 'Rty Rota Yayınları',
                year: '2025',
                summary: 'TYT din kültürü ve ahlak bilgisi hazırlığı.',
                thumbnail: 'https://dummyimage.com/320x480/833471/ffffff&text=RTY',
                isbn: '9786050100040',
                tags: ['tyt', 'din kültürü', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Rty Rota Yayınları',
                averageRating: 4.7,
                ratingsCount: 890
            },
            {
                title: 'LGS Türkçe',
                author: 'Berkay Yayıncılık',
                year: '2025',
                summary: 'LGS Türkçe sınavına hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/6F1E51/ffffff&text=BERKAY',
                isbn: '9786050100041',
                tags: ['lgs', 'türkçe', 'soru bankası'],
                examLevels: ['LGS'],
                publisher: 'Berkay Yayıncılık',
                averageRating: 4.7,
                ratingsCount: 980
            },
            {
                title: 'TYT Kimya Soru Bankası',
                author: 'Puan Yayınları',
                year: '2025',
                summary: 'TYT kimya konularına detaylı hazırlık.',
                thumbnail: 'https://dummyimage.com/320x480/B53471/ffffff&text=PUAN',
                isbn: '9786050100042',
                tags: ['tyt', 'kimya', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Puan Yayınları',
                averageRating: 4.75,
                ratingsCount: 1340
            },
            {
                title: 'AYT Fizik Deneme',
                author: 'Orbital Yayınları',
                year: '2025',
                summary: 'AYT fizik denemeleri.',
                thumbnail: 'https://dummyimage.com/320x480/1B1464/ffffff&text=ORBITAL',
                isbn: '9786050100043',
                tags: ['ayt', 'fizik', 'deneme'],
                examLevels: ['AYT'],
                publisher: 'Orbital Yayınları',
                averageRating: 4.8,
                ratingsCount: 1120
            },
            {
                title: 'TYT Coğrafya',
                author: 'Süper Kitap Yayınları',
                year: '2025',
                summary: 'TYT coğrafya hazırlığı.',
                thumbnail: 'https://dummyimage.com/320x480/182C61/ffffff&text=SUPER',
                isbn: '9786050100044',
                tags: ['tyt', 'coğrafya', 'soru bankası'],
                examLevels: ['TYT'],
                publisher: 'Süper Kitap Yayınları',
                averageRating: 4.7,
                ratingsCount: 870
            },
            {
                title: 'LGS İnkılap Tarihi',
                author: 'Mozaik Yayınları',
                year: '2025',
                summary: 'LGS T.C. inkılap tarihi ve Atatürkçülük hazırlığı.',
                thumbnail: 'https://dummyimage.com/320x480/3B3B98/ffffff&text=MOZAIK',
                isbn: '9786050100045',
                tags: ['lgs', 'inkılap tarihi', 'soru bankası'],
                examLevels: ['LGS'],
                publisher: 'Mozaik Yayınları',
                averageRating: 4.75,
                ratingsCount: 760
            }
        ];

        // Keşfet / Önerilen Kitaplar (statik içerik)
        const DISCOVER_BOOKS = [
            {
                title: "1984",
                author: "George Orwell",
                year: "1949",
                summary: "Distopik bir dünyada totaliter rejimi anlatan klasik roman.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            },
            {
                title: "Kürk Mantolu Madonna",
                author: "Sabahattin Ali",
                year: "1943",
                summary: "Raif Efendi'nin derin iç dünyasını ve aşkını anlatan roman.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            },
            {
                title: "Tutunamayanlar",
                author: "Oğuz Atay",
                year: "1971",
                summary: "Türk edebiyatının en önemli postmodern romanlarından biri.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            },
            {
                title: "İnce Memed",
                author: "Yaşar Kemal",
                year: "1955",
                summary: "Çukurova'da eşkıya olan İnce Memed'in hikayesi.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            },
            {
                title: "Simyacı",
                author: "Paulo Coelho",
                year: "1988",
                summary: "Kişisel efsanesini arayan bir çobanın yolculuğu.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            },
            {
                title: "Küçük Prens",
                author: "Antoine de Saint-Exupéry",
                year: "1943",
                summary: "Çocuklar ve yetişkinler için yazılmış felsefi bir masal.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            },
            {
                title: "Suç ve Ceza",
                author: "Fyodor Dostoyevsky",
                year: "1866",
                summary: "Raskolnikov'un işlediği cinayet ve sonrasındaki vicdan azabı.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            },
            {
                title: "Yüzüklerin Efendisi",
                author: "J.R.R. Tolkien",
                year: "1954",
                summary: "Orta Dünya'da geçen epik fantastik macera.",
                source: "Önerilen",
                thumbnail: null,
                isbn: null
            }
        ];

        let currentBooks = []; // Mevcut arama sonuçlarını sakla
        let currentOrderBy = 'relevance'; // Sıralama seçeneği
        
        // Tüm kütüphane kitaplarını birleştir (curatedTestBooksLibrary + DISCOVER_BOOKS)
        const FULL_LIBRARY = [...curatedTestBooksLibrary, ...DISCOVER_BOOKS];

        // Tema yönetimi
        function getThemePreference() {
            return localStorage.getItem(THEME_STORAGE_KEY) || 'auto'; // 'auto', 'dark', 'light'
        }

        function saveThemePreference(theme) {
            localStorage.setItem(THEME_STORAGE_KEY, theme);
        }

        function setQuoteAuthorColor(color) {
            document.documentElement.style.setProperty('--quote-author-color', color || '#1f2a37');
        }

        function applyTheme(theme) {
            const body = document.body;
            body.classList.remove('dark-mode', 'light-mode');

            if (theme === 'dark') {
                body.classList.add('dark-mode');
                updateThemeButton(true);
                setQuoteAuthorColor('#f5f7ff');
            } else if (theme === 'light') {
                body.classList.add('light-mode');
                updateThemeButton(false);
                setQuoteAuthorColor('#1f2a37');
            } else {
                // Auto mod - sistem tercihini kullan
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    body.classList.add('dark-mode');
                    updateThemeButton(true);
                    setQuoteAuthorColor('#f5f7ff');
                } else {
                    updateThemeButton(false);
                    setQuoteAuthorColor('#1f2a37');
                }
            }
        }

        function updateThemeButton(isDark) {
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            if (themeIcon && themeText) {
                if (isDark) {
                    themeIcon.textContent = '☀️';
                    themeText.textContent = 'Açık Mod';
                } else {
                    themeIcon.textContent = '🌙';
                    themeText.textContent = 'Koyu Mod';
                }
            }
        }

        function toggleTheme() {
            const currentTheme = getThemePreference();
            let newTheme;

            if (currentTheme === 'auto') {
                // Auto moddan koyu moda geç
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                newTheme = prefersDark ? 'light' : 'dark';
            } else if (currentTheme === 'dark') {
                newTheme = 'light';
            } else {
                newTheme = 'dark';
            }

            saveThemePreference(newTheme);
            applyTheme(newTheme);
        }

        // Arama geçmişi yönetimi
        function getSearchHistory() {
            const history = localStorage.getItem(SEARCH_HISTORY_KEY);
            return history ? JSON.parse(history) : [];
        }

        function saveSearchHistory(history) {
            localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
        }

        function addToSearchHistory(searchTerm) {
            if (!searchTerm || searchTerm.trim().length === 0) return;

            let history = getSearchHistory();
            // Aynı terimi kaldır (varsa)
            history = history.filter(term => term.toLowerCase() !== searchTerm.toLowerCase().trim());
            // En başa ekle
            history.unshift(searchTerm.trim());
            // Son 5'i sakla
            history = history.slice(0, 5);
            saveSearchHistory(history);
        }

        function showSearchHistory() {
            const dropdown = document.getElementById('searchHistoryDropdown');
            const history = getSearchHistory();

            if (history.length === 0) {
                dropdown.classList.remove('show');
                return;
            }

            // Önceki event listener'ları temizle
            dropdown.innerHTML = '';

            history.forEach((term, index) => {
                const item = document.createElement('div');
                item.className = 'search-history-item';
                item.setAttribute('role', 'option');
                item.setAttribute('tabindex', '0');
                item.setAttribute('data-term', term);
                item.innerHTML = `
                    <span class="icon">🕒</span>
                    <span>${escapeHtml(term)}</span>
                `;

                // Event listener ekle
                item.addEventListener('click', function() {
                    selectSearchHistory(term);
                });

                item.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        selectSearchHistory(term);
                    }
                });

                dropdown.appendChild(item);
            });

            dropdown.classList.add('show');
        }

        function hideSearchHistory() {
            const dropdown = document.getElementById('searchHistoryDropdown');
            dropdown.classList.remove('show');
        }

        function selectSearchHistory(term) {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = term || '';
                searchInput.focus();
            }
            hideSearchHistory();
            setTimeout(() => {
                // Başka bir arama sürüyorsa iptal et
                if (isSearching) {
                    isSearching = false;
                }
                searchBooks();
            }, 50);
        }

        // Son Aramalar fonksiyonları
        function saveRecentSearch(query) {
            if (!query || query.trim().length === 0) return;

            const trimmedQuery = query.trim();
            let recentSearches = [];

            try {
                const stored = localStorage.getItem('recentSearches_v1');
                if (stored) {
                    recentSearches = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Son aramalar yüklenirken hata:', e);
                recentSearches = [];
            }

            // Aynı sorguyu kaldır (varsa)
            recentSearches = recentSearches.filter(item => item.toLowerCase() !== trimmedQuery.toLowerCase());

            // En başa ekle
            recentSearches.unshift(trimmedQuery);

            // Maksimum 10 kayıt tut
            recentSearches = recentSearches.slice(0, 10);

            // localStorage'a kaydet
            try {
                localStorage.setItem('recentSearches_v1', JSON.stringify(recentSearches));
            } catch (e) {
                console.error('Son aramalar kaydedilirken hata:', e);
            }
        }


        // displayResults için HTML oluşturma fonksiyonu
        function displayResultsHTML(books, uniqueId = 'res') {
            return books.map((book, index) => {
                // displayResults içindeki aynı mantığı kullan
                let coverImage = '';
                const placeholderId = `placeholder-${uniqueId}-${index}`;
                const imageId = `image-${uniqueId}-${index}`;
                const favoriteId = `favorite-${uniqueId}-${index}`;
                const bookId = book.isbn || `${book.title}_${book.author}`;
                const isFav = isFavorite(book);
                const favoriteClass = isFav ? 'active' : '';
                const favoriteIcon = isFav ? '⭐' : '☆';
                const links = buildPurchaseLinks(book);

                if (book.thumbnail) {
                    coverImage = `<img id="${imageId}"
                                      src="${book.thumbnail}"
                                      alt="${escapeHtml(book.title)}"
                                      class="book-cover"
                                      loading="lazy"
                                      onerror="const img = document.getElementById('${imageId}'); const pl = document.getElementById('${placeholderId}'); if(img) img.style.display='none'; if(pl) pl.classList.add('show');">
                                  ${createPlaceholderImage(book.title, false, placeholderId)}`;
                } else {
                    coverImage = createPlaceholderImage(book.title, true, placeholderId);
                }

                return `
                    <div class="book-card" role="listitem" data-book-id="${escapeHtml(bookId)}" aria-label="Kitap: ${escapeHtml(book.title)}, Yazar: ${escapeHtml(book.author)}">
                        <button class="favorite-btn ${favoriteClass}"
                                id="${favoriteId}"
                                onclick="toggleFavorite(${index}, false, event)"
                                aria-label="${isFav ? 'Favorilerden çıkar' : 'Favorilere ekle'}"
                                title="${isFav ? 'Favorilerden çıkar' : 'Favorilere ekle'}">
                            ${favoriteIcon}
                        </button>
                        ${coverImage}
                        <div class="book-info">
                            <div class="book-title">${escapeHtml(book.title)}</div>
                            <div class="book-author">${escapeHtml(book.author)}</div>
                            <div class="book-year">${escapeHtml(book.year || 'Bilinmiyor')}${book.publisher ? ` • ${escapeHtml(book.publisher)}` : ''}</div>
                            <div class="book-summary">${escapeHtml(book.summary || '')}</div>
                            <div class="purchase-links" role="group" aria-label="Satın alma bağlantıları">
                                ${links.drLink ? `<a href="${links.drLink}" target="_blank" rel="noopener noreferrer" class="purchase-link dr-link" aria-label="D&R'da ${escapeHtml(book.title)} kitabını satın al">D&R</a>` : ''}
                                ${links.bkmLink ? `<a href="${links.bkmLink}" target="_blank" rel="noopener noreferrer" class="purchase-link bkm-link" aria-label="BKM Kitap'ta ${escapeHtml(book.title)} kitabını satın al">BKM</a>` : ''}
                                ${links.kitapyurduLink ? `<a href="${links.kitapyurduLink}" target="_blank" rel="noopener noreferrer" class="purchase-link kitapyurdu-link" aria-label="Kitapyurdu'nda ${escapeHtml(book.title)} kitabını satın al">Kitapyurdu</a>` : ''}
                                ${links.hepsiburadaLink ? `<a href="${links.hepsiburadaLink}" target="_blank" rel="noopener noreferrer" class="purchase-link hepsiburada-link" aria-label="Hepsiburada'da ${escapeHtml(book.title)} kitabını satın al">Hepsiburada</a>` : ''}
                                ${links.trendyolLink ? `<a href="${links.trendyolLink}" target="_blank" rel="noopener noreferrer" class="purchase-link trendyol-link" aria-label="Trendyol'da ${escapeHtml(book.title)} kitabını satın al">Trendyol</a>` : ''}
                                ${links.amazonLink ? `<a href="${links.amazonLink}" target="_blank" rel="noopener noreferrer" class="purchase-link amazon-link" aria-label="Amazon'da ${escapeHtml(book.title)} kitabını satın al">Amazon</a>` : ''}
                            </div>
                            <button class="price-compare-btn" data-book-title="${escapeHtml(book.title)}" data-book-author="${escapeHtml(book.author)}">💰 Fiyat Karşılaştır</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Keşfet / Önerilen Kitaplar fonksiyonu
        function renderDiscoverBooks() {
            const resultsNormal = document.getElementById('results-normal');
            if (!resultsNormal) return;

            // Container'ları yönet: Normal göster, diğerlerini gizle
            const resultsRandom = document.getElementById('results-random');
            const resultsTrend = document.getElementById('results-trend');

            if (resultsNormal) resultsNormal.style.display = 'block';
            if (resultsRandom) resultsRandom.style.display = 'none';
            if (resultsTrend) resultsTrend.style.display = 'none';

            // DISCOVER_BOOKS dizisindeki kitapları göster
            // displayResults fonksiyonunu kullanarak mevcut kart yapısını kullan
            displayResults(DISCOVER_BOOKS);
            currentBooks = DISCOVER_BOOKS; // currentBooks'u güncelle (rastgele kitap için)
        }

        // Trend Rafı fonksiyonları - Genişletilmiş Kitap Havuzu
        const TREND_BOOK_POOL = [
            // === TÜRK EDEBİYATI - ROMANLAR ===
            { title: "Yırtıcı Kuşlar Zamanı", author: "Ahmet Ümit", category: "Türk Roman", year: "2023", summary: "Polisiye türünde çağdaş bir roman." },
            { title: "Tutunamayanlar", author: "Oğuz Atay", category: "Türk Roman", year: "1972", summary: "Türk edebiyatının başyapıtlarından." },
            { title: "Saatleri Ayarlama Enstitüsü", author: "Ahmet Hamdi Tanpınar", category: "Türk Roman", year: "1961", summary: "Zaman ve modernleşme üzerine derin bir eser." },
            { title: "Kürk Mantolu Madonna", author: "Sabahattin Ali", category: "Türk Roman", year: "1943", summary: "Aşk ve toplum üzerine klasik bir roman." },
            { title: "İnce Memed", author: "Yaşar Kemal", category: "Türk Roman", year: "1955", summary: "Anadolu'nun destansı hikayesi." },
            { title: "Huzur", author: "Ahmet Hamdi Tanpınar", category: "Türk Roman", year: "1949", summary: "İstanbul'un ruhunu anlatan başyapıt." },
            { title: "Puslu Kıtalar Atlası", author: "İhsan Oktay Anar", category: "Türk Roman", year: "1995", summary: "Fantastik ve postmodern bir eser." },
            { title: "Benim Adım Kırmızı", author: "Orhan Pamuk", category: "Türk Roman", year: "1998", summary: "Nobel ödüllü yazarın başyapıtı." },
            { title: "Masumiyet Müzesi", author: "Orhan Pamuk", category: "Türk Roman", year: "2008", summary: "Aşk ve nostalji dolu bir İstanbul hikayesi." },
            { title: "Kar", author: "Orhan Pamuk", category: "Türk Roman", year: "2002", summary: "Kars'ta geçen politik ve felsefi roman." },
            { title: "Çalıkuşu", author: "Reşat Nuri Güntekin", category: "Türk Roman", year: "1922", summary: "Feride'nin Anadolu'daki yaşamı." },
            { title: "Aşk-ı Memnu", author: "Halit Ziya Uşaklıgil", category: "Türk Roman", year: "1900", summary: "Türk edebiyatının ilk modern romanı." },
            { title: "Mai ve Siyah", author: "Halit Ziya Uşaklıgil", category: "Türk Roman", year: "1897", summary: "Romantizm ve realizm arasında bir genç." },
            { title: "Yaban", author: "Yakup Kadri Karaosmanoğlu", category: "Türk Roman", year: "1932", summary: "Kurtuluş Savaşı döneminde bir aydın." },
            { title: "Sinekli Bakkal", author: "Halide Edib Adıvar", category: "Türk Roman", year: "1936", summary: "İstanbul'un bir mahallesi ve sakinleri." },
            { title: "Aylak Adam", author: "Yusuf Atılgan", category: "Türk Roman", year: "1959", summary: "Varoluşçu bir başyapıt." },
            { title: "Anayurt Oteli", author: "Yusuf Atılgan", category: "Türk Roman", year: "1973", summary: "Psikolojik gerilim dolu bir roman." },
            { title: "Beyaz Kale", author: "Orhan Pamuk", category: "Türk Roman", year: "1985", summary: "Kimlik ve benlik üzerine tarihsel roman." },
            { title: "Tehlikeli Oyunlar", author: "Oğuz Atay", category: "Türk Roman", year: "1973", summary: "Aydın bireyin bunalımı." },
            { title: "Kuyucaklı Yusuf", author: "Sabahattin Ali", category: "Türk Roman", year: "1937", summary: "Toplumsal eleştiri içeren roman." },
            { title: "Serenad", author: "Zülfü Livaneli", category: "Türk Roman", year: "2011", summary: "İstanbul ve Selanik'te geçen epik bir hikaye." },
            { title: "Bliss", author: "Zülfü Livaneli", category: "Türk Roman", year: "2002", summary: "Namus cinayeti ve kurtuluş hikayesi." },
            { title: "Sultanın Korsanları", author: "Emrah Safa Gürkan", category: "Türk Roman", year: "2022", summary: "Osmanlı denizcilerinin destanı." },
            { title: "Kafamda Bir Tuhaflık", author: "Orhan Pamuk", category: "Türk Roman", year: "2014", summary: "Boza satıcısı Mevlüt'ün hayatı." },
            
            // === TÜRK EDEBİYATI - ŞİİR ===
            { title: "Hasretinden Prangalar Eskittim", author: "Ahmed Arif", category: "Türk Şiir", year: "1968", summary: "Türk şiirinin en etkileyici seslerinden." },
            { title: "Sevda Sözleri", author: "Cemal Süreya", category: "Türk Şiir", year: "1984", summary: "Aşk ve sevda üzerine şiirler." },
            { title: "Göğe Bakma Durağı", author: "Turgut Uyar", category: "Türk Şiir", year: "1958", summary: "İkinci Yeni akımının önemli eseri." },
            { title: "Otuz Beş Yaş", author: "Cahit Sıtkı Tarancı", category: "Türk Şiir", year: "1946", summary: "Yaşamın geçiciliği üzerine şiirler." },
            { title: "Sabahattin Ali Şiirleri", author: "Sabahattin Ali", category: "Türk Şiir", year: "1940", summary: "Toplumcu şiirin önemli örnekleri." },
            { title: "Ben Sana Mecburum", author: "Attila İlhan", category: "Türk Şiir", year: "1960", summary: "Aşk şiirlerinin başyapıtı." },
            { title: "Kendi Gök Kubbem", author: "Yahya Kemal Beyatlı", category: "Türk Şiir", year: "1961", summary: "İstanbul ve tarih şiirleri." },
            { title: "Şiirler", author: "Nazım Hikmet", category: "Türk Şiir", year: "1950", summary: "Dünya çapında ünlü Türk şairi." },
            { title: "Yaşadıklarımdan Öğrendiğim Bir Şey Var", author: "Orhan Veli Kanık", category: "Türk Şiir", year: "1945", summary: "Garip akımının öncüsü." },
            
            // === DÜNYA EDEBİYATI - KLASİKLER ===
            { title: "Suç ve Ceza", author: "Fyodor Dostoyevski", category: "Dünya Klasik", year: "1866", summary: "Vicdan ve suçluluk üzerine başyapıt." },
            { title: "Karamazov Kardeşler", author: "Fyodor Dostoyevski", category: "Dünya Klasik", year: "1880", summary: "Dostoyevski'nin son ve en büyük eseri." },
            { title: "Anna Karenina", author: "Lev Tolstoy", category: "Dünya Klasik", year: "1877", summary: "Aşk, aile ve toplum üzerine epik roman." },
            { title: "Savaş ve Barış", author: "Lev Tolstoy", category: "Dünya Klasik", year: "1869", summary: "Rus edebiyatının destansı eseri." },
            { title: "1984", author: "George Orwell", category: "Dünya Klasik", year: "1949", summary: "Distopik edebiyatın başyapıtı." },
            { title: "Hayvan Çiftliği", author: "George Orwell", category: "Dünya Klasik", year: "1945", summary: "Politik hiciv dolu bir alegori." },
            { title: "Yüzüklerin Efendisi", author: "J.R.R. Tolkien", category: "Dünya Klasik", year: "1954", summary: "Fantastik edebiyatın zirvesi." },
            { title: "Küçük Prens", author: "Antoine de Saint-Exupéry", category: "Dünya Klasik", year: "1943", summary: "Tüm zamanların en sevilen kitabı." },
            { title: "Don Kişot", author: "Miguel de Cervantes", category: "Dünya Klasik", year: "1605", summary: "İlk modern roman olarak kabul edilir." },
            { title: "Sefiller", author: "Victor Hugo", category: "Dünya Klasik", year: "1862", summary: "Adalet ve merhamet üzerine epik eser." },
            { title: "Monte Cristo Kontu", author: "Alexandre Dumas", category: "Dünya Klasik", year: "1844", summary: "İntikam ve kurtuluşun destanı." },
            { title: "Bülbülü Öldürmek", author: "Harper Lee", category: "Dünya Klasik", year: "1960", summary: "Irkçılık ve adalet üzerine başyapıt." },
            { title: "Fahrenheit 451", author: "Ray Bradbury", category: "Dünya Klasik", year: "1953", summary: "Kitapların yakıldığı bir dünya." },
            { title: "Cesur Yeni Dünya", author: "Aldous Huxley", category: "Dünya Klasik", year: "1932", summary: "Distopik toplum eleştirisi." },
            { title: "Simyacı", author: "Paulo Coelho", category: "Dünya Klasik", year: "1988", summary: "Kişisel efsane arayışı." },
            
            // === DÜNYA EDEBİYATI - MODERN ===
            { title: "Gece Yarısı Kütüphanesi", author: "Matt Haig", category: "Dünya Modern", year: "2020", summary: "Paralel hayatları keşfeden bir hikaye." },
            { title: "Intermezzo", author: "Sally Rooney", category: "Dünya Modern", year: "2024", summary: "Modern ilişkileri anlatan çağdaş roman." },
            { title: "Hyunam-Dong Kitabevi", author: "Hwang Bo-Reum", category: "Dünya Modern", year: "2022", summary: "Bir kitapçının sakin yaşamını anlatan roman." },
            { title: "Atomik Alışkanlıklar", author: "James Clear", category: "Kişisel Gelişim", year: "2018", summary: "Küçük değişikliklerle büyük sonuçlar." },
            { title: "Bin Muhteşem Güneş", author: "Khaled Hosseini", category: "Dünya Modern", year: "2007", summary: "Afganistan'da iki kadının hikayesi." },
            { title: "Uçurtma Avcısı", author: "Khaled Hosseini", category: "Dünya Modern", year: "2003", summary: "Dostluk, ihanet ve kurtuluş." },
            { title: "Yaşamak", author: "Yu Hua", category: "Dünya Modern", year: "1993", summary: "Modern Çin edebiyatının klasik eseri." },
            { title: "Algernon'a Çiçekler", author: "Daniel Keyes", category: "Dünya Modern", year: "1959", summary: "Zeka ve insanlık üzerine." },
            { title: "Vejeteryan", author: "Han Kang", category: "Dünya Modern", year: "2007", summary: "Nobel ödüllü yazarın etkileyici eseri." },
            { title: "İnsan Neyle Yaşar", author: "Han Kang", category: "Dünya Modern", year: "2021", summary: "Acı ve hafıza üzerine." },
            { title: "Normal İnsanlar", author: "Sally Rooney", category: "Dünya Modern", year: "2018", summary: "Gençlik ve aşk üzerine modern roman." },
            { title: "Bir Ada Hikayesi", author: "Elif Shafak", category: "Dünya Modern", year: "2021", summary: "Kıbrıs'ta geçen etkileyici hikaye." },
            { title: "Aşk", author: "Elif Shafak", category: "Dünya Modern", year: "2009", summary: "Mevlana'nın hayatı etrafında örülü roman." },
            { title: "Şeker Portakalı", author: "José Mauro de Vasconcelos", category: "Dünya Modern", year: "1968", summary: "Çocukluğun masum hikayesi." },
            { title: "Dönüşüm", author: "Franz Kafka", category: "Dünya Modern", year: "1915", summary: "Absürt edebiyatın başyapıtı." },
            { title: "Yabancı", author: "Albert Camus", category: "Dünya Modern", year: "1942", summary: "Varoluşçu felsefenin roman hali." },
            { title: "Veba", author: "Albert Camus", category: "Dünya Modern", year: "1947", summary: "İnsanlık durumu üzerine alegorik eser." },
            { title: "Dune", author: "Frank Herbert", category: "Dünya Modern", year: "1965", summary: "Bilimkurgunun en büyük destanı." },
            { title: "Sapiens", author: "Yuval Noah Harari", category: "Kişisel Gelişim", year: "2011", summary: "İnsanlık tarihinin kısa hikayesi." },
            { title: "İkigai", author: "Héctor García", category: "Kişisel Gelişim", year: "2016", summary: "Japon yaşam felsefesi." },
            { title: "Bağımsız Düşünme Sanatı", author: "Shane Snow", category: "Kişisel Gelişim", year: "2019", summary: "Farklı düşünme teknikleri." },
            { title: "Sessizliğin Gücü", author: "Thich Nhat Hanh", category: "Kişisel Gelişim", year: "2015", summary: "Farkındalık ve huzur üzerine." },
            { title: "Homo Deus", author: "Yuval Noah Harari", category: "Kişisel Gelişim", year: "2015", summary: "İnsanlığın geleceği üzerine." },
            { title: "21. Yüzyıl İçin 21 Ders", author: "Yuval Noah Harari", category: "Kişisel Gelişim", year: "2018", summary: "Günümüz dünyasını anlamak için." },
            
            // === DÜNYA EDEBİYATI - POPÜLER ===
            { title: "Harry Potter ve Felsefe Taşı", author: "J.K. Rowling", category: "Dünya Popüler", year: "1997", summary: "Sihirli dünyanın kapıları açılıyor." },
            { title: "Açlık Oyunları", author: "Suzanne Collins", category: "Dünya Popüler", year: "2008", summary: "Distopik gençlik edebiyatının zirvesi." },
            { title: "Alacakaranlık", author: "Stephenie Meyer", category: "Dünya Popüler", year: "2005", summary: "Vampir aşkının başlangıcı." },
            { title: "Da Vinci Şifresi", author: "Dan Brown", category: "Dünya Popüler", year: "2003", summary: "Gerilim ve gizem dolu macera." },
            { title: "Melekler ve Şeytanlar", author: "Dan Brown", category: "Dünya Popüler", year: "2000", summary: "Vatikan'da geçen heyecanlı macera." },
            { title: "Sherlock Holmes", author: "Arthur Conan Doyle", category: "Dünya Popüler", year: "1887", summary: "Dedektif edebiyatının başyapıtı." },
            { title: "Agatha Christie Seçkisi", author: "Agatha Christie", category: "Dünya Popüler", year: "1920", summary: "Polisiye edebiyatının kraliçesi." },
            { title: "Hobbit", author: "J.R.R. Tolkien", category: "Dünya Popüler", year: "1937", summary: "Orta Dünya'ya giriş." },
            { title: "Narnia Günlükleri", author: "C.S. Lewis", category: "Dünya Popüler", year: "1950", summary: "Büyülü bir dünyanın kapıları." },
            { title: "Günlüğe Yazılanlar", author: "Anne Frank", category: "Dünya Popüler", year: "1947", summary: "Savaşın en dokunaklı tanıklığı." }
        ];

        const TREND_QUOTES = [
            // Genel kitap sözleri
            "İyi bir kitap, tekrar tekrar açılabilen bir hediyedir.",
            "Bir sayfa, bazen bir ömürden daha çok şey anlatır.",
            "Okudukça hayat büyümez, sen büyürsün.",
            "Kitaplar, başkalarının kalbinden yazılmış haritalardır.",
            "Bir kütüphane, zamanın içinden açılan sessiz bir kapıdır.",
            "Kitap okumak, bin yıl yaşamaktır.",
            "Her kitap, yeni bir dünyaya açılan kapıdır.",
            "Okumak, ruhun yolculuğudur.",
            "Kitaplar sessiz ama güçlü dostlardır.",
            "Bir kitabı bitirmek, bir dostla vedalaşmak gibidir.",
            
            // Ünlü yazarlardan
            "Okuyan bir insan, iki hayat yaşar. — Umberto Eco",
            "Kitaplar, ruhun ilacıdır. — Antik Yunan atasözü",
            "Bir oda kitapsızsa, ruhsuz bir beden gibidir. — Cicero",
            "Kitap, sessiz bir öğretmendir. — Aulus Gellius",
            "Okumak, başka birinin düşüncesiyle düşünmektir. — Arthur Schopenhauer",
            "Bazı kitaplar tadılmalı, bazıları yutulmalı, çok azı ise çiğnenip sindirilmelidir. — Francis Bacon",
            "Kitaplar gemilerin taşıyamadığı yükleri taşır. — Emily Dickinson",
            "Okuduğum iyi kitapların sayısı kadar zenginim. — Henry David Thoreau",
            
            // Türk yazarlardan
            "İnsan okumalı, ama yaşamak için okumalı. — Sabahattin Ali",
            "Kitap, insanın içine açılan penceredir. — Yaşar Kemal",
            "Her kitap, binlerce yılın birikimidir. — Cemil Meriç",
            "Okumak, düşünmenin ta kendisidir. — Ahmet Hamdi Tanpınar",
            "Bir kitap bazen bir ömre bedeldir. — Oğuz Atay",
            "Kelimeler, insanı insan yapan tek şeydir. — Nazım Hikmet",
            
            // Dünya edebiyatından
            "Bir kitabı okumak, başka bir hayatı yaşamaktır. — Jorge Luis Borges",
            "Kitaplar, ölümsüzlüğün kanıtıdır. — Carl Sagan",
            "İyi edebiyat, insanlığın aynasıdır. — Virginia Woolf",
            "Her yeni kitap, yeni bir yolculuktur. — Paulo Coelho",
            "Kitaplar, en sadık arkadaşlardır. — Ernest Hemingway",
            "Bir roman, hayatın yoğunlaştırılmış halidir. — Milan Kundera",
            
            // İlham verici
            "Bugün okuduğun bir satır, yarın hayatını değiştirebilir.",
            "Kitaplar düşündürür, düşünce özgürleştirir.",
            "Her okunan sayfa, zihnine eklenen bir tuğladır.",
            "Okumak, sessiz bir devrimdir.",
            "En güzel yolculuklar, sayfalarda yapılır.",
            "Bir kitap, zamana meydan okuyan bir sestir.",
            "Okuyan göz, gören kalpten gelir.",
            "Kitaplar ölmez, sadece yeni okuyucularını bekler.",
            
            // Şiirsel
            "Harfler sessiz, kelimeler gürültülü, kitaplar ise sonsuz.",
            "Bir kitabın kokusu, düşüncelerin parfümüdür.",
            "Sayfalar döndükçe, ruh yenilenir.",
            "Her kitap, yazarının kalp atışıdır.",
            "Kelimeler akar, fikirler kalır.",
            "Okumak, kendi sesini başka seslerde bulmaktır."
        ];

        // 12 saatlik periyot hesaplama (Sabah/Akşam)
        function getTrendPeriod() {
            const now = new Date();
            const today = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const hour = now.getHours();
            // Sabah periyodu: 00:00-11:59, Akşam periyodu: 12:00-23:59
            const period = hour < 12 ? 'morning' : 'evening';
            return `${today}_${period}`;
        }

        // Gösterilen kitapları takip et
        function getShownBooks() {
            try {
                const stored = localStorage.getItem('trendShownBooks_v2');
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                return [];
            }
        }

        function setShownBooks(books) {
            try {
                localStorage.setItem('trendShownBooks_v2', JSON.stringify(books));
            } catch (e) {
                console.error('Gösterilen kitaplar kaydedilirken hata:', e);
            }
        }

        function getTrendData() {
            try {
                const stored = localStorage.getItem('trendData_v2');
                if (stored) {
                    return JSON.parse(stored);
                }
            } catch (e) {
                console.error('Trend verisi yüklenirken hata:', e);
            }
            return null;
        }

        function setTrendData(data) {
            try {
                localStorage.setItem('trendData_v2', JSON.stringify(data));
                // Android tarafına da gönder
                if (window.AndroidBridge && typeof AndroidBridge.saveTrendData === 'function') {
                    AndroidBridge.saveTrendData(JSON.stringify(data));
                }
            } catch (e) {
                console.error('Trend verisi kaydedilirken hata:', e);
            }
        }

        // API'den popüler kitapları çek
        async function fetchTrendingBooks() {
            const trendingSearchTerms = [
                // Türk Edebiyatı - Romanlar (subject:fiction kullanarak)
                { query: 'subject:fiction inauthor:orhan pamuk', lang: 'tr', category: 'Türk Roman' },
                { query: 'subject:fiction inauthor:zülfü livaneli', lang: 'tr', category: 'Türk Roman' },
                { query: 'subject:fiction inauthor:ahmet ümit', lang: 'tr', category: 'Türk Roman' },
                { query: 'subject:fiction inauthor:sabahattin ali', lang: 'tr', category: 'Türk Roman' },
                { query: 'subject:fiction inauthor:yaşar kemal', lang: 'tr', category: 'Türk Roman' },
                { query: 'subject:fiction inauthor:oğuz atay', lang: 'tr', category: 'Türk Roman' },
                // Türk Edebiyatı - Şiir
                { query: 'subject:poetry inauthor:nazım hikmet', lang: 'tr', category: 'Türk Şiir' },
                { query: 'subject:poetry inauthor:cemal süreya', lang: 'tr', category: 'Türk Şiir' },
                { query: 'subject:poetry inauthor:attila ilhan', lang: 'tr', category: 'Türk Şiir' },
                { query: 'subject:poetry inauthor:ahmed arif', lang: 'tr', category: 'Türk Şiir' },
                // Dünya Edebiyatı - Romanlar
                { query: 'subject:fiction inauthor:dostoevsky', lang: '', category: 'Dünya Roman' },
                { query: 'subject:fiction inauthor:tolstoy', lang: '', category: 'Dünya Roman' },
                { query: 'subject:fiction inauthor:kafka', lang: '', category: 'Dünya Roman' },
                { query: 'subject:fiction inauthor:hemingway', lang: '', category: 'Dünya Roman' },
                { query: 'subject:fiction inauthor:gabriel garcia marquez', lang: '', category: 'Dünya Roman' },
                { query: 'subject:fiction inauthor:haruki murakami', lang: '', category: 'Dünya Roman' },
                { query: 'subject:fiction booker prize winner', lang: '', category: 'Dünya Roman' },
                // Dünya Edebiyatı - Şiir
                { query: 'subject:poetry inauthor:rumi', lang: '', category: 'Dünya Şiir' },
                { query: 'subject:poetry inauthor:neruda', lang: '', category: 'Dünya Şiir' },
                { query: 'subject:poetry inauthor:shakespeare sonnets', lang: '', category: 'Dünya Şiir' }
            ];
            
            // İnceleme, dergi vb. filtreleme için yasaklı kelimeler
            const excludedTerms = [
                'dergi', 'magazine', 'journal', 'review', 'inceleme', 'analiz',
                'eleştiri', 'critique', 'study', 'analysis', 'guide', 'rehber',
                'sözlük', 'dictionary', 'encyclopedia', 'ansiklopedi', 'handbook',
                'textbook', 'ders kitabı', 'workbook', 'çalışma kitabı', 'anthology',
                'antoloji', 'collection of essays', 'deneme', 'makale', 'article'
            ];

            // Günün periyoduna göre farklı arama terimleri seç (karışık Türk + Dünya)
            const hour = new Date().getHours();
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const periodSeed = dayOfYear * 2 + (hour < 12 ? 0 : 1);
            
            // Türk edebiyatı terimleri (roman + şiir)
            const turkTerms = trendingSearchTerms.filter(t => t.lang === 'tr');
            // Dünya edebiyatı terimleri (roman + şiir)
            const dunyaTerms = trendingSearchTerms.filter(t => t.lang === '');
            
            // Her periyotta 1 Türk + 1 Dünya terimi seç
            const turkTerm = turkTerms[periodSeed % turkTerms.length];
            const dunyaTerm = dunyaTerms[periodSeed % dunyaTerms.length];
            
            const allBooks = [];
            
            // Kitabın roman/şiir olup olmadığını kontrol et (dergi, inceleme vb. değil)
            function isValidBook(info) {
                if (!info || !info.title || !info.authors || info.authors.length === 0) return false;
                
                const title = (info.title || '').toLowerCase();
                const description = (info.description || '').toLowerCase();
                const categories = (info.categories || []).join(' ').toLowerCase();
                
                // Yasaklı terimleri kontrol et
                for (const term of excludedTerms) {
                    if (title.includes(term) || categories.includes(term)) {
                        return false;
                    }
                }
                
                // Sayfa sayısı kontrolü (çok az sayfalı olanları çıkar - muhtemelen dergi)
                if (info.pageCount && info.pageCount < 50) return false;
                
                // Periyodik yayın kontrolü
                if (info.printType === 'MAGAZINE') return false;
                
                return true;
            }
            
            try {
                // Türk edebiyatından kitap çek
                const turkUrl = `${API_BASE_URL}?q=${encodeURIComponent(turkTerm.query)}&maxResults=20&orderBy=relevance&langRestrict=tr&printType=books`;
                const turkResponse = await fetch(turkUrl);
                
                if (turkResponse.ok) {
                    const turkData = await turkResponse.json();
                    if (turkData.items) {
                        const turkBooks = turkData.items
                            .filter(item => isValidBook(item.volumeInfo))
                            .map(item => {
                                const info = item.volumeInfo;
                                return {
                                    title: info.title,
                                    author: info.authors ? info.authors[0] : 'Bilinmeyen',
                                    year: info.publishedDate ? info.publishedDate.substring(0, 4) : 'Bilinmiyor',
                                    summary: info.description ? truncateSummary(info.description, 180) : `${turkTerm.category} kategorisinde bir eser.`,
                                    thumbnail: info.imageLinks ? (info.imageLinks.thumbnail || info.imageLinks.smallThumbnail) : null,
                                    isbn: info.industryIdentifiers ? info.industryIdentifiers[0]?.identifier : null,
                                    category: turkTerm.category,
                                    rating: info.averageRating || 0,
                                    ratingsCount: info.ratingsCount || 0,
                                    publisher: info.publisher || '',
                                    pageCount: info.pageCount || 0,
                                    source: 'turk'
                                };
                            });
                        allBooks.push(...turkBooks);
                    }
                }
                
                // Dünya edebiyatından kitap çek
                const dunyaUrl = `${API_BASE_URL}?q=${encodeURIComponent(dunyaTerm.query)}&maxResults=20&orderBy=relevance&printType=books`;
                const dunyaResponse = await fetch(dunyaUrl);
                
                if (dunyaResponse.ok) {
                    const dunyaData = await dunyaResponse.json();
                    if (dunyaData.items) {
                        const dunyaBooks = dunyaData.items
                            .filter(item => isValidBook(item.volumeInfo))
                            .map(item => {
                                const info = item.volumeInfo;
                                return {
                                    title: info.title,
                                    author: info.authors ? info.authors[0] : 'Bilinmeyen',
                                    year: info.publishedDate ? info.publishedDate.substring(0, 4) : 'Bilinmiyor',
                                    summary: info.description ? truncateSummary(info.description, 180) : `${dunyaTerm.category} kategorisinde bir eser.`,
                                    thumbnail: info.imageLinks ? (info.imageLinks.thumbnail || info.imageLinks.smallThumbnail) : null,
                                    isbn: info.industryIdentifiers ? info.industryIdentifiers[0]?.identifier : null,
                                    category: dunyaTerm.category,
                                    rating: info.averageRating || 0,
                                    ratingsCount: info.ratingsCount || 0,
                                    publisher: info.publisher || '',
                                    pageCount: info.pageCount || 0,
                                    source: 'dunya'
                                };
                            });
                        allBooks.push(...dunyaBooks);
                    }
                }
                
                if (allBooks.length === 0) {
                    return null;
                }

                // Puanlamaya göre sırala
                allBooks.sort((a, b) => {
                    const scoreA = (a.rating * 100) + (a.ratingsCount * 0.1);
                    const scoreB = (b.rating * 100) + (b.ratingsCount * 0.1);
                    return scoreB - scoreA;
                });

                // Dengeli seçim: 2-3 Türk + 2-3 Dünya
                const turkFiltered = allBooks.filter(b => b.source === 'turk').slice(0, 3);
                const dunyaFiltered = allBooks.filter(b => b.source === 'dunya').slice(0, 3);
                
                let selectedBooks = [];
                // Karışık sıralama: Türk, Dünya, Türk, Dünya...
                const maxLen = Math.max(turkFiltered.length, dunyaFiltered.length);
                for (let i = 0; i < maxLen && selectedBooks.length < 5; i++) {
                    if (turkFiltered[i]) selectedBooks.push(turkFiltered[i]);
                    if (dunyaFiltered[i] && selectedBooks.length < 5) selectedBooks.push(dunyaFiltered[i]);
                }
                
                // Eğer 5'ten az kitap varsa, kalanlardan tamamla
                if (selectedBooks.length < 5) {
                    const remaining = allBooks.filter(b => !selectedBooks.some(s => s.title === b.title));
                    selectedBooks = [...selectedBooks, ...remaining.slice(0, 5 - selectedBooks.length)];
                }

                return selectedBooks.slice(0, 5);
            } catch (error) {
                console.error('Trend kitapları çekilirken hata:', error);
                return null;
            }
        }

        // Yedek olarak sabit havuzdan kitap seç
        function getBackupTrendBooks() {
            const shuffled = [...TREND_BOOK_POOL].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, 5);
        }

        async function initializeTrendData() {
            const currentPeriod = getTrendPeriod(); // "2025-01-15_morning" veya "2025-01-15_evening"
            const existingData = getTrendData();

            // Eğer bu periyodun verisi varsa ve geçerliyse, yeniden oluşturma
            if (existingData && existingData.period === currentPeriod && existingData.books && existingData.books.length > 0) {
                return existingData;
            }

            // API'den popüler kitapları çek
            let selectedBooks = await fetchTrendingBooks();
            
            // API başarısız olursa yedek havuzdan al
            if (!selectedBooks || selectedBooks.length < 5) {
                console.log('API\'den kitap alınamadı, yedek havuz kullanılıyor...');
                selectedBooks = getBackupTrendBooks();
            }

            // Günün sözünü seç
            const randomQuote = TREND_QUOTES[Math.floor(Math.random() * TREND_QUOTES.length)];

            // Trend verisini oluştur
            const trendData = {
                period: currentPeriod,
                date: new Date().toISOString().split('T')[0],
                books: selectedBooks,
                quote: randomQuote,
                source: selectedBooks[0]?.isbn ? 'api' : 'backup'
            };

            // Veriyi kaydet
            setTrendData(trendData);

            return trendData;
        }
        async function renderTrendRaft() {
            const trendData = await initializeTrendData();
            if (!trendData) return;

            // Container'ları yönet: Trend göster, diğerlerini gizle
            const resultsNormal = document.getElementById('results-normal');
            const resultsRandom = document.getElementById('results-random');
            const resultsTrend = document.getElementById('results-trend');

            if (resultsNormal) resultsNormal.style.display = 'none';
            if (resultsRandom) resultsRandom.style.display = 'none';
            if (resultsTrend) resultsTrend.style.display = 'block';

            if (resultsTrend && trendData.books) {
                // Trend kitaplarını results-trend container'ına yaz
                const booksHtml = trendData.books.map((book, index) => {
                    const bookId = book.isbn || `${book.title}_${book.author}`;
                    const isFav = isFavorite(book);
                    const favoriteClass = isFav ? 'active' : '';
                    const favoriteIcon = isFav ? '⭐' : '☆';
                    const links = buildPurchaseLinks(book);

                    let coverImage = '';
                    const placeholderId = `placeholder-trend-${index}`;
                    const imageId = `image-trend-${index}`;
                    const favoriteId = `favorite-trend-${index}`;

                    if (book.thumbnail) {
                        coverImage = `<img id="${imageId}"
                                      src="${book.thumbnail}"
                                      alt="${escapeHtml(book.title)}"
                                      class="book-cover"
                                      loading="lazy"
                                      onerror="const img = document.getElementById('${imageId}'); const pl = document.getElementById('${placeholderId}'); if(img) img.style.display='none'; if(pl) pl.classList.add('show');">
                                  ${createPlaceholderImage(book.title, false, placeholderId)}`;
                    } else {
                        coverImage = createPlaceholderImage(book.title, true, placeholderId);
                    }

                    return `
                    <div class="book-card" role="listitem" data-book-id="${escapeHtml(bookId)}" aria-label="Kitap: ${escapeHtml(book.title)}, Yazar: ${escapeHtml(book.author)}">
                        <button class="favorite-btn ${favoriteClass}"
                                id="${favoriteId}"
                                onclick="toggleFavorite(${index}, false, event)"
                                aria-label="${isFav ? 'Favorilerden çıkar' : 'Favorilere ekle'}"
                                title="${isFav ? 'Favorilerden çıkar' : 'Favorilere ekle'}">
                            ${favoriteIcon}
                        </button>
                        ${coverImage}
                        <div class="book-info">
                            <div class="book-title">${escapeHtml(book.title)}</div>
                            <div class="book-author">Yazar: ${escapeHtml(book.author)}</div>
                            <div class="book-year">Basım Yılı: ${escapeHtml(book.year)}${book.publisher ? ` • Yayınevi: ${escapeHtml(book.publisher)}` : ''}</div>
                            <div class="book-summary">${escapeHtml(book.summary)}</div>
                            <div class="purchase-links" role="group" aria-label="Satın alma linkleri">
                                <a href="${links.drLink}" target="_blank" rel="noopener noreferrer" class="purchase-link dr-link" aria-label="D&R'da ${escapeHtml(book.title)} kitabını satın al">D&R</a>
                                <a href="${links.bkmLink}" target="_blank" rel="noopener noreferrer" class="purchase-link bkm-link" aria-label="BKM Kitap'ta ${escapeHtml(book.title)} kitabını satın al">BKM</a>
                                <a href="${links.kitapyurduLink}" target="_blank" rel="noopener noreferrer" class="purchase-link kitapyurdu-link" aria-label="Kitapyurdu'nda ${escapeHtml(book.title)} kitabını satın al">Kitapyurdu</a>
                                <a href="${links.hepsiburadaLink}" target="_blank" rel="noopener noreferrer" class="purchase-link hepsiburada-link" aria-label="Hepsiburada'da ${escapeHtml(book.title)} kitabını satın al">Hepsiburada</a>
                                <a href="${links.trendyolLink}" target="_blank" rel="noopener noreferrer" class="purchase-link trendyol-link" aria-label="Trendyol'da ${escapeHtml(book.title)} kitabını satın al">Trendyol</a>
                                <a href="${links.amazonLink}" target="_blank" rel="noopener noreferrer" class="purchase-link amazon-link" aria-label="Amazon'da ${escapeHtml(book.title)} kitabını satın al">Amazon</a>
                            </div>
                            <button class="price-compare-btn" data-book-title="${escapeHtml(book.title)}" data-book-author="${escapeHtml(book.author)}">💰 Fiyat Karşılaştır</button>
                        </div>
                    </div>
                    `;
                }).join('');

                // Periyot bilgisini al (Sabah/Akşam)
                const hour = new Date().getHours();
                const periodText = hour < 12 ? '☀️ Sabah Seçkisi' : '🌙 Akşam Seçkisi';

                // Trend başlığı ve kitapları results-trend'e yaz
                const trendHeader = `<div style="background: var(--card-bg, rgba(255, 255, 255, 0.1)); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <h2 style="color: var(--text-primary, white); font-size: 1.5em; margin-bottom: 10px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">🔥 Trend Rafı — ${periodText}</h2>
                    <div id="trendQuote" style="color: var(--text-primary, white); font-size: 1.1em; font-style: italic; text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                        <div style="margin-bottom: 8px;">📚</div>
                        <div id="trendQuoteText">${trendData.quote || 'Günün sözü yükleniyor...'}</div>
                    </div>
                </div>`;
                resultsTrend.innerHTML = trendHeader + booksHtml;
                
                // Trend Rafı fiyat karşılaştırma butonlarına event listener ekle
                resultsTrend.querySelectorAll('.price-compare-btn').forEach(btn => {
                    const title = btn.getAttribute('data-book-title');
                    const author = btn.getAttribute('data-book-author');
                    if (title && trendData.books) {
                        const book = trendData.books.find(b => b.title === title && b.author === author);
                        if (book) {
                            const links = buildPurchaseLinks(book);
                            btn.onclick = () => showPriceModal(book, links);
                        }
                    }
                });
            }
        }

        // Blog açma fonksiyonu - Android uygulamasının içinden
        function openBlog() {
            window.location.href = 'blog/index.html';
        }

        async function openTrendSection() {
            // Yükleniyor göster
            const resultsTrend = document.getElementById('results-trend');
            const resultsNormal = document.getElementById('results-normal');
            const resultsRandom = document.getElementById('results-random');
            
            if (resultsNormal) resultsNormal.style.display = 'none';
            if (resultsRandom) resultsRandom.style.display = 'none';
            if (resultsTrend) {
                resultsTrend.style.display = 'block';
                resultsTrend.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-primary, white);"><div style="font-size: 2em; margin-bottom: 15px;">🔄</div><div>Popüler kitaplar yükleniyor...</div></div>';
            }

            // Trend Rafı bölümünü göster
            await renderTrendRaft();

            // Trend Rafı bölümüne kaydır
            if (resultsTrend) {
                resultsTrend.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Favorileri yönetme fonksiyonları
        function getFavorites() {
            const favorites = localStorage.getItem(FAVORITES_STORAGE_KEY);
            return favorites ? JSON.parse(favorites) : [];
        }

        function saveFavorites(favorites) {
            localStorage.setItem(FAVORITES_STORAGE_KEY, JSON.stringify(favorites));
            updateFavoritesCount();
        }

        function addToFavorites(book) {
            const favorites = getFavorites();
            // Aynı kitabı kontrol et (ISBN veya başlık + yazar kombinasyonu ile)
            const bookId = book.isbn || `${book.title}_${book.author}`;
            const exists = favorites.some(fav => {
                const favId = fav.isbn || `${fav.title}_${fav.author}`;
                return favId === bookId;
            });

            if (!exists) {
                favorites.push(book);
                saveFavorites(favorites);
                return true;
            }
            return false;
        }

        function removeFromFavorites(book) {
            const favorites = getFavorites();
            const bookId = book.isbn || `${book.title}_${book.author}`;
            const filtered = favorites.filter(fav => {
                const favId = fav.isbn || `${fav.title}_${fav.author}`;
                return favId !== bookId;
            });
            saveFavorites(filtered);
        }

        function isFavorite(book) {
            const favorites = getFavorites();
            const bookId = book.isbn || `${book.title}_${book.author}`;
            return favorites.some(fav => {
                const favId = fav.isbn || `${fav.title}_${fav.author}`;
                return favId === bookId;
            });
        }

        function updateFavoritesCount() {
            const favorites = getFavorites();
            const countElement = document.getElementById('favoritesCount');
            if (countElement) {
                countElement.textContent = favorites.length;
            }
        }

        function showFavorites() {
            // Modal olarak aç
            openFavoritesModal();
        }

        function openFavoritesModal() {
            const modal = document.getElementById('favoritesModal');
            modal.classList.add('active');
            displayFavoritesInModal();
        }

        function closeFavoritesModal() {
            const modal = document.getElementById('favoritesModal');
            modal.classList.remove('active');
        }

        // Modal dışına tıklandığında kapat
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('favoritesModal');
            if (e.target === modal) {
                closeFavoritesModal();
            }
        });

        function showSearch() {
            document.getElementById('favoritesView').classList.remove('active');
            document.getElementById('searchView').classList.add('active');
        }

        function displayFavorites() {
            const favorites = getFavorites();
            const favoritesContainer = document.getElementById('favoritesContainer');

            if (favorites.length === 0) {
                favoritesContainer.innerHTML = '<div class="empty-favorites" role="status" aria-live="polite">Henüz favori kitabınız yok.<br><small>Favorilere eklemek için kitapların yanındaki ⭐ butonuna tıklayın.</small></div>';
                currentBooks = [];
                return;
            }

            currentBooks = favorites; // Favorileri sakla (toggleFavorite için)
            displayResults(favorites, true);
        }

        function displayFavoritesInModal() {
            const favorites = getFavorites();
            const favoritesContainer = document.getElementById('favoritesModalContainer');

            if (favorites.length === 0) {
                favoritesContainer.innerHTML = '<div class="empty-favorites" style="color: #333; background: #f8f9fa;" role="status" aria-live="polite">Henüz favori kitabınız yok.<br><small>Favorilere eklemek için kitapların yanındaki ⭐ butonuna tıklayın.</small></div>';
                currentBooks = [];
                return;
            }

            currentBooks = favorites;
            displayResultsWithPrices(favorites);
        }

        function setFilter(filter, buttonElement) {
            currentFilter = filter;
            // Tüm butonlardan active class'ını kaldır ve aria-pressed'i false yap
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
                // aria-label'dan "(seçili)" kısmını kaldır
                const currentLabel = btn.getAttribute('aria-label');
                if (currentLabel && currentLabel.includes('(seçili)')) {
                    btn.setAttribute('aria-label', currentLabel.replace(' (seçili)', ''));
                }
            });
            // Tıklanan butona active class'ını ekle ve aria-pressed'i true yap
            if (buttonElement) {
                buttonElement.classList.add('active');
                buttonElement.setAttribute('aria-pressed', 'true');
                // aria-label'a "(seçili)" ekle
                const currentLabel = buttonElement.getAttribute('aria-label');
                if (currentLabel && !currentLabel.includes('(seçili)')) {
                    buttonElement.setAttribute('aria-label', currentLabel + ' (seçili)');
                }
            }

            // Eğer arama terimi varsa otomatik olarak arama yap
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim()) {
                // Kısa bir gecikme ile arama yap (UI güncellemesi için)
                setTimeout(() => {
                    searchBooks();
                }, 100);
            }
        }

        function isTestBook(title, description) {
            // Daha kapsamlı test kitabı anahtar kelimeleri
            const testKeywords = [
                'test', 'soru bankası', 'soru bankasi', 'soru bankası',
                'sınav', 'sinav', 'yks', 'tyt', 'ayt', 'lys', 'msü', 'msu',
                'konu anlatımlı', 'konu anlatimli', 'konu anlatimi',
                'çözümlü', 'cozumlu', 'çözüm', 'cozum',
                'deneme', 'deneme sınavı', 'deneme sinavi',
                'özet', 'ozet', 'özet kitap', 'ozet kitap',
                'hazırlık', 'hazirlik', 'hazırlık kitabı', 'hazirlik kitabi',
                'çalışma kitabı', 'calisma kitabi', 'workbook',
                'alıştırma', 'alistirma', 'practice',
                'final', 'vize', 'quiz', 'sınav hazırlık', 'sinav hazirlik'
            ];
            const searchText = (title + ' ' + (description || '')).toLowerCase();
            // Türkçe karakterleri normalize et
            const normalizedText = searchText
                .replace(/ı/g, 'i').replace(/İ/g, 'I')
                .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                .replace(/ş/g, 's').replace(/Ş/g, 'S')
                .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                .replace(/ç/g, 'c').replace(/Ç/g, 'C');

            return testKeywords.some(keyword => {
                const normalizedKeyword = keyword.toLowerCase()
                    .replace(/ı/g, 'i').replace(/İ/g, 'I')
                    .replace(/ğ/g, 'g').replace(/Ğ/g, 'G')
                    .replace(/ü/g, 'u').replace(/Ü/g, 'U')
                    .replace(/ş/g, 's').replace(/Ş/g, 'S')
                    .replace(/ö/g, 'o').replace(/Ö/g, 'O')
                    .replace(/ç/g, 'c').replace(/Ç/g, 'C');
                return normalizedText.includes(normalizedKeyword);
            });
        }

        function isValidBook(title, author, description) {
            // Başlık kontrolü
            if (!title || title.trim().length === 0) {
                return false;
            }

            const titleLower = title.toLowerCase().trim();

            // Geçersiz başlıklar
            const invalidTitles = [
                'başlık bulunamadı',
                'undefined',
                'null',
                'none',
                'n/a',
                'no title',
                'untitled'
            ];

            if (invalidTitles.some(invalid => titleLower === invalid)) {
                return false;
            }

            // Çok kısa başlıklar (1 karakterden az)
            if (title.trim().length < 2) {
                return false;
            }

            // Sadece özel karakterler veya sayılar içeren başlıklar
            const onlySpecialChars = /^[^a-zA-ZçğıöşüÇĞIİÖŞÜ0-9]+$/g.test(title);
            if (onlySpecialChars) {
                return false;
            }

            // Çok fazla özel karakter içeren başlıklar (%50'den fazla)
            const specialCharCount = (title.match(/[^a-zA-ZçğıöşüÇĞIİÖŞÜ0-9\s]/g) || []).length;
            const specialCharRatio = specialCharCount / title.length;
            if (specialCharRatio > 0.5) {
                return false;
            }

            // URL içeren başlıklar
            if (/https?:\/\//i.test(title) || /www\./i.test(title)) {
                return false;
            }

            // Yazar kontrolü - "Yazar bilgisi yok" gibi geçersiz yazarları filtrele
            if (author && author.toLowerCase().includes('yazar bilgisi yok')) {
                // Yazar yoksa ama başlık geçerliyse kabul et
                // Sadece başlık çok garipse reddet
            }

            // Çok uzun başlıklar (200 karakterden fazla) genelde hatalı veri
            if (title.length > 200) {
                return false;
            }

            // En az bir harf içermeli
            if (!/[a-zA-ZçğıöşüÇĞIİÖŞÜ]/.test(title)) {
                return false;
            }

            return true;
        }

        function normalizeTextForSearch(text) {
            return (text || '')
                .toString()
                .toLowerCase()
                .replace(/ı/g, 'i')
                .replace(/İ/g, 'i')
                .replace(/ğ/g, 'g')
                .replace(/Ğ/g, 'g')
                .replace(/ü/g, 'u')
                .replace(/Ü/g, 'u')
                .replace(/ş/g, 's')
                .replace(/Ş/g, 's')
                .replace(/ö/g, 'o')
                .replace(/Ö/g, 'o')
                .replace(/ç/g, 'c')
                .replace(/Ç/g, 'c')
                .trim();
        }

        function getCuratedTestBooks(searchTerm) {
            const normalizedTerm = normalizeTextForSearch(searchTerm);
            const matches = curatedTestBooksLibrary.filter(book => {
                if (!normalizedTerm) {
                    return true;
                }
                const searchableText = normalizeTextForSearch([
                    book.title,
                    book.author,
                    book.summary,
                    book.publisher,
                    ...(book.tags || []),
                    ...(book.examLevels || [])
                ].join(' '));
                return searchableText.includes(normalizedTerm);
            }).slice(0, 15);

            return matches.map((book, index) => ({
                title: book.title,
                author: book.author,
                year: book.year,
                summary: book.summary,
                thumbnail: book.thumbnail,
                isbn: book.isbn,
                isbn13: book.isbn,
                isbn10: null,
                publisher: book.publisher || '',
                isTestBook: true,
                averageRating: book.averageRating || 4.8,
                ratingsCount: book.ratingsCount || 0,
                popularityScore: 250 - index * 10,
                fallbackUrls: [],
                source: 'curated-test-library'
            }));
        }
        
        // Yayınevi araması için kütüphaneden kitap getir
        function getCuratedBooksByPublisher(searchTerm) {
            const normalizedTerm = normalizeTextForSearch(searchTerm);
            if (!normalizedTerm || normalizedTerm.length < 2) {
                return [];
            }
            
            // Hem test kitapları hem de keşfet kitaplarından ara
            const allCuratedBooks = [...curatedTestBooksLibrary, ...DISCOVER_BOOKS];
            
            const matches = allCuratedBooks.filter(book => {
                const publisher = normalizeTextForSearch(book.publisher || '');
                const author = normalizeTextForSearch(book.author || '');
                const title = normalizeTextForSearch(book.title || '');
                
                // Yayınevi adı eşleşmesi (öncelikli)
                if (publisher.includes(normalizedTerm) || normalizedTerm.includes(publisher)) {
                    return true;
                }
                
                // Kelime bazlı eşleşme
                const searchWords = normalizedTerm.split(' ').filter(w => w.length > 2);
                if (searchWords.some(word => publisher.includes(word))) {
                    return true;
                }
                
                // Yazar veya başlıkta yayınevi adı geçiyorsa
                if (author.includes(normalizedTerm) || title.includes(normalizedTerm)) {
                    return true;
                }
                
                return false;
            });
            
            // Yayınevi eşleşmesine göre sırala (tam eşleşme önce)
            matches.sort((a, b) => {
                const pubA = normalizeTextForSearch(a.publisher || '');
                const pubB = normalizeTextForSearch(b.publisher || '');
                const exactA = pubA.includes(normalizedTerm);
                const exactB = pubB.includes(normalizedTerm);
                if (exactA && !exactB) return -1;
                if (!exactA && exactB) return 1;
                return 0;
            });
            
            return matches.slice(0, 20).map((book, index) => ({
                title: book.title,
                author: book.author,
                year: book.year || 'Bilinmiyor',
                summary: book.summary || '',
                thumbnail: book.thumbnail || null,
                isbn: book.isbn || null,
                isbn13: book.isbn || null,
                isbn10: null,
                publisher: book.publisher || '',
                isTestBook: book.tags ? true : false,
                averageRating: book.averageRating || 4.5,
                ratingsCount: book.ratingsCount || 0,
                popularityScore: 200 - index * 5,
                fallbackUrls: [],
                source: 'curated-library'
            }));
        }

        function mergeUniqueBooks(primaryBooks = [], extraBooks = []) {
            if (!Array.isArray(extraBooks) || extraBooks.length === 0) {
                return primaryBooks;
            }

            const merged = [...primaryBooks];
            const seenKeys = new Set(
                primaryBooks.map(book => `${(book.title || '').toLowerCase()}_${(book.author || '').toLowerCase()}`)
            );

            extraBooks.forEach(book => {
                const key = `${(book.title || '').toLowerCase()}_${(book.author || '').toLowerCase()}`;
                if (!seenKeys.has(key)) {
                    merged.push(book);
                    seenKeys.add(key);
                }
            });

            return merged;
        }

        function buildSearchQuery(searchTerm) {
            let query = searchTerm.trim();

            if (currentFilter === 'book') {
                query = `intitle:${query}`;
            } else if (currentFilter === 'author') {
                query = `inauthor:${query}`;
            } else if (currentFilter === 'publisher') {
                query = `inpublisher:${query}`;
            } else if (currentFilter === 'test') {
                // Test kitabı için daha iyi bir query oluştur
                // Kullanıcının arama terimi + test kitabı anahtar kelimeleri
                if (query) {
                    query = `${query} (test OR "soru bankası" OR "soru bankasi" OR sınav OR sinav OR yks OR tyt OR ayt OR lys OR deneme OR "konu anlatımlı" OR "konu anlatimli" OR çözümlü OR cozumlu OR özet OR ozet OR hazırlık OR hazirlik)`;
                } else {
                    // Eğer arama terimi yoksa sadece test kitabı anahtar kelimelerini ara
                    query = 'test OR "soru bankası" OR "soru bankasi" OR sınav OR sinav OR yks OR tyt OR ayt OR lys OR deneme OR "konu anlatımlı" OR "konu anlatimli" OR çözümlü OR cozumlu OR özet OR ozet OR hazırlık OR hazirlik';
                }
            }

            return query;
        }

        // Google Books API'den arama fonksiyonu
        async function searchGoogleBooks(query) {
            const maxApiResults = 40;
            let allItems = [];
            let startIndex = 0;

            // Kullanıcının seçtiği sıralama seçeneğini kullan
            // Not: Google Books API sadece 'relevance' ve 'newest' destekliyor
            // 'popular' için 'relevance' kullanıp sonra client-side sıralama yapacağız
            const orderBy = currentOrderBy === 'popular' ? 'relevance' : currentOrderBy;
            
            // Yayınevi araması için langRestrict'i kaldır (daha fazla sonuç için)
            const useLangRestrict = currentFilter !== 'publisher';
            const langParam = useLangRestrict ? '&langRestrict=tr' : '';
            
            let url = `${API_BASE_URL}?q=${encodeURIComponent(query)}&maxResults=${maxApiResults}&startIndex=${startIndex}${langParam}&orderBy=${orderBy}`;

            let response = await fetch(url);
            if (!response.ok) {
                return [];
            }

            let data = await response.json();
            if (data.items && data.items.length > 0) {
                allItems = [...data.items];

                // İkinci sayfa için istek yap
                if (data.totalItems > maxApiResults && MAX_RESULTS > maxApiResults) {
                    const remainingNeeded = Math.min(MAX_RESULTS - maxApiResults, maxApiResults);
                    startIndex = maxApiResults;
                    url = `${API_BASE_URL}?q=${encodeURIComponent(query)}&maxResults=${remainingNeeded}&startIndex=${startIndex}${langParam}&orderBy=${orderBy}`;

                    try {
                        response = await fetch(url);
                        if (response.ok) {
                            data = await response.json();
                            if (data.items && data.items.length > 0) {
                                allItems = [...allItems, ...data.items];
                            }
                        }
                    } catch (e) {
                        console.warn('İkinci sayfa yüklenemedi:', e);
                    }
                }
            }
            
            // Yayınevi filtresi için ek arama yap (inpublisher: ile sonuç az geldiyse)
            if (currentFilter === 'publisher' && allItems.length < 15) {
                const searchTerm = document.getElementById('searchInput').value.trim();
                // Genel arama ile de dene
                const generalUrl = `${API_BASE_URL}?q=${encodeURIComponent(searchTerm)}&maxResults=${maxApiResults}&orderBy=${orderBy}`;
                
                try {
                    const generalResponse = await fetch(generalUrl);
                    if (generalResponse.ok) {
                        const generalData = await generalResponse.json();
                        if (generalData.items && generalData.items.length > 0) {
                            // Yayınevi adını içeren sonuçları filtrele
                            const normalizedSearchTerm = normalizeTextForSearch(searchTerm);
                            const filteredItems = generalData.items.filter(item => {
                                const publisher = item.volumeInfo?.publisher || '';
                                const normalizedPublisher = normalizeTextForSearch(publisher);
                                return normalizedPublisher.includes(normalizedSearchTerm) || 
                                       normalizedSearchTerm.includes(normalizedPublisher);
                            });
                            
                            // Mevcut sonuçlara ekle (tekrarları önle)
                            const existingIds = new Set(allItems.map(item => item.id));
                            filteredItems.forEach(item => {
                                if (!existingIds.has(item.id)) {
                                    allItems.push(item);
                                    existingIds.add(item.id);
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.warn('Ek yayınevi araması başarısız:', e);
                }
            }

            return allItems;
        }

        // Open Library API'den kitap arama
        async function searchOpenLibrary(searchTerm, filter) {
            try {
                let searchParams = {};

                if (filter === 'author') {
                    searchParams = { author: searchTerm, limit: 30 };
                } else if (filter === 'book') {
                    searchParams = { title: searchTerm, limit: 30 };
                } else if (filter === 'publisher') {
                    // Open Library API'de publisher parametresi desteklenmiyor
                    // Genel arama yapıp sonra yayınevine göre filtreleyeceğiz
                    searchParams = { q: searchTerm, limit: 50 };
                } else {
                    // Tümü veya test için genel arama
                    searchParams = { q: searchTerm, limit: 30 };
                }

                const params = new URLSearchParams(searchParams);
                const url = `${OPEN_LIBRARY_API_URL}?${params.toString()}`;

                const response = await fetch(url);
                if (!response.ok) {
                    return [];
                }

                const data = await response.json();
                if (!data.docs || data.docs.length === 0) {
                    return [];
                }
                
                // Yayınevi filtresi için, yayınevi bilgisini içeren sonuçları öne çıkar
                let docs = data.docs;
                if (filter === 'publisher') {
                    const normalizedSearchTerm = normalizeTextForSearch(searchTerm);
                    // Yayınevi bilgisi olan ve eşleşen kitapları öncelikli sırala
                    docs = docs.sort((a, b) => {
                        const pubA = normalizeTextForSearch((a.publisher || []).join(' '));
                        const pubB = normalizeTextForSearch((b.publisher || []).join(' '));
                        const matchA = pubA.includes(normalizedSearchTerm) || normalizedSearchTerm.split(' ').some(w => w.length > 2 && pubA.includes(w));
                        const matchB = pubB.includes(normalizedSearchTerm) || normalizedSearchTerm.split(' ').some(w => w.length > 2 && pubB.includes(w));
                        if (matchA && !matchB) return -1;
                        if (!matchA && matchB) return 1;
                        return 0;
                    });
                }

                // Open Library sonuçlarını Google Books formatına çevir
                return docs.map(doc => {
                    const title = doc.title || doc.title_suggest || '';
                    if (!title || title.trim().length === 0) {
                        return null;
                    }

                    const authors = doc.author_name || [];
                    const author = authors.length > 0 ? authors.join(', ') : 'Yazar bilgisi yok';
                    const publishedYear = doc.first_publish_year || doc.publish_year?.[0] || 'Bilinmiyor';

                    // ISBN'leri bul (hem ISBN-13 hem ISBN-10 olabilir)
                    let isbn = null;
                    let isbnType = null;
                    if (doc.isbn && Array.isArray(doc.isbn)) {
                        // Önce 13 haneli ISBN'i ara
                        isbn = doc.isbn.find(i => i && i.length === 13);
                        if (isbn) {
                            isbnType = 'ISBN_13';
                        } else {
                            // 10 haneli ISBN'i ara
                            isbn = doc.isbn.find(i => i && i.length === 10);
                            if (isbn) {
                                isbnType = 'ISBN_10';
                            } else {
                                // İlk geçerli ISBN'i al
                                isbn = doc.isbn.find(i => i && (i.length === 10 || i.length === 13));
                                if (isbn) {
                                    isbnType = isbn.length === 13 ? 'ISBN_13' : 'ISBN_10';
                                }
                            }
                        }
                    }

                    // Kapak resmi URL'i
                    let thumbnail = null;
                    if (doc.cover_i) {
                        thumbnail = `https://covers.openlibrary.org/b/id/${doc.cover_i}-L.jpg`;
                    } else if (isbn) {
                        thumbnail = `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`;
                    }

                    // Özet
                    const description = doc.first_sentence?.[0] || doc.subtitle || 'Bu kitap hakkında özet bilgisi bulunmamaktadır.';
                    
                    // Yayınevi bilgisi
                    const publishers = doc.publisher || [];
                    const publisher = publishers.length > 0 ? publishers[0] : '';

                    return {
                        volumeInfo: {
                            title: title,
                            authors: authors,
                            publisher: publisher,
                            publishedDate: publishedYear.toString(),
                            description: description,
                            imageLinks: thumbnail ? { thumbnail: thumbnail, medium: thumbnail, large: thumbnail, extraLarge: thumbnail } : null,
                            industryIdentifiers: isbn ? [
                                { type: isbnType, identifier: isbn }
                            ] : null,
                            averageRating: 0,
                            ratingsCount: 0
                        },
                        source: 'openlibrary'
                    };
                }).filter(item => item !== null && item.volumeInfo.title);
            } catch (error) {
                console.error('Open Library API hatası:', error);
                return [];
            }
        }

        function extractYearFromDate(dateString) {
            if (!dateString) return 'Bilinmiyor';
            const match = dateString.match(/\d{4}/);
            if (match) {
                return match[0];
            }
            const normalized = dateString.replace(/[^\d]/g, '');
            if (normalized.length >= 4) {
                return normalized.substring(0, 4);
            }
            return 'Bilinmiyor';
        }

        // Akıllı özet kesme fonksiyonu - cümle veya kelime sonunda keser
        function truncateSummary(text, maxLength = 200) {
            if (!text) return '';
            
            // HTML etiketlerini temizle
            const cleaned = text.replace(/<[^>]*>?/gm, ' ').replace(/\s+/g, ' ').trim();
            
            // Zaten yeterince kısa
            if (cleaned.length <= maxLength) {
                return cleaned;
            }
            
            // maxLength'e kadar al
            let truncated = cleaned.substring(0, maxLength);
            
            // Son cümle sonunu bul (. ! ? karakterleri)
            const lastSentenceEnd = Math.max(
                truncated.lastIndexOf('. '),
                truncated.lastIndexOf('! '),
                truncated.lastIndexOf('? '),
                truncated.lastIndexOf('."'),
                truncated.lastIndexOf('.)'),
            );
            
            // Cümle sonu bulunduysa ve çok kısa değilse orada kes
            if (lastSentenceEnd > maxLength * 0.4) {
                return truncated.substring(0, lastSentenceEnd + 1).trim();
            }
            
            // Cümle sonu bulunamadı, son kelimeyi bul
            const lastSpace = truncated.lastIndexOf(' ');
            if (lastSpace > maxLength * 0.6) {
                return truncated.substring(0, lastSpace).trim() + '...';
            }
            
            // Hiçbir şey bulunamadı, direkt kes
            return truncated.trim() + '...';
        }

        function sanitizeSummary(text) {
            if (!text) {
                return 'Bu kitap hakkında özet bilgisi bulunmamaktadır.';
            }
            const withoutHtml = text.replace(/<[^>]*>?/gm, ' ');
            const normalized = withoutHtml.replace(/\s+/g, ' ').trim();
            if (!normalized) {
                return 'Bu kitap hakkında özet bilgisi bulunmamaktadır.';
            }
            return truncateSummary(normalized, 400);
        }

        function convertApiItemToBook(item) {
            if (!item || !item.volumeInfo) return null;

            const info = item.volumeInfo;
            const title = (info.title || '').trim();
            const authors = Array.isArray(info.authors) ? info.authors : [];
            const author = authors.length > 0 ? authors.join(', ') : 'Yazar bilgisi yok';
            const descriptionRaw = info.description || info.subtitle || '';
            const description = Array.isArray(descriptionRaw) ? descriptionRaw.join(' ') : descriptionRaw;

            if (!isValidBook(title, author, description)) {
                return null;
            }

            const publishedDate = info.publishedDate || '';
            const year = extractYearFromDate(publishedDate);

            const identifiers = Array.isArray(info.industryIdentifiers) ? info.industryIdentifiers : [];
            const isbn13Entry = identifiers.find(id => id.type === 'ISBN_13');
            const isbn10Entry = identifiers.find(id => id.type === 'ISBN_10');
            const isbn13 = isbn13Entry ? isbn13Entry.identifier : null;
            const isbn10 = isbn10Entry ? isbn10Entry.identifier : null;
            const isbn = isbn13 || isbn10 || null;

            const imageLinks = info.imageLinks || {};
            const imageCandidates = [
                imageLinks.extraLarge,
                imageLinks.large,
                imageLinks.medium,
                imageLinks.small,
                imageLinks.thumbnail,
                imageLinks.smallThumbnail
            ].filter(Boolean);

            let thumbnail = imageCandidates.length > 0 ? imageCandidates[0] : null;
            const fallbackUrls = [];

            imageCandidates.slice(1).forEach(url => {
                if (url && !fallbackUrls.includes(url)) {
                    fallbackUrls.push(url);
                }
            });

            if (!thumbnail && isbn) {
                thumbnail = getBookCoverFromMultipleSources(isbn, isbn13, isbn10);
            }

            if (isbn) {
                const isbnFallbacks = getBookCoverFallbackUrls(isbn, isbn13, isbn10);
                isbnFallbacks.forEach(url => {
                    if (url && !fallbackUrls.includes(url)) {
                        fallbackUrls.push(url);
                    }
                });
            }

            const averageRating = info.averageRating || 0;
            const ratingsCount = info.ratingsCount || 0;
            const popularityScore = ratingsCount > 0 ? Math.round((averageRating * ratingsCount) / 100) : 0;

            return {
                title: title || 'İsimsiz',
                author,
                year: year || 'Bilinmiyor',
                summary: sanitizeSummary(description),
                thumbnail: thumbnail || null,
                fallbackUrls,
                isbn,
                isbn13,
                isbn10,
                pageCount: info.pageCount || null,
                publisher: info.publisher || '',
                categories: info.categories || [],
                averageRating,
                ratingsCount,
                popularityScore,
                language: info.language || '',
                previewLink: info.previewLink || '',
                infoLink: info.infoLink || item.selfLink || '',
                source: item.source || 'google',
                isTestBook: isTestBook(title, description),
                isPopularInStores: false
            };
        }

        function buildBooksFromApiResults(apiItems = [], searchTerm = '') {
            let formattedBooks = Array.isArray(apiItems)
                ? apiItems.map(convertApiItemToBook).filter(Boolean)
                : [];

            if (formattedBooks.length === 0 && currentFilter === 'test') {
                return getCuratedTestBooks(searchTerm).slice(0, MAX_RESULTS);
            }

            let booksToShow = formattedBooks;

            if (currentFilter === 'test') {
                const curated = getCuratedTestBooks(searchTerm);
                const apiTestBooks = formattedBooks.filter(book => book.isTestBook);
                booksToShow = mergeUniqueBooks(curated, apiTestBooks);
            }
            
            // Yayınevi filtresi için client-side filtreleme ve kütüphane araması
            if (currentFilter === 'publisher' && searchTerm) {
                const normalizedSearchTerm = normalizeTextForSearch(searchTerm);
                
                // Önce kendi kütüphanemizden (test kitapları + keşfet) yayınevine göre ara
                const curatedPublisherBooks = getCuratedBooksByPublisher(searchTerm);
                
                // API sonuçlarından yayınevi bilgisi eşleşen kitapları al
                const publisherMatches = formattedBooks.filter(book => {
                    const publisher = book.publisher || '';
                    const normalizedPublisher = normalizeTextForSearch(publisher);
                    // Yayınevi adı arama terimini içeriyor mu veya tam eşleşme var mı?
                    return normalizedPublisher.includes(normalizedSearchTerm) || 
                           normalizedSearchTerm.includes(normalizedPublisher) ||
                           // Kısmi eşleşme kontrolü (kelime bazlı)
                           normalizedSearchTerm.split(' ').some(word => 
                               word.length > 2 && normalizedPublisher.includes(word)
                           );
                });
                
                // Kütüphane sonuçlarını öncelikli olarak birleştir
                if (curatedPublisherBooks.length > 0 || publisherMatches.length > 0) {
                    // Önce kütüphane sonuçları, sonra API sonuçları
                    booksToShow = mergeUniqueBooks(curatedPublisherBooks, publisherMatches);
                    
                    // Sırala: tam eşleşenler önce
                    booksToShow.sort((a, b) => {
                        const pubA = normalizeTextForSearch(a.publisher || '');
                        const pubB = normalizeTextForSearch(b.publisher || '');
                        const exactMatchA = pubA === normalizedSearchTerm || pubA.includes(normalizedSearchTerm);
                        const exactMatchB = pubB === normalizedSearchTerm || pubB.includes(normalizedSearchTerm);
                        if (exactMatchA && !exactMatchB) return -1;
                        if (!exactMatchA && exactMatchB) return 1;
                        return 0;
                    });
                } else {
                    // Yayınevi eşleşmesi bulunamadıysa, başlık veya yazarda yayınevi adı geçenleri de dahil et
                    const titleAuthorMatches = formattedBooks.filter(book => {
                        const title = normalizeTextForSearch(book.title || '');
                        const author = normalizeTextForSearch(book.author || '');
                        return title.includes(normalizedSearchTerm) || author.includes(normalizedSearchTerm);
                    });
                    booksToShow = titleAuthorMatches.length > 0 ? titleAuthorMatches : formattedBooks;
                }
            }

            const uniqueBooks = [];
            const seenKeys = new Set();

            booksToShow.forEach(book => {
                const key = `${(book.title || '').toLowerCase()}_${(book.author || '').toLowerCase()}`;
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueBooks.push(book);
                }
            });
            
            // Popülerlik sıralaması (currentOrderBy === 'popular' ise)
            if (currentOrderBy === 'popular') {
                uniqueBooks.sort((a, b) => {
                    // Öncelik sırası: ratingsCount > averageRating > popularityScore
                    const scoreA = (a.ratingsCount || 0) * 10 + (a.averageRating || 0) * 100 + (a.popularityScore || 0);
                    const scoreB = (b.ratingsCount || 0) * 10 + (b.averageRating || 0) * 100 + (b.popularityScore || 0);
                    return scoreB - scoreA; // Yüksekten düşüğe
                });
            }

            return uniqueBooks.slice(0, MAX_RESULTS);
        }

        async function searchBooks() {
            // Çift tıklama koruması: Eğer zaten bir arama yapılıyorsa, yeni arama başlatma
            if (isSearching) {
                return;
            }

            const searchTerm = document.getElementById('searchInput').value.trim();
            const resultsNormal = document.getElementById('results-normal');
            const resultsRandom = document.getElementById('results-random');
            const resultsTrend = document.getElementById('results-trend');
            const searchBtn = document.getElementById('searchBtn');

            // Container'ları yönet: Normal göster, diğerlerini gizle
            if (resultsNormal) resultsNormal.style.display = 'block';
            if (resultsRandom) resultsRandom.style.display = 'none';
            if (resultsTrend) resultsTrend.style.display = 'none';

            if (!searchTerm) {
                if (resultsNormal) {
                    resultsNormal.innerHTML = '<div class="no-results" role="status" aria-live="polite">Lütfen arama terimi girin.</div>';
                }
                isSearching = false; // Flag'i sıfırla
                return;
            }

            // Güvenlik: Arama terimi maksimum uzunluk kontrolü
            const MAX_SEARCH_LENGTH = 100;
            if (searchTerm.length > MAX_SEARCH_LENGTH) {
                if (resultsNormal) {
                    resultsNormal.innerHTML = `<div class="no-results" role="status" aria-live="polite">Arama terimi çok uzun. Maksimum ${MAX_SEARCH_LENGTH} karakter kullanabilirsiniz.<br><small>Girdiğiniz terim: ${searchTerm.length} karakter</small></div>`;
                }
                isSearching = false; // Flag'i sıfırla
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Ara';
                    searchBtn.setAttribute('aria-label', 'Ara');
                }
                return;
            }

            // Arama başladı: flag'i true yap ve butonu disable et
            isSearching = true;
            if (searchBtn) {
                searchBtn.disabled = true;
                searchBtn.textContent = 'Aranıyor...';
                searchBtn.setAttribute('aria-label', 'Arama yapılıyor, lütfen bekleyin');
            }
            if (window.AndroidBridge && typeof AndroidBridge.onSearchTriggered === 'function') {
                AndroidBridge.onSearchTriggered();
            }

            // Söz havuzu - Atatürk sözü her zaman ilk sırada
            const ataturkQuote = "Uyuyan milletler ya ölür, ya da köle olarak uyanırlar.";
            const otherQuotes = [
                "Suç ve Ceza: İnsanın kendi iç sesi en yüksek mahkemedir.",
                "Dönüşüm: İnsan bazen uyandığında sadece gerçek yüzünü görür.",
                "Diriliş: İnsanın kendini bulması, başkalarını anlamasıyla başlar.",
                "Kürk Mantolu Madonna: Aşk, bazen sessizliğin en yüksek sesidir.",
                "Sefiller: Kalbinle sev, çünkü akıl çoğu zaman yanılır.",
                "Tutunamayanlar: İnsan bazen kendini bile anlayamaz."
            ];
            const randomOtherQuote = otherQuotes[Math.floor(Math.random() * otherQuotes.length)];
            const selectedQuote = ataturkQuote;
            if (resultsNormal) {
                resultsNormal.innerHTML = '<div class="loading" role="status" aria-live="polite">Aranıyor... — <span style="opacity: 0.75; font-size: 0.9em; font-style: italic; margin-left: 4px;">"' + selectedQuote + '"</span></div>';
            }

            // Arama geçmişine ekle
            addToSearchHistory(searchTerm);
            hideSearchHistory(); // Dropdown'ı kapat

            // Arama sayacını artır
            let c = Number(localStorage.getItem("searchCount") || 0);
            localStorage.setItem("searchCount", c + 1);
            
            // Yeni rozet kazanıldı mı kontrol et (kırmızı bildirim noktası)
            checkForNewBadges();

            try {
                const query = buildSearchQuery(searchTerm);

                // Paralel olarak hem Google Books hem Open Library'den ara
                const [googleBooksResult, openLibraryResult] = await Promise.allSettled([
                    searchGoogleBooks(query),
                    searchOpenLibrary(searchTerm, currentFilter)
                ]);

                // Sonuçları birleştir
                let allItems = [];
                if (googleBooksResult.status === 'fulfilled') {
                    allItems = [...allItems, ...googleBooksResult.value];
                }
                if (openLibraryResult.status === 'fulfilled') {
                    allItems = [...allItems, ...openLibraryResult.value];
                }

                const booksToShow = buildBooksFromApiResults(allItems, searchTerm);

                if (!booksToShow || booksToShow.length === 0) {
                    currentBooks = [];
                    if (resultsNormal) {
                        const safeTerm = escapeHtml(searchTerm);
                        resultsNormal.innerHTML = `<div class="no-results" role="status" aria-live="polite">"${safeTerm}" için sonuç bulunamadı.<br><small>Farklı anahtar kelimeler veya filtreler denemeyi düşünebilirsiniz.</small></div>`;
                    }
                    return;
                }

                matchWithPopularBooks(booksToShow);
                currentBooks = booksToShow;
                displayResults(booksToShow);
            } catch (error) {
                console.error('Hata:', error);
                if (resultsNormal) {
                    resultsNormal.innerHTML = '<div class="no-results" role="status" aria-live="polite">Bir hata oluştu. Lütfen tekrar deneyin.<br><small>' + escapeHtml(error.message) + '</small></div>';
                }
            } finally {
                // Arama bitti: flag'i false yap ve butonu tekrar aktif et
                isSearching = false;
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.textContent = 'Ara';
                    searchBtn.setAttribute('aria-label', 'Ara');
                }
            }
        }

        function buildPurchaseLinks(book) {
            // Kitap adını temizle (gereksiz karakterleri kaldır)
            function cleanBookTitle(title) {
                if (!title) return '';
                // Fazla boşlukları temizle, özel karakterleri koru
                return title.trim().replace(/\s+/g, ' ');
            }

            // Yazar adını temizle
            function cleanAuthorName(author) {
                if (!author || author.toLowerCase().includes('yazar bilgisi yok')) return '';
                // İlk yazarı al ve temizle
                const firstAuthor = author.split(',')[0].trim();
                // "Yazar:" gibi ön ekleri kaldır
                return firstAuthor.replace(/^yazar:\s*/i, '').trim();
            }

            // Öncelik sırası: ISBN > Kitap Adı + Yazar > Sadece Kitap Adı
            let searchQuery = '';
            // cleanTitle'ı her durumda kullanmak için başta tanımla
            const cleanTitle = cleanBookTitle(book.title);

            if (book.isbn) {
                // ISBN ile arama (en kesin sonuç)
                searchQuery = book.isbn.replace(/[-\s]/g, ''); // ISBN'deki tire ve boşlukları kaldır
            } else {
                // Kitap adı ve yazar ile arama (daha spesifik)
                const authorFirst = cleanAuthorName(book.author);
                if (authorFirst) {
                    searchQuery = `${cleanTitle} ${authorFirst}`;
                } else {
                    searchQuery = cleanTitle;
                }
            }

            // Android kontrolü (tüm linklerde kullanılacak)
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            // D&R linki - ISBN yerine kitap adı + yazar kullan (D&R ISBN aramasında sorun var)
            const drAuthor = cleanAuthorName(book.author);
            let drSearchQuery = cleanTitle;
            if (drAuthor && drAuthor.length > 0) {
                drSearchQuery = `${cleanTitle} ${drAuthor}`;
            }
            const drLink = `https://www.dr.com.tr/search?q=${encodeURIComponent(drSearchQuery)}`;

            // BKM Kitap linki - ISBN yerine kitap adı + yazar kullan (daha güvenilir sonuç)
            const bkmAuthor = cleanAuthorName(book.author);
            let bkmSearchQuery = cleanTitle;
            if (bkmAuthor && bkmAuthor.length > 0) {
                // Çok uzun başlıkları kısalt
                let bkmTitle = cleanTitle;
                if (cleanTitle.length > 50) {
                    const titleWords = cleanTitle.split(' ');
                    bkmTitle = titleWords.slice(0, 6).join(' ');
                }
                bkmSearchQuery = `${bkmTitle} ${bkmAuthor}`;
            }
            let bkmLink = `https://www.bkmkitap.com/arama?q=${encodeURIComponent(bkmSearchQuery.trim())}`;
            
            // BKM Kitap için Android deep linking
            const bkmWebUrl = bkmLink;
            if (isAndroid) {
                // BKM için Intent ile web URL'i aç (app link sistemi kullanılacak)
                bkmLink = bkmWebUrl; // Intent ile açılacak
            }

            // Kitapyurdu linki - ISBN yerine kitap adı + yazar kullan (daha güvenilir sonuç)
            const kyAuthor = cleanAuthorName(book.author);
            let kitapyurduLink = '';
            if (kyAuthor && kyAuthor.length > 0) {
                // Kitapyurdu'nda kitap adı ve yazar ayrı parametrelerle arama
                kitapyurduLink = `https://www.kitapyurdu.com/index.php?route=product/search&filter_name=${encodeURIComponent(cleanTitle)}&filter_author=${encodeURIComponent(kyAuthor)}`;
            } else {
                kitapyurduLink = `https://www.kitapyurdu.com/index.php?route=product/search&filter_name=${encodeURIComponent(cleanTitle)}`;
            }
            
            // Kitapyurdu linki - normal web URL (MainActivity'de özel işlem yapılacak)
            // kitapyurduLink zaten web URL'i

            // Ortak optimizasyon fonksiyonu - Trendyol ve Hepsi Burada için
            // Sorun: "Portakal" gibi genel kelimeler başka ürünler getiriyor
            // Çözüm: Kitap adı + yazar + "kitap" kelimesi ekle
            function optimizeTitleForEcommerce(title, authorName) {
                if (!title || title.trim().length === 0) return 'kitap';
                
                // Alt başlıkları kaldır: ":" veya " - " sonrası
                let optimized = title.trim();
                
                // Önce ":" kontrolü (alt başlık ayracı)
                const colonIndex = optimized.indexOf(':');
                if (colonIndex > 0 && colonIndex < 50) {
                    optimized = optimized.substring(0, colonIndex).trim();
                }
                
                // Sonra " - " kontrolü (boşluklu tire - alt başlık ayracı)
                const dashWithSpaceIndex = optimized.indexOf(' - ');
                if (dashWithSpaceIndex > 0 && dashWithSpaceIndex < 50) {
                    optimized = optimized.substring(0, dashWithSpaceIndex).trim();
                }
                
                // Çok uzun başlıkları kısalt (ilk 5 kelime veya 40 karakter)
                if (optimized.length > 40) {
                    const titleWords = optimized.split(' ').filter(word => word.length > 0);
                    if (titleWords.length > 5) {
                        optimized = titleWords.slice(0, 5).join(' ');
                    } else {
                        optimized = optimized.substring(0, 40).trim();
                    }
                }
                
                // Çok kısa kontrolleri (2 karakterden kısa ise orijinal başlığı kullan)
                if (optimized.length < 2) {
                    const originalWords = title.trim().split(' ').filter(word => word.length > 0);
                    optimized = originalWords.slice(0, Math.min(3, originalWords.length)).join(' ');
                }
                
                // Yazar adını temizle ve ekle
                let author = '';
                if (authorName && !authorName.toLowerCase().includes('yazar bilgisi yok')) {
                    author = authorName.split(',')[0].trim(); // İlk yazarı al
                    if (author.length > 20) {
                        // Çok uzun yazar adlarını kısalt (sadece soyad)
                        const nameParts = author.split(' ');
                        if (nameParts.length > 1) {
                            author = nameParts[nameParts.length - 1]; // Son kelime (soyad)
                        }
                    }
                }
                
                // "kitap" kelimesi zaten başlıkta var mı kontrol et
                const hasBookWord = optimized.toLowerCase().includes('kitap') || 
                                    optimized.toLowerCase().includes('roman') ||
                                    optimized.toLowerCase().includes('soru bankası') ||
                                    optimized.toLowerCase().includes('hikaye') ||
                                    optimized.toLowerCase().includes('öykü');
                
                // Final arama sorgusu: "kitap adı" + "yazar" + "kitap"
                let finalQuery = optimized;
                
                if (author && author.length > 0) {
                    finalQuery = `${optimized} ${author}`;
                }
                
                if (!hasBookWord) {
                    finalQuery = `${finalQuery} kitap`;
                }
                
                return finalQuery.trim();
            }
            
            // Hepsi Burada linki - optimize edilmiş: kitap adı + yazar + "kitap"
            const optimizedTitle = optimizeTitleForEcommerce(cleanTitle, book.author);
            // Android'de HepsiBurada'nın gerçek app link formatı: hbapp://search?searchTerm=...
            let hepsiburadaLink = `https://www.hepsiburada.com/ara?q=${encodeURIComponent(optimizedTitle)}`;
            if (isAndroid) { // isAndroid zaten yukarıda tanımlı
                const searchTerm = encodeURIComponent(optimizedTitle);
                hepsiburadaLink = `hbapp://search?searchTerm=${searchTerm}`;
            }

            // Trendyol linki - optimize edilmiş: kitap adı + yazar + "kitap"
            const trendyolWebUrl = `https://www.trendyol.com/sr?q=${encodeURIComponent(optimizedTitle)}`;
            // Android'de Trendyol'un gerçek app link formatı (HepsiBurada gibi)
            let trendyolLink = trendyolWebUrl;
            if (isAndroid) {
                // Trendyol app link formatı: trendyol://sr?q=...
                const searchTerm = encodeURIComponent(optimizedTitle);
                trendyolLink = `trendyol://sr?q=${searchTerm}`;
            }

            // Amazon linki - kitap adı + yazar + "kitap"
            const amazonLink = `https://www.amazon.com.tr/s?k=${encodeURIComponent(optimizedTitle)}`;

            return { drLink, bkmLink, kitapyurduLink, hepsiburadaLink, trendyolLink, amazonLink };
        }

        // 📌 Fiyat Karşılaştırma Bileşeni
        function createPriceButton(book, links) {
            const btn = document.createElement("button");
            btn.className = "price-compare-btn";
            btn.innerText = "💰 Fiyat Karşılaştır";

            btn.onclick = () => showPriceModal(book, links);

            return btn;
        }

        async function showPriceModal(book, links) {
            const modal = document.createElement("div");
            modal.className = "price-modal";

            // Dinamik yükleme durumu için mağaza listesi
            const stores = [
                { name: "Amazon", key: "Amazon" },
                { name: "Kitapyurdu", key: "Kitapyurdu" },
                { name: "D&R", key: "DR" },
                { name: "Trendyol", key: "Trendyol" },
                { name: "Hepsiburada", key: "Hepsiburada" },
                { name: "BKM", key: "BKM" }
            ];

            // Loading state - dinamik ve animasyonlu
            modal.innerHTML = `
                <div class="price-content">
                    <h3>📊 Fiyat Karşılaştırma</h3>
                    <div class="price-loading-container">
                        <div class="price-loading-spinner"></div>
                        <div class="price-loading-text" id="loadingMainText">Fiyatlar aranıyor...</div>
                        <div class="price-loading-stores" id="loadingStores">
                            ${stores.map(store => `
                                <div class="price-loading-store" data-store="${store.key}">
                                    <span class="store-name">${store.name}</span>
                                    <span class="store-status">Aranıyor</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button class="close-modal">Kapat</button>
                </div>
            `;

            document.body.appendChild(modal);

            // Close handlers
            modal.querySelector(".close-modal").onclick = () => modal.remove();
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };

            // Dinamik yükleme mesajları
            const loadingTexts = [
                "Fiyatlar aranıyor...",
                "Mağazalar taranıyor...",
                "En iyi fiyatlar bulunuyor...",
                "Neredeyse hazır..."
            ];
            let textIndex = 0;
            const mainTextEl = document.getElementById('loadingMainText');
            let textInterval = null;
            if (mainTextEl) {
                textInterval = setInterval(() => {
                    textIndex = (textIndex + 1) % loadingTexts.length;
                    mainTextEl.textContent = loadingTexts[textIndex];
                }, 2000);
            }

            // Mağaza durumlarını güncelle
            const updateStoreStatus = (storeKey, status) => {
                const storeEl = modal.querySelector(`[data-store="${storeKey}"]`);
                if (storeEl) {
                    const statusEl = storeEl.querySelector('.store-status');
                    if (statusEl) {
                        statusEl.textContent = status;
                        if (status === 'Bulundu ✓') {
                            storeEl.classList.add('active');
                            statusEl.style.color = '#1db954';
                        } else if (status === 'Aranıyor' || status === 'Aranıyor...') {
                            statusEl.style.color = '#1db954';
                        } else if (status === 'Bulunamadı') {
                            statusEl.style.color = '#999';
                        }
                    }
                }
            };

            // Mağaza durumlarını başlat (rastgele sırayla)
            stores.forEach((store, index) => {
                setTimeout(() => {
                    updateStoreStatus(store.key, 'Aranıyor...');
                }, index * 200 + Math.random() * 300);
            });

            try {
                // API'den fiyatları çek (Port 3003 - Hybrid scraper)
                const response = await fetch(`http://localhost:3003/api/price?name=${encodeURIComponent(book.title)}`);
                const prices = await response.json();
                
                // Yükleme mesajını durdur
                if (textInterval) {
                    clearInterval(textInterval);
                }

                // Fiyatları bulundu olarak işaretle (animasyonlu)
                Object.entries(prices).forEach(([store, data], index) => {
                    setTimeout(() => {
                        const storeKey = stores.find(s => s.name === store)?.key || store;
                        const price = typeof data === 'object' ? (data?.price || "-") : data;
                        if (price !== "-" && price !== null && price !== undefined) {
                            updateStoreStatus(storeKey, 'Bulundu ✓');
                        } else {
                            updateStoreStatus(storeKey, 'Bulunamadı');
                        }
                    }, index * 150);
                });

                // Mağaza linklerini hazırla (6 mağaza)
                const storeLinks = {
                    "Amazon": links.amazonLink || "#",
                    "Kitapyurdu": links.kitapyurduLink || "#",
                    "DR": links.drLink || "#",
                    "Trendyol": links.trendyolLink || "#",
                    "Hepsiburada": links.hepsiburadaLink || "#",
                    "BKM": links.bkmLink || "#"
                };

                // Kısa bir gecikme sonra sonuçları göster (animasyon için)
                setTimeout(() => {
                    // Modal içeriğini güncelle - Sepete Git butonu ile
                    modal.innerHTML = `
                    <div class="price-content">
                        <h3>📊 Fiyat Karşılaştırma</h3>
                        ${Object.entries(prices).map(([store, data]) => {
                            // Eski format (sadece string) veya yeni format (obje) desteği
                            const price = typeof data === 'string' ? data : (data?.price || "-");
                            const productLink = typeof data === 'object' ? (data?.link || data?.deeplink || storeLinks[store]) : (storeLinks[store] || "#");
                            const deeplink = typeof data === 'object' ? (data?.deeplink || data?.link) : null;
                            const cartLink = typeof data === 'object' ? (data?.cartLink || data?.link) : null;
                            // Sepete ekleme için öncelik: cartLink > deeplink > productLink
                            const finalLink = cartLink || deeplink || productLink || "#";
                            
                            return `
                            <div class="price-row">
                                <span>${escapeHtml(store)}</span>
                                <strong>${price === "-" ? "-" : "₺" + escapeHtml(price)}</strong>
                                ${price !== "-" ? `<button class="go-buy-btn" onclick="(function(){const link='${finalLink}';if(link&&(link.startsWith('trendyol://')||link.startsWith('hepsiburada://'))){window.location.href=link;}else if(link&&link!=='#'&&link!=='null'){window.open(link,'_blank');}})()">🛒 Sepete Ekle</button>` : '<span>-</span>'}
                            </div>
                        `;
                        }).join("")}
                            <button class="close-modal">Kapat</button>
                        </div>
                    `;

                    // Close handlers'ı yeniden ekle
                    modal.querySelector(".close-modal").onclick = () => modal.remove();
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };
                }, 1200);
            } catch (error) {
                console.error("Fiyat yükleme hatası:", error);
                clearInterval(textInterval);
                
                // Tüm mağazaları hata olarak işaretle
                stores.forEach(store => {
                    updateStoreStatus(store.key, 'Hata ✗');
                });
                
                // Hata durumunda fallback göster
                setTimeout(() => {
                    modal.innerHTML = `
                        <div class="price-content">
                            <h3>📊 Fiyat Karşılaştırma</h3>
                            <div style="text-align: center; padding: 20px; color: var(--text-primary);">
                                <div style="font-size: 2em; margin-bottom: 10px;">⚠️</div>
                                <div>Fiyatlar yüklenemedi. Lütfen daha sonra tekrar deneyin.</div>
                            </div>
                            <button class="close-modal">Kapat</button>
                        </div>
                    `;
                    modal.querySelector(".close-modal").onclick = () => modal.remove();
                }, 1000);
            }
        }

        function getBookCoverInitials(title) {
            // Kitap başlığının ilk harflerini al (maksimum 2 harf)
            if (!title || title.trim().length === 0) {
                return 'KB';
            }

            // Sadece harf ve sayıları al
            const cleanTitle = title.trim().replace(/[^a-zA-ZçğıöşüÇĞIİÖŞÜ0-9\s]/g, '');
            const words = cleanTitle.split(/\s+/).filter(word => word.length > 0);

            if (words.length >= 2) {
                // İki kelime varsa, her birinin ilk harfini al
                const first = words[0][0] || '';
                const second = words[1][0] || '';
                if (first && second) {
                    return (first + second).toUpperCase();
                }
            }

            if (words.length === 1 && words[0].length >= 2) {
                // Tek kelime varsa, ilk 2 harfini al
                return words[0].substring(0, 2).toUpperCase();
            } else if (words.length === 1 && words[0].length === 1) {
                // Tek harf varsa, onu iki kez göster
                return (words[0] + words[0]).toUpperCase();
            }

            // Varsayılan olarak "KB" (Kitap)
            return 'KB';
        }

        function createPlaceholderImage(title, show = false, id = '') {
            const initials = getBookCoverInitials(title);
            const showClass = show ? 'show' : '';
            const idAttr = id ? `id="${id}"` : '';
            return `<div class="book-cover-placeholder ${showClass}" ${idAttr}>${escapeHtml(initials)}</div>`;
        }

        function displayResults(books, isFavoritesView = false) {
            const containerId = isFavoritesView ? 'favoritesContainer' : 'results-normal';
            const resultsContainer = document.getElementById(containerId);
            const uniqueId = isFavoritesView ? 'fav' : 'res';

            resultsContainer.innerHTML = books.map((book, index) => {
                // Görsel yükleme için daha iyi bir mekanizma
                let coverImage = '';
                const placeholderId = `placeholder-${uniqueId}-${index}`;
                const imageId = `image-${uniqueId}-${index}`;
                const favoriteId = `favorite-${uniqueId}-${index}`;
                const bookId = book.isbn || `${book.title}_${book.author}`;
                const isFav = isFavorite(book);

                if (book.thumbnail) {
                    // Görsel varsa, yükleme hatası durumunda placeholder göster
                    // ISBN varsa alternatif görsel kaynağı da dene
                    let imageSrc = book.thumbnail;
                    let fallbackSrc = '';

                    // Fallback URL'leri kullan (birden fazla kaynak)
                    const fallbackUrls = book.fallbackUrls || [];
                    if (fallbackUrls.length > 0) {
                        fallbackSrc = fallbackUrls[0]; // İlk fallback URL'i kullan
                    } else if (book.isbn) {
                        // Eğer fallback URL'leri yoksa, ISBN ile oluştur
                        const cleanIsbn = book.isbn.replace(/[-\s]/g, '');
                        fallbackSrc = `https://covers.openlibrary.org/b/isbn/${cleanIsbn}-L.jpg`;
                    }

                    coverImage = `<img id="${imageId}"
                                      src="${imageSrc}"
                                      alt="${escapeHtml(book.title)}"
                                      class="book-cover"
                                      loading="lazy"
                                      onerror="const img = document.getElementById('${imageId}'); const pl = document.getElementById('${placeholderId}'); ${fallbackSrc ? `if(img && img.src !== '${fallbackSrc}') { img.src = '${fallbackSrc}'; } else {` : ''} if(img) img.style.display='none'; if(pl) pl.classList.add('show'); ${fallbackSrc ? '}' : ''}">
                                  ${createPlaceholderImage(book.title, false, placeholderId)}`;
                } else {
                    // Görsel yoksa, fallback URL'leri veya ISBN ile diğer kaynaklardan dene
                    const fallbackUrls = book.fallbackUrls || [];
                    if (fallbackUrls.length > 0) {
                        // Birden fazla fallback URL'i var, sırayla dene
                        const firstUrl = fallbackUrls[0];
                        const remainingUrls = fallbackUrls.slice(1);
                        let onErrorCode = '';

                        if (remainingUrls.length > 0) {
                            // Birden fazla fallback URL'i varsa, sırayla dene
                            onErrorCode = `const img = document.getElementById('${imageId}'); const urls = ${JSON.stringify(remainingUrls)}; let currentIndex = 0; if(img && currentIndex < urls.length) { img.src = urls[currentIndex]; currentIndex++; } else { if(img) img.style.display='none'; const pl = document.getElementById('${placeholderId}'); if(pl) pl.classList.add('show'); }`;
                        } else {
                            // Tek fallback URL'i varsa
                            onErrorCode = `const img = document.getElementById('${imageId}'); const pl = document.getElementById('${placeholderId}'); if(img) img.style.display='none'; if(pl) pl.classList.add('show');`;
                        }

                        coverImage = `<img id="${imageId}"
                                          src="${firstUrl}"
                                          alt="${escapeHtml(book.title)}"
                                          class="book-cover"
                                          loading="lazy"
                                          onerror="${onErrorCode}">
                                      ${createPlaceholderImage(book.title, false, placeholderId)}`;
                    } else if (book.isbn) {
                        // Fallback URL'leri yoksa, ISBN ile Open Library'den dene
                        const cleanIsbn = book.isbn.replace(/[-\s]/g, '');
                        const openLibrarySrc = `https://covers.openlibrary.org/b/isbn/${cleanIsbn}-L.jpg`;
                        coverImage = `<img id="${imageId}"
                                          src="${openLibrarySrc}"
                                          alt="${escapeHtml(book.title)}"
                                          class="book-cover"
                                          loading="lazy"
                                          onerror="const img = document.getElementById('${imageId}'); const pl = document.getElementById('${placeholderId}'); if(img) img.style.display='none'; if(pl) pl.classList.add('show');">
                                      ${createPlaceholderImage(book.title, false, placeholderId)}`;
                    } else {
                        // Görsel yoksa direkt placeholder göster
                        coverImage = createPlaceholderImage(book.title, true, placeholderId);
                    }
                }

                const links = buildPurchaseLinks(book);
                const favoriteClass = isFav ? 'active' : '';
                const favoriteIcon = isFav ? '⭐' : '☆';

                // Mağazalarda popüler olup olmadığını kontrol et
                const isPopular = book.isPopularInStores || false;
                const popularBadge = isPopular ? '<span class="popular-badge" title="Mağazalarda popüler">🔥 Popüler</span>' : '';

                // BookId'yi güvenli bir şekilde encode et
                const safeBookId = bookId.replace(/'/g, "\\'");

                // Favoriler görünümü için küçük kart class'ı
                const favoriteSmallClass = isFavoritesView ? 'favorite-small' : '';

                return `
                <div class="book-card ${isPopular ? 'popular-book' : ''} ${favoriteSmallClass}" role="listitem" data-book-id="${escapeHtml(bookId)}" aria-label="Kitap: ${escapeHtml(book.title)}, Yazar: ${escapeHtml(book.author)}">
                    <button class="favorite-btn ${favoriteClass}"
                            id="${favoriteId}"
                            onclick="toggleFavorite(${index}, ${isFavoritesView}, event)"
                            aria-label="${isFav ? 'Favorilerden çıkar' : 'Favorilere ekle'}"
                            title="${isFav ? 'Favorilerden çıkar' : 'Favorilere ekle'}">
                        ${favoriteIcon}
                    </button>
                    ${coverImage}
                    <div class="book-info">
                        <div class="book-title">
                            ${escapeHtml(book.title)}
                            ${popularBadge}
                        </div>
                        <div class="book-author">Yazar: ${escapeHtml(book.author)}</div>
                        <div class="book-year">Basım Yılı: ${escapeHtml(book.year)}${book.publisher ? ` • Yayınevi: ${escapeHtml(book.publisher)}` : ''}</div>
                        <div class="book-summary">${escapeHtml(book.summary)}</div>
                        <div class="purchase-links" role="group" aria-label="Satın alma linkleri">
                            <a href="${links.drLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link dr-link"
                               aria-label="D&R'da ${escapeHtml(book.title)} kitabını satın al">D&R</a>
                            <a href="${links.bkmLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link bkm-link"
                               aria-label="BKM Kitap'ta ${escapeHtml(book.title)} kitabını satın al">BKM</a>
                            <a href="${links.kitapyurduLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link kitapyurdu-link"
                               aria-label="Kitapyurdu'nda ${escapeHtml(book.title)} kitabını satın al">Kitapyurdu</a>
                            <a href="${links.hepsiburadaLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link hepsiburada-link"
                               aria-label="Hepsiburada'da ${escapeHtml(book.title)} kitabını satın al">Hepsiburada</a>
                            <a href="${links.trendyolLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link trendyol-link"
                               aria-label="Trendyol'da ${escapeHtml(book.title)} kitabını satın al">Trendyol</a>
                            <a href="${links.amazonLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link amazon-link"
                               aria-label="Amazon'da ${escapeHtml(book.title)} kitabını satın al">Amazon</a>
                        </div>
                        <button class="price-compare-btn" data-book-index="${index}" data-unique-id="${uniqueId}">💰 Fiyat Karşılaştır</button>
                    </div>
                </div>
            `;
            }).join('');

            // Fiyat karşılaştırma butonlarına event listener ekle
            setTimeout(() => {
                const priceButtons = resultsContainer.querySelectorAll('.price-compare-btn[data-book-index]');
                priceButtons.forEach(btn => {
                    const bookIndex = parseInt(btn.getAttribute('data-book-index'));
                    const uniqueIdAttr = btn.getAttribute('data-unique-id');
                    if (bookIndex >= 0 && bookIndex < books.length) {
                        const book = books[bookIndex];
                        const links = buildPurchaseLinks(book);
                        btn.onclick = () => showPriceModal(book, links);
                    }
                });
            }, 100);

            // Görsel yükleme hatalarını kontrol et (fallback - 2 saniye sonra)
            setTimeout(() => {
                books.forEach((book, index) => {
                    const imageId = `image-${uniqueId}-${index}`;
                    const placeholderId = `placeholder-${uniqueId}-${index}`;
                    const img = document.getElementById(imageId);
                    const placeholder = document.getElementById(placeholderId);

                    if (img && placeholder) {
                        // Görsel yüklenemedi mi kontrol et
                        if (!img.complete || img.naturalHeight === 0 || img.naturalWidth === 0) {
                            img.style.display = 'none';
                            placeholder.classList.add('show');
                        }
                    }
                });
            }, 2000);
            
            // Native reklamı kitapların arasına ekle (eğer reklam yüklenmişse)
            if (!isFavoritesView) {
                setTimeout(() => {
                    insertNativeAdIntoResults();
                }, 100);
            }
        }

        function toggleFavorite(index, isFavoritesView, eventOrBookId) {
            // event parametresi artık 3. parametrede geliyor
            const event = eventOrBookId?.target ? eventOrBookId : null;
            let book = null;

            if (isFavoritesView) {
                // Favoriler görünümünden
                const favorites = getFavorites();
                if (index < favorites.length) {
                    book = favorites[index];
                    removeFromFavorites(book);
                    displayFavorites(); // Favorileri yeniden göster
                    
                    // Modal açıksa güncelle
                    const modal = document.getElementById('favoritesModal');
                    if (modal && modal.classList.contains('active')) {
                        displayFavoritesInModal();
                    }
                }
            } else {
                // Arama sonuçlarından veya trend rafından
                if (currentBooks && index < currentBooks.length) {
                    book = currentBooks[index];
                }
                
                // currentBooks'ta yoksa veya eksikse, DOM'dan al
                if (!book || !book.title) {
                    const btn = event?.target?.closest?.('.favorite-btn');
                    if (btn) {
                        const card = btn.closest('.book-card');
                        if (card) {
                            const titleEl = card.querySelector('.book-title');
                            const authorEl = card.querySelector('.book-author');
                            const yearEl = card.querySelector('.book-year');
                            const summaryEl = card.querySelector('.book-summary');
                            const imgEl = card.querySelector('.book-cover');
                            
                            const title = titleEl?.textContent?.trim() || '';
                            const author = authorEl?.textContent?.replace('Yazar: ', '').trim() || '';
                            const yearText = yearEl?.textContent || '';
                            const yearMatch = yearText.match(/Basım Yılı:\s*(\d{4})/);
                            const year = yearMatch ? yearMatch[1] : 'Bilinmiyor';
                            const summary = summaryEl?.textContent?.trim() || '';
                            const thumbnail = imgEl?.src || null;
                            
                            book = { 
                                title, 
                                author, 
                                year,
                                summary,
                                thumbnail,
                                isbn: null
                            };
                        }
                    }
                }

                if (book && book.title) {
                    const wasActive = isFavorite(book);
                    
                    if (wasActive) {
                        removeFromFavorites(book);
                    } else {
                        // Kitap bilgilerini eksiksiz kaydet
                        const bookToSave = {
                            title: book.title || '',
                            author: book.author || 'Bilinmeyen',
                            year: book.year || 'Bilinmiyor',
                            summary: book.summary || '',
                            thumbnail: book.thumbnail || null,
                            isbn: book.isbn || null,
                            publisher: book.publisher || ''
                        };
                        addToFavorites(bookToSave);
                    }
                    
                    // Tüm olası buton ID'lerini güncelle
                    const possibleIds = [
                        `favorite-res-${index}`,
                        `favorite-fav-${index}`,
                        `favorite-modal-${index}`,
                        `favorite-trend-${index}`
                    ];
                    
                    possibleIds.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) {
                            if (wasActive) {
                                btn.classList.remove('active');
                                btn.innerHTML = '☆';
                                btn.title = 'Favorilere ekle';
                                btn.setAttribute('aria-label', 'Favorilere ekle');
                            } else {
                                btn.classList.add('active');
                                btn.innerHTML = '⭐';
                                btn.title = 'Favorilerden çıkar';
                                btn.setAttribute('aria-label', 'Favorilerden çıkar');
                            }
                        }
                    });

                    // Modal açıksa güncelle
                    const modal = document.getElementById('favoritesModal');
                    if (modal && modal.classList.contains('active')) {
                        displayFavoritesInModal();
                    }
                    
                    // Başarılı animasyonu
                    const clickedBtn = event?.target?.closest?.('.favorite-btn');
                    if (clickedBtn) {
                        clickedBtn.style.transform = 'scale(1.3)';
                        setTimeout(() => {
                            clickedBtn.style.transform = '';
                        }, 200);
                    }
                } else {
                    console.error('Kitap bilgisi alınamadı');
                }
            }
        }

        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const str = String(text);
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        // Enter tuşu ile arama
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });

        // Fiyat yönetimi fonksiyonları
        function getPrices() {
            const prices = localStorage.getItem(PRICES_STORAGE_KEY);
            return prices ? JSON.parse(prices) : {};
        }

        function savePrices(prices) {
            localStorage.setItem(PRICES_STORAGE_KEY, JSON.stringify(prices));
        }

        function getBookPriceKey(book) {
            return book.isbn || `${book.title}_${book.author}`;
        }

        function getBookPrices(book) {
            const prices = getPrices();
            const key = getBookPriceKey(book);
            return prices[key] || {};
        }

        function saveBookPrices(book, priceData) {
            const prices = getPrices();
            const key = getBookPriceKey(book);
            prices[key] = priceData;
            savePrices(prices);
        }

        function displayResultsWithPrices(books) {
            const container = document.getElementById('favoritesModalContainer');
            const prices = getPrices();

            container.innerHTML = books.map((book, index) => {
                const bookKey = getBookPriceKey(book);
                const bookPrices = prices[bookKey] || {};
                const isFav = isFavorite(book);
                const favoriteClass = isFav ? 'active' : '';
                const favoriteIcon = isFav ? '⭐' : '☆';
                const isPopular = book.isPopularInStores || false;
                const popularBadge = isPopular ? '<span class="popular-badge" title="Mağazalarda popüler">🔥 Popüler</span>' : '';

                let coverImage = '';
                const placeholderId = `placeholder-modal-${index}`;
                const imageId = `image-modal-${index}`;
                const favoriteId = `favorite-modal-${index}`;

                if (book.thumbnail) {
                    coverImage = `<img id="${imageId}"
                                      src="${book.thumbnail}"
                                      alt="${escapeHtml(book.title)}"
                                      class="book-cover"
                                      loading="lazy"
                                      onerror="const img = document.getElementById('${imageId}'); const pl = document.getElementById('${placeholderId}'); if(img) img.style.display='none'; if(pl) pl.classList.add('show');">
                                  ${createPlaceholderImage(book.title, false, placeholderId)}`;
                } else {
                    coverImage = createPlaceholderImage(book.title, true, placeholderId);
                }

                const links = buildPurchaseLinks(book);

                return `
                <div class="book-card" data-book-id="${escapeHtml(bookKey)}">
                    <button class="favorite-btn ${favoriteClass}"
                            id="${favoriteId}"
                            onclick="toggleFavorite(${index}, false, event)"
                            title="${isFav ? 'Favorilerden çıkar' : 'Favorilere ekle'}">
                        ${favoriteIcon}
                    </button>
                    ${coverImage}
                    <div class="book-info">
                        <div class="book-title">
                            ${escapeHtml(book.title)}
                            ${popularBadge}
                        </div>
                        <div class="book-author">Yazar: ${escapeHtml(book.author)}</div>
                        <div class="book-year">Basım Yılı: ${escapeHtml(book.year)}</div>
                        <div class="book-summary">${escapeHtml(book.summary)}</div>

                        <div class="price-comparison-section">
                            <div id="priceFetchStatus-${index}"></div>
                            <div id="priceTableContainer-${index}">
                                ${generatePriceComparisonTable(bookPrices)}
                            </div>
                        </div>

                        <div class="purchase-links">
                            <a href="${links.drLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link dr-link">D&R</a>
                            <a href="${links.bkmLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link bkm-link">BKM</a>
                            <a href="${links.kitapyurduLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link kitapyurdu-link">Kitapyurdu</a>
                            <a href="${links.hepsiburadaLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link hepsiburada-link">Hepsiburada</a>
                            <a href="${links.trendyolLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link trendyol-link">Trendyol</a>
                            <a href="${links.amazonLink}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="purchase-link amazon-link">Amazon</a>
                        </div>
                        <button class="price-compare-btn" data-book-title="${escapeHtml(book.title)}" data-book-author="${escapeHtml(book.author)}">💰 Fiyat Karşılaştır</button>
                    </div>
                </div>
            `;
            }).join('');
            
            // Favorilerim fiyat karşılaştırma butonlarına event listener ekle
            container.querySelectorAll('.price-compare-btn').forEach(btn => {
                const title = btn.getAttribute('data-book-title');
                const author = btn.getAttribute('data-book-author');
                if (title) {
                    const book = books.find(b => b.title === title && (b.author === author || !author));
                    if (book) {
                        const links = buildPurchaseLinks(book);
                        btn.onclick = () => showPriceModal(book, links);
                    }
                }
            });
        }

        function generatePriceComparisonTable(bookPrices) {
            const sites = [
                { key: 'dr', name: 'D&R' },
                { key: 'bkm', name: 'BKM Kitap' },
                { key: 'kitapyurdu', name: 'Kitapyurdu' },
                { key: 'hepsiburada', name: 'Hepsiburada' },
                { key: 'trendyol', name: 'Trendyol' },
                { key: 'amazon', name: 'Amazon' }
            ];

            // Tüm siteleri göster, fiyat olmayanları da dahil et
            const allPrices = sites.map(site => ({
                name: site.name,
                key: site.key,
                price: bookPrices[site.key] ? parseFloat(bookPrices[site.key]) : null
            }));

            const validPrices = allPrices.filter(p => p.price !== null && p.price > 0);

            if (validPrices.length === 0) {
                return '';
            }

            const minPrice = Math.min(...validPrices.map(p => p.price));

            let tableHTML = '<table class="price-table"><thead><tr><th>Site</th><th>Fiyat</th></tr></thead><tbody>';

            // Önce fiyatı olanları göster
            validPrices.forEach(p => {
                const isBest = p.price === minPrice && p.price > 0;
                const rowClass = isBest ? 'best-price' : '';
                const priceDisplay = `${p.price.toFixed(2)} ₺`;

                tableHTML += `<tr class="${rowClass}">
                    <td><strong>${p.name}</strong></td>
                    <td class="price-value">${priceDisplay} ${isBest ? '🏆' : ''}</td>
                </tr>`;
            });

            // Fiyatı olmayan siteleri de göster (gri renkte)
            const sitesWithoutPrice = allPrices.filter(p => !p.price || p.price <= 0);
            sitesWithoutPrice.forEach(p => {
                tableHTML += `<tr>
                    <td><strong style="color: #999;">${p.name}</strong></td>
                    <td class="price-value empty">Fiyat bulunamadı</td>
                </tr>`;
            });

            tableHTML += '</tbody></table>';

            // En iyi fiyat bilgisi
            if (validPrices.length > 1) {
                const bestSite = validPrices.find(p => p.price === minPrice);
                tableHTML += `<p style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px; color: #155724; font-size: 13px;">
                    🏆 <strong>En iyi fiyat:</strong> ${bestSite.name} - ${minPrice.toFixed(2)} ₺
                </p>`;
            }

            return tableHTML;
        }


        function showAllPricesComparison() {
            const favorites = getFavorites();
            const prices = getPrices();

            if (favorites.length === 0) {
                alert('Karşılaştırılacak favori kitap yok.');
                return;
            }

            let comparisonHTML = '<div style="background: white; padding: 30px; border-radius: 15px; margin-top: 20px;"><h2 style="color: #333; margin-bottom: 20px;">📊 Tüm Kitapların Fiyat Karşılaştırması</h2>';

            favorites.forEach((book, bookIndex) => {
                const bookKey = getBookPriceKey(book);
                const bookPrices = prices[bookKey] || {};

                const sites = [
                    { key: 'dr', name: 'D&R' },
                    { key: 'bkm', name: 'BKM Kitap' },
                    { key: 'kitapyurdu', name: 'Kitapyurdu' },
                    { key: 'hepsiburada', name: 'Hepsiburada' },
                    { key: 'trendyol', name: 'Trendyol' },
                    { key: 'amazon', name: 'Amazon' }
                ];

                const validPrices = sites
                    .map(site => ({
                        name: site.name,
                        price: bookPrices[site.key] ? parseFloat(bookPrices[site.key]) : null
                    }))
                    .filter(p => p.price !== null && p.price > 0);

                if (validPrices.length === 0) {
                    return; // Bu kitap için fiyat yoksa atla
                }

                const minPrice = Math.min(...validPrices.map(p => p.price));

                comparisonHTML += `<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3 style="color: #333; margin-bottom: 15px;">${escapeHtml(book.title)}</h3>
                    <table class="price-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Site</th>
                                <th>Fiyat</th>
                            </tr>
                        </thead>
                        <tbody>`;

                sites.forEach(site => {
                    const price = bookPrices[site.key] ? parseFloat(bookPrices[site.key]) : null;
                    if (price && price > 0) {
                        const isBest = price === minPrice;
                        const rowClass = isBest ? 'best-price' : '';
                        comparisonHTML += `<tr class="${rowClass}">
                            <td><strong>${site.name}</strong></td>
                            <td class="price-value">${price.toFixed(2)} ₺ ${isBest ? '🏆' : ''}</td>
                        </tr>`;
                    }
                });

                comparisonHTML += `</tbody></table></div>`;
            });

            comparisonHTML += '</div>';

            // Yeni bir modal veya alert ile göster
            const comparisonModal = document.createElement('div');
            comparisonModal.className = 'favorites-modal active';
            comparisonModal.innerHTML = `
                <div class="favorites-modal-content">
                    <div class="modal-header">
                        <h2>📊 Tüm Fiyat Karşılaştırması</h2>
                        <button class="close-modal-btn" onclick="this.closest('.favorites-modal').remove()">✕ Kapat</button>
                    </div>
                    ${comparisonHTML}
                </div>
            `;
            document.body.appendChild(comparisonModal);

            // Modal dışına tıklandığında kapat
            comparisonModal.addEventListener('click', function(e) {
                if (e.target === comparisonModal) {
                    comparisonModal.remove();
                }
            });
        }

        // Tekil kitap fiyat karşılaştırma modal fonksiyonları
        function openPriceComparisonModal(index, isFavoritesView) {
            if (index >= currentBooks.length) return;

            const book = currentBooks[index];
            const modal = document.getElementById('singleBookPriceModal');
            const content = document.getElementById('singleBookPriceContent');
            const bookKey = getBookPriceKey(book);
            const bookPrices = getBookPrices(book);

            let coverImage = '';
            if (book.thumbnail) {
                coverImage = `<img src="${book.thumbnail}" alt="${escapeHtml(book.title)}" class="book-cover" style="max-width: 200px; margin: 0 auto 20px; display: block;">`;
            } else {
                const initials = getBookCoverInitials(book.title);
                coverImage = `<div class="book-cover-placeholder show" style="max-width: 200px; margin: 0 auto 20px;">${escapeHtml(initials)}</div>`;
            }

            const links = buildPurchaseLinks(book);

            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    ${coverImage}
                    <h3 style="color: #333; margin-bottom: 10px;">${escapeHtml(book.title)}</h3>
                    <p style="color: #666; margin-bottom: 5px;">${escapeHtml(book.author)}</p>
                    <p style="color: #888; font-size: 0.9em;">Basım Yılı: ${escapeHtml(book.year)}</p>
                </div>

                <div class="price-comparison-section">
                    <button class="fetch-prices-btn" id="fetchPricesBtn" onclick="fetchAllPrices('${escapeHtml(bookKey).replace(/'/g, "\\'")}', '${escapeHtml(book.title).replace(/'/g, "\\'")}', '${escapeHtml(book.isbn || '').replace(/'/g, "\\'")}')">
                        📋 Fiyatları Listele
                    </button>
                    <div id="priceFetchStatus"></div>
                    <div id="singleBookPriceTable">${generatePriceComparisonTable(bookPrices)}</div>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="color: #333; margin-bottom: 15px;">🛒 Satın Al</h4>
                    <div class="purchase-links">
                        <a href="${links.drLink}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="purchase-link dr-link">D&R</a>
                        <a href="${links.bkmLink}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="purchase-link bkm-link">BKM</a>
                        <a href="${links.kitapyurduLink}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="purchase-link kitapyurdu-link">Kitapyurdu</a>
                        <a href="${links.hepsiburadaLink}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="purchase-link hepsiburada-link">Hepsiburada</a>
                        <a href="${links.trendyolLink}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="purchase-link trendyol-link">Trendyol</a>
                        <a href="${links.amazonLink}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="purchase-link amazon-link">Amazon</a>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeSingleBookPriceModal() {
            const modal = document.getElementById('singleBookPriceModal');
            modal.classList.remove('active');
        }

        // Tüm favori kitaplar için fiyat çekme (API kullanarak)
        async function fetchAllFavoritesPrices() {
            const btn = document.getElementById('fetchAllPricesBtn');
            const statusDiv = document.getElementById('fetchAllPricesStatus');

            if (!btn || btn.disabled) return;

            const favorites = getFavorites();
            if (favorites.length === 0) {
                alert('Favori kitap bulunamadı.');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="price-loading"></span> Tüm fiyatlar çekiliyor...';
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="price-status">Tüm kitaplar için fiyatlar çekiliyor, lütfen bekleyin...</div>';
            }

            let totalFound = 0;
            let totalProcessed = 0;

            // Her kitap için sırayla fiyat çek (çok fazla istek olmaması için)
            for (let i = 0; i < favorites.length; i++) {
                const book = favorites[i];
                const bookKey = getBookPriceKey(book);
                const bookTitle = book.title;
                const isbn = book.isbn || '';

                try {
                    // Client-side fiyat çekme
                    const result = await fetchPricesClientSide(bookTitle, isbn);

                    if (result.success && result.data.success && result.data.totalFound > 0) {
                        const prices = result.data.prices;
                    saveBookPrices(book, prices);
                    totalFound += Object.keys(prices).length;

                    // Tabloyu güncelle
                    const tableContainer = document.getElementById(`priceTableContainer-${i}`);
                    if (tableContainer) {
                        tableContainer.innerHTML = generatePriceComparisonTable(prices);
                    }
                    }
                } catch (error) {
                    console.warn(`Kitap "${bookTitle}" için fiyat çekilemedi:`, error);
                }

                totalProcessed++;

                // İlerleme durumunu güncelle
                if (statusDiv) {
                    statusDiv.innerHTML = `<div class="price-status">İşleniyor: ${totalProcessed}/${favorites.length} kitap... (${totalFound} fiyat bulundu)</div>`;
                }

                // Her kitap arasında kısa bir bekleme (rate limiting için)
                if (i < favorites.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            // Sonuçları göster
            if (statusDiv) {
                if (totalFound > 0) {
                    statusDiv.innerHTML = `<div class="price-status success">✓ Tamamlandı! ${totalProcessed} kitap için toplam ${totalFound} fiyat bulundu.</div>`;
                } else {
                    statusDiv.innerHTML = '<div class="price-status error">Fiyat bulunamadı. Lütfen daha sonra tekrar deneyin.</div>';
                }
            }

            btn.disabled = false;
            btn.innerHTML = '🔄 Tüm Fiyatları Otomatik Çek';
        }

        // CORS proxy servisleri listesi (daha fazla alternatif)
        const CORS_PROXIES = [
            {
                name: 'allorigins',
                url: (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
                parseResponse: async (res) => {
                    const data = await res.json();
                    if (data.contents) {
                        return JSON.parse(data.contents);
                    }
                    return data;
                }
            },
            {
                name: 'cors-anywhere',
                url: (u) => `https://cors-anywhere.herokuapp.com/${u}`,
                parseResponse: async (res) => await res.json()
            },
            {
                name: 'codetabs',
                url: (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
                parseResponse: async (res) => await res.json()
            },
            {
                name: 'corsproxy',
                url: (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
                parseResponse: async (res) => await res.json()
            }
        ];

        // CORS proxy ile fetch (file:// protokolü için)
        function getCorsProxyUrl(url) {
            // Eğer file:// protokolü kullanılıyorsa CORS proxy kullan
            if (window.location.protocol === 'file:' || !window.location.origin || window.location.origin === 'null') {
                // İlk proxy'yi döndür (fallback mekanizması fetchWithTimeout içinde)
                return CORS_PROXIES[0].url(url);
            }
            return url; // Normal URL kullan
        }

        // Timeout ile fetch wrapper (CORS proxy desteği ile, fallback mekanizması)
        async function fetchWithTimeout(url, options, timeout = 30000) {
            const useProxy = window.location.protocol === 'file:' || !window.location.origin || window.location.origin === 'null';

            // Önce direkt deneme (API CORS ayarları düzeltildi, belki çalışır)
            if (useProxy) {
                // file:// protokolü için önce direkt deneme yap (bazı API'ler CORS'u düzelttiyse çalışabilir)
                try {
                    const directResponse = await new Promise((resolve, reject) => {
                        const timer = setTimeout(() => reject(new Error('Timeout')), 5000);
                        fetch(url, options)
                            .then(res => {
                                clearTimeout(timer);
                                resolve(res);
                            })
                            .catch(err => {
                                clearTimeout(timer);
                                reject(err);
                            });
                    });
                    if (directResponse.ok) {
                        console.log('✅ Direkt fetch başarılı (CORS çalışıyor)');
                        return directResponse;
                    }
                } catch (e) {
                    console.log('⚠️ Direkt fetch başarısız, proxy deneniyor...');
                }
            } else {
                // http/https protokolü için direkt fetch
                return new Promise((resolve, reject) => {
                    const timer = setTimeout(() => {
                        reject(new Error('İstek zaman aşımına uğradı'));
                    }, timeout);

                    fetch(url, options)
                        .then(response => {
                            clearTimeout(timer);
                            resolve(response);
                        })
                        .catch(error => {
                            clearTimeout(timer);
                            reject(error);
                        });
                });
            }

            // POST istekleri için özel işlem (proxy ile)
            if (options.method === 'POST' && options.body) {
                const bodyData = JSON.parse(options.body);
                const params = new URLSearchParams();
                params.append('bookTitle', bodyData.bookTitle || '');
                params.append('isbn', bodyData.isbn || '');
                const getUrl = url + '?' + params.toString();

                // Önce AllOrigins'i dene (en güvenilir)
                try {
                    const allOriginsUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(getUrl)}`;
                    console.log('🔄 AllOrigins proxy deneniyor...');
                    console.log('📍 Proxy URL:', allOriginsUrl);

                    const response = await new Promise((resolve, reject) => {
                        const timer = setTimeout(() => reject(new Error('Timeout')), 20000);
                        fetch(allOriginsUrl, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' }
                        })
                            .then(res => {
                                clearTimeout(timer);
                                resolve(res);
                            })
                            .catch(err => {
                                clearTimeout(timer);
                                reject(err);
                            });
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('📦 AllOrigins yanıtı:', data);

                        if (data.contents) {
                            try {
                                const parsed = JSON.parse(data.contents);
                                console.log('📦 Parse edilmiş veri:', parsed);

                                if (parsed && (parsed.success !== undefined || parsed.prices || parsed.status || parsed.error)) {
                                    console.log('✅ AllOrigins proxy başarılı!');
                                    return {
                                        ok: true,
                                        status: 200,
                                        json: async () => parsed
                                    };
                                }
                            } catch (e) {
                                console.warn('⚠️ AllOrigins parse hatası:', e.message);
                                console.warn('📦 Ham içerik:', data.contents);

                                // Eğer "Not Found" hatası varsa, API çalışmıyor demektir
                                if (data.contents && data.contents.includes('Not Found')) {
                                    console.error('❌ API bulunamadı - API deploy edilmemiş olabilir');
                                }
                            }
                        } else if (data.status) {
                            // AllOrigins hata yanıtı
                            console.warn('⚠️ AllOrigins hata:', data.status);
                        }
                    } else {
                        console.warn('⚠️ AllOrigins HTTP hatası:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.warn('❌ AllOrigins başarısız:', error.message);
                }

                // Diğer proxy'leri dene
                for (let i = 1; i < CORS_PROXIES.length; i++) {
                    try {
                        const proxy = CORS_PROXIES[i];
                        let proxyUrl = proxy.url(getUrl);

                        console.log(`🔄 Proxy deneniyor: ${proxy.name}`);

                        const response = await new Promise((resolve, reject) => {
                            const timer = setTimeout(() => reject(new Error('Timeout')), 15000);

                            fetch(proxyUrl, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                                .then(res => {
                                    clearTimeout(timer);
                                    resolve(res);
                                })
                                .catch(err => {
                                    clearTimeout(timer);
                                    reject(err);
                                });
                        });

                        if (response.ok) {
                            try {
                                const data = proxy.parseResponse ? await proxy.parseResponse(response) : await response.json();

                                if (data && (data.success !== undefined || data.prices || data.status)) {
                                    console.log(`✅ Proxy başarılı: ${proxy.name}`);
                                    return {
                                        ok: true,
                                        status: 200,
                                        json: async () => data
                                    };
                                }
                            } catch (parseError) {
                                console.warn(`Proxy ${proxy.name} parse hatası:`, parseError.message);
                                continue;
                            }
                        } else {
                            console.warn(`Proxy ${proxy.name} HTTP hatası:`, response.status);
                        }
                    } catch (error) {
                        console.warn(`❌ Proxy ${CORS_PROXIES[i].name} başarısız:`, error.message);
                        continue;
                    }
                }

                throw new Error('Tüm proxy servisleri başarısız. Lütfen API\'yi yeniden deploy edin (Render.com dashboard > Redeploy) veya bir web sunucusu üzerinden çalıştırın.');
            }

            // GET istekleri için proxy denemesi
            // Önce AllOrigins'i dene
            try {
                const allOriginsUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                console.log('🔄 AllOrigins proxy deneniyor (GET)...');

                const response = await new Promise((resolve, reject) => {
                    const timer = setTimeout(() => reject(new Error('Timeout')), 20000);
                    fetch(allOriginsUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    })
                        .then(res => {
                            clearTimeout(timer);
                            resolve(res);
                        })
                        .catch(err => {
                            clearTimeout(timer);
                            reject(err);
                        });
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.contents) {
                        try {
                            const parsed = JSON.parse(data.contents);
                            if (parsed && (parsed.status || parsed.success !== undefined)) {
                                console.log('✅ AllOrigins proxy başarılı (GET)!');
                                return {
                                    ok: true,
                                    status: 200,
                                    json: async () => parsed
                                };
                            }
                        } catch (e) {
                            // "Not Found" kontrolü
                            if (data.contents && data.contents.includes('Not Found')) {
                                console.error('❌ API bulunamadı (GET)');
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('AllOrigins başarısız (GET):', error.message);
            }

            // Diğer proxy'leri dene
            for (let i = 1; i < CORS_PROXIES.length; i++) {
                try {
                    const proxy = CORS_PROXIES[i];
                    const proxyUrl = proxy.url(url);

                    const response = await new Promise((resolve, reject) => {
                        const timer = setTimeout(() => reject(new Error('Timeout')), 10000);

                        fetch(proxyUrl, { method: 'GET' })
                            .then(res => {
                                clearTimeout(timer);
                                resolve(res);
                            })
                            .catch(err => {
                                clearTimeout(timer);
                                reject(err);
                            });
                    });

                    if (response.ok) {
                        return response;
                    }
                } catch (error) {
                    console.warn(`Proxy ${CORS_PROXIES[i].name} başarısız:`, error.message);
                    continue;
                }
            }

            throw new Error('Tüm proxy servisleri başarısız');
        }

        // API kodları kaldırıldı, direkt client-side kullanılıyor
        // Client-side fiyat çekme (API olmadan, fallback)
        async function fetchPricesClientSide(bookTitle, isbn) {
            const sites = [
                { key: 'dr', name: 'D&R', fetchFn: fetchDRPrice },
                { key: 'bkm', name: 'BKM Kitap', fetchFn: fetchBKMPrice },
                { key: 'kitapyurdu', name: 'Kitapyurdu', fetchFn: fetchKitapyurduPrice },
                { key: 'hepsiburada', name: 'Hepsiburada', fetchFn: fetchHepsiburadaPrice },
                { key: 'trendyol', name: 'Trendyol', fetchFn: fetchTrendyolPrice },
                { key: 'amazon', name: 'Amazon', fetchFn: fetchAmazonPrice }
            ];

            const prices = {};
            const results = [];

            // Paralel olarak tüm sitelerden fiyat çek
            const fetchPromises = sites.map(async (site) => {
                try {
                    const price = await site.fetchFn(bookTitle, isbn);
                    if (price && price > 0) {
                        prices[site.key] = price;
                        results.push({
                            site: site.key,
                            siteName: site.name,
                            price: price,
                            success: true
                        });
                    } else {
                        results.push({
                            site: site.key,
                            siteName: site.name,
                            price: null,
                            success: false
                        });
                    }
                } catch (error) {
                    console.warn(`${site.name} fiyat çekilemedi:`, error.message);
                    results.push({
                        site: site.key,
                        siteName: site.name,
                        price: null,
                        success: false,
                        error: error.message
                    });
                }
            });

            await Promise.allSettled(fetchPromises);

            // En iyi fiyatı bul
            const validPrices = Object.entries(prices).map(([key, price]) => ({
                site: key,
                siteName: sites.find(s => s.key === key)?.name || key,
                price: price
            }));

            let bestPrice = null;
            if (validPrices.length > 0) {
                bestPrice = validPrices.reduce((min, current) =>
                    current.price < min.price ? current : min
                );
            }

            console.log(`📊 Client-side fiyat çekme tamamlandı: ${validPrices.length} fiyat bulundu`);

            return {
                success: validPrices.length > 0,
                data: {
                    success: validPrices.length > 0,
                    bookTitle: bookTitle,
                    isbn: isbn,
                    prices: prices,
                    results: results,
                    bestPrice: bestPrice,
                    totalFound: validPrices.length,
                    timestamp: new Date().toISOString()
                },
                error: validPrices.length === 0 ? 'Client-side fiyat çekme başarısız - Tüm sitelerden fiyat çekilmeye çalışıldı ancak sonuç alınamadı' : null
            };
        }

        // Favoriler modal'ındaki tek bir kitap için fiyat çekme (API kullanarak)
        async function fetchPricesForBook(index, bookKey, bookTitle, isbn) {
            const btn = document.getElementById(`fetchPricesBtn-${index}`);
            const statusDiv = document.getElementById(`priceFetchStatus-${index}`);

            if (!btn || btn.disabled) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="price-loading"></span> Fiyatlar çekiliyor...';
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="price-status">Fiyatlar çekiliyor, lütfen bekleyin...</div>';
            }

            try {
                // Client-side fiyat çekme
                const result = await fetchPricesClientSide(bookTitle, isbn || '');

                if (!result.success) {
                    if (result.data && result.data.totalFound === 0) {
                        throw new Error('Fiyat bulunamadı. Tüm sitelerden fiyat çekilmeye çalışıldı ancak sonuç alınamadı. Lütfen daha sonra tekrar deneyin veya fiyatları manuel olarak kontrol edin.');
                    }
                    throw new Error(result.error || 'Fiyat çekme hatası');
                }

                const data = result.data;

                // API yanıtını kontrol et - farklı formatları destekle
                let prices = {};
                let totalFound = 0;
                let results = [];
                let bestPrice = null;

                if (data) {
                    // Format 1: { success: true, prices: {...}, totalFound: ... }
                    if (data.prices && typeof data.prices === 'object') {
                        prices = data.prices;
                        totalFound = Object.keys(prices).filter(k => prices[k] && prices[k] > 0).length;
                        results = Object.entries(prices)
                            .filter(([k, v]) => v && v > 0)
                            .map(([k, v]) => ({ site: k, siteName: k, price: v, success: true }));
                    }
                    // Format 2: { success: true, data: { prices: {...} } }
                    else if (data.data && data.data.prices) {
                        prices = data.data.prices;
                        totalFound = data.data.totalFound || Object.keys(prices).filter(k => prices[k] && prices[k] > 0).length;
                        results = data.data.results || [];
                    }
                    // Format 3: Direkt prices objesi
                    else if (data.success && data.totalFound !== undefined) {
                        prices = data.prices || {};
                        totalFound = data.totalFound || 0;
                        results = data.results || [];
                        bestPrice = data.bestPrice || null;
                    }
                }

                if (totalFound > 0 && Object.keys(prices).length > 0) {
                    // En iyi fiyatı bul
                    if (!bestPrice) {
                        const validPrices = Object.entries(prices)
                            .filter(([k, v]) => v && v > 0)
                            .map(([k, v]) => ({ site: k, siteName: k, price: v }));
                        if (validPrices.length > 0) {
                            bestPrice = validPrices.reduce((min, current) =>
                                current.price < min.price ? current : min
                            );
                        }
                    }

                    // Bulunan fiyatları listeleyelim - daha okunabilir format
                    const foundPricesList = results.length > 0
                        ? results
                            .filter(r => r.success && r.price)
                            .map(r => `<strong>${r.siteName || r.site}</strong>: ${r.price.toFixed(2)} ₺`)
                            .join(' | ')
                        : Object.entries(prices)
                            .filter(([k, v]) => v && v > 0)
                            .map(([k, v]) => `<strong>${k}</strong>: ${v.toFixed(2)} ₺`)
                            .join(' | ');

                    if (statusDiv) {
                        statusDiv.innerHTML = `<div class="price-status success">✓ ${totalFound} siteden fiyat bulundu!<br><div style="margin-top: 8px; font-size: 13px;">${foundPricesList}</div>${bestPrice ? `<br>🏆 <strong>En iyi fiyat:</strong> ${bestPrice.siteName || bestPrice.site} - ${bestPrice.price.toFixed(2)} ₺` : ''}</div>`;
                    }

                    // Tabloyu güncelle
                    const tableContainer = document.getElementById(`priceTableContainer-${index}`);
                    if (tableContainer) {
                        tableContainer.innerHTML = generatePriceComparisonTable(prices);
                    }

                    // Otomatik kaydet
                    const book = currentBooks[index];
                    if (book) {
                        saveBookPrices(book, prices);
                    }
                } else {
                    // Fiyat bulunamadı
                    if (statusDiv) {
                    statusDiv.innerHTML = `<div class="price-status error">
                            ❌ Fiyat bulunamadı.<br>
                        <small style="display: block; margin-top: 8px; color: #666;">
                            💡 <strong>Çözüm önerileri:</strong><br>
                            • Fiyatları manuel olarak kontrol etmek için kitap kartındaki site linklerine tıklayın<br>
                                • Internet bağlantınızı kontrol edin<br>
                                • Birkaç dakika sonra tekrar deneyin<br>
                                • Console'da hata mesajlarını kontrol edin (F12)
                            </small>
                        </div>`;
                    }
                }
            } catch (error) {
                console.error('Fiyat çekme hatası:', error);
                if (statusDiv) {
                    // file:// protokolü kontrolü
                    const isFileProtocol = window.location.protocol === 'file:';
                    let errorMsg = error.message;

                    if (isFileProtocol) {
                        errorMsg = '⚠️ Dosya doğrudan açıldığı için CORS hatası oluşuyor.';
                    }

                    statusDiv.innerHTML = `<div class="price-status error">
                        ❌ ${errorMsg}<br>
                        <small style="display: block; margin-top: 12px; color: #666; line-height: 1.6;">
                            ${isFileProtocol ? `
                            <strong style="color: #d32f2f; display: block; margin-bottom: 8px;">🔴 ÖNEMLİ: Web Sunucusu Gerekli!</strong>
                            Dosyayı doğrudan açtığınız için (file://) CORS kısıtlamaları nedeniyle fiyatlar çekilemiyor.<br><br>
                            <strong>✅ Çözüm - Web Sunucusu Kullanın:</strong><br>
                            <code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 4px 0;">
                                cd www<br>
                                python -m http.server 8000
                            </code><br><br>
                            Sonra tarayıcıda şu adresi açın:<br>
                            <code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 4px 0;">
                                http://localhost:8000/index.html
                            </code>
                            ` : `
                            💡 <strong>Otomatik API algılama aktif</strong> - Tüm API'ler deneniyor...<br>
                            • Birkaç saniye bekleyip tekrar deneyin<br>
                            • API'ler geçici olarak kullanılamıyor olabilir<br>
                            • Fiyatları manuel olarak kontrol etmek için site linklerine tıklayın
                            `}
                        </small>
                    </div>`;
                }
            }

            btn.disabled = false;
            btn.innerHTML = '📋 Fiyatları Listele';
        }

        // Fiyat çekme fonksiyonları (API kullanarak)
        async function fetchAllPrices(bookKey, bookTitle, isbn) {
            const btn = document.getElementById('fetchPricesBtn');
            const statusDiv = document.getElementById('priceFetchStatus');

            if (!btn || btn.disabled) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="price-loading"></span> Fiyatlar çekiliyor...';
            statusDiv.innerHTML = '<div class="price-status">Fiyatlar çekiliyor, lütfen bekleyin...</div>';

            try {
                // Client-side fiyat çekme
                const result = await fetchPricesClientSide(bookTitle, isbn || '');

                if (!result.success) {
                    if (result.data && result.data.totalFound === 0) {
                        throw new Error('Fiyat bulunamadı. Tüm sitelerden fiyat çekilmeye çalışıldı ancak sonuç alınamadı. Lütfen daha sonra tekrar deneyin veya fiyatları manuel olarak kontrol edin.');
                    }
                    throw new Error(result.error || 'Fiyat çekme hatası');
                }

                const data = result.data;

                // API yanıtını kontrol et - farklı formatları destekle
                let prices = {};
                let totalFound = 0;
                let results = [];
                let bestPrice = null;

                if (data) {
                    // Format 1: { success: true, prices: {...}, totalFound: ... }
                    if (data.prices && typeof data.prices === 'object') {
                        prices = data.prices;
                        totalFound = Object.keys(prices).filter(k => prices[k] && prices[k] > 0).length;
                        results = Object.entries(prices)
                            .filter(([k, v]) => v && v > 0)
                            .map(([k, v]) => ({ site: k, siteName: k, price: v, success: true }));
                    }
                    // Format 2: { success: true, data: { prices: {...} } }
                    else if (data.data && data.data.prices) {
                        prices = data.data.prices;
                        totalFound = data.data.totalFound || Object.keys(prices).filter(k => prices[k] && prices[k] > 0).length;
                        results = data.data.results || [];
                    }
                    // Format 3: Direkt prices objesi
                    else if (data.success && data.totalFound !== undefined) {
                        prices = data.prices || {};
                        totalFound = data.totalFound || 0;
                        results = data.results || [];
                        bestPrice = data.bestPrice || null;
                    }
                }

                if (totalFound > 0 && Object.keys(prices).length > 0) {
                    // En iyi fiyatı bul
                    if (!bestPrice) {
                        const validPrices = Object.entries(prices)
                            .filter(([k, v]) => v && v > 0)
                            .map(([k, v]) => ({ site: k, siteName: k, price: v }));
                        if (validPrices.length > 0) {
                            bestPrice = validPrices.reduce((min, current) =>
                                current.price < min.price ? current : min
                            );
                        }
                    }

                // Bulunan fiyatları listeleyelim - daha okunabilir format
                    const foundPricesList = results.length > 0
                        ? results
                            .filter(r => r.success && r.price)
                            .map(r => `<strong>${r.siteName || r.site}</strong>: ${r.price.toFixed(2)} ₺`)
                            .join(' | ')
                        : Object.entries(prices)
                            .filter(([k, v]) => v && v > 0)
                            .map(([k, v]) => `<strong>${k}</strong>: ${v.toFixed(2)} ₺`)
                            .join(' | ');

                    statusDiv.innerHTML = `<div class="price-status success">✓ ${totalFound} siteden fiyat bulundu!<br><div style="margin-top: 8px; font-size: 13px;">${foundPricesList}</div>${bestPrice ? `<br>🏆 <strong>En iyi fiyat:</strong> ${bestPrice.siteName || bestPrice.site} - ${bestPrice.price.toFixed(2)} ₺` : ''}</div>`;

                // Tabloyu güncelle
                const tableContainer = document.getElementById('singleBookPriceTable');
                if (tableContainer) {
                    tableContainer.innerHTML = generatePriceComparisonTable(prices);
                }

                // Otomatik kaydet
                const book = currentBooks.find(b => getBookPriceKey(b) === bookKey);
                if (book) {
                    saveBookPrices(book, prices);
                }
            } else {
                    // Fiyat bulunamadı
                statusDiv.innerHTML = `<div class="price-status error">
                        ❌ Fiyat bulunamadı.<br>
                    <small style="display: block; margin-top: 8px; color: #666;">
                        💡 <strong>Çözüm önerileri:</strong><br>
                        • Fiyatları manuel olarak kontrol etmek için aşağıdaki site linklerine tıklayın<br>
                            • API sunucusunun çalıştığından emin olun<br>
                            • Birkaç dakika sonra tekrar deneyin<br>
                            • Console'da hata mesajlarını kontrol edin (F12)
                        </small>
                    </div>`;
                }
            } catch (error) {
                console.error('Fiyat çekme hatası:', error);

                // file:// protokolü kontrolü
                const isFileProtocol = window.location.protocol === 'file:';
                let errorMsg = error.message;

                if (isFileProtocol) {
                    errorMsg = '⚠️ Dosya doğrudan açıldığı için CORS hatası oluşuyor.';
                }

                statusDiv.innerHTML = `<div class="price-status error">
                    ❌ ${errorMsg}<br>
                    <small style="display: block; margin-top: 12px; color: #666; line-height: 1.6;">
                        ${isFileProtocol ? `
                        <strong style="color: #d32f2f; display: block; margin-bottom: 8px;">🔴 ÖNEMLİ: Web Sunucusu Gerekli!</strong>
                        Dosyayı doğrudan açtığınız için (file://) CORS kısıtlamaları nedeniyle fiyatlar çekilemiyor.<br><br>
                        <strong>✅ Çözüm - Web Sunucusu Kullanın:</strong><br>
                        <code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 4px 0;">
                            cd www<br>
                            python -m http.server 8000
                        </code><br><br>
                        Sonra tarayıcıda şu adresi açın:<br>
                        <code style="background: #f5f5f5; padding: 4px 8px; border-radius: 4px; display: inline-block; margin: 4px 0;">
                            http://localhost:8000/index.html
                        </code>
                        ` : `
                        💡 <strong>Çözüm:</strong><br>
                        • Render.com dashboard'a gidin<br>
                        • API servisinizi bulun<br>
                        • "Redeploy" veya "Manual Deploy" butonuna tıklayın<br>
                        • Deploy tamamlandıktan sonra tekrar deneyin
                        `}
                    </small>
                </div>`;
            }

            btn.disabled = false;
            btn.innerHTML = '📋 Fiyatları Listele';
        }

        // CORS proxy kullanarak HTML çekme
        async function fetchWithProxy(url) {
            // Çalışan ve güvenilir proxy servisleri (CORS sorunlarını minimize etmek için)
            const proxies = [
                // 1. AllOrigins (JSON endpoint) - En güvenilir, CORS desteği iyi
                { url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, type: 'json', timeout: 12000 },
                // 2. CodeTabs Proxy - Güvenilir alternatif
                { url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, type: 'html', timeout: 10000 },
                // 3. AllOrigins (raw endpoint) - Hızlı alternatif
                { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, type: 'html', timeout: 10000 },
                // 4. CORS Anywhere (public instance)
                { url: `https://cors-anywhere.herokuapp.com/${encodeURIComponent(url)}`, type: 'html', timeout: 8000 },
                // 5. AllOrigins (alternatif domain)
                { url: `https://allorigins.win/get?url=${encodeURIComponent(url)}`, type: 'json', timeout: 10000 },
                // 6. CORS Proxy
                { url: `https://corsproxy.io/?${encodeURIComponent(url)}`, type: 'html', timeout: 8000 },
                // 7. CORS.sh
                { url: `https://api.cors.sh/${encodeURIComponent(url)}`, type: 'html', timeout: 8000 },
                // 8. ProxyCORS
                { url: `https://proxycors.com/api?url=${encodeURIComponent(url)}`, type: 'json', timeout: 8000 },
                // 9. YACDN
                { url: `https://yacdn.org/proxy/${encodeURIComponent(url)}`, type: 'html', timeout: 8000 },
                // 10. ThingProxy
                { url: `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(url)}`, type: 'html', timeout: 8000 }
            ];

            // Tüm proxy'leri paralel dene (daha hızlı sonuç için)
            const promises = proxies.map(async (proxy, index) => {
                try {
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('Timeout')), proxy.timeout)
                    );

                    const fetchPromise = fetch(proxy.url, {
                        method: 'GET',
                        headers: {
                            'Accept': proxy.type === 'json' ? 'application/json' : 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                            'Accept-Language': 'tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7'
                        },
                        mode: 'cors',
                        cache: 'no-cache',
                        credentials: 'omit'
                    });

                    const response = await Promise.race([fetchPromise, timeoutPromise]);

                    if (response && response.ok) {
                        let text = await response.text();

                        // JSON endpoint'lerden gelen veriyi parse et
                        if (proxy.type === 'json') {
                            try {
                                const json = JSON.parse(text);
                                text = json.contents || json.content || json.data || json.body || text;
                            } catch (e) {
                                // JSON parse edilemezse olduğu gibi kullan
                            }
                        }

                        // ProxyCORS özel parsing
                        if (proxy.url.includes('proxycors.com')) {
                            try {
                                const json = JSON.parse(text);
                                text = json.data || json.content || json.body || text;
                            } catch (e) {}
                        }

                        // CORS.sh özel parsing
                        if (proxy.url.includes('cors.sh')) {
                            try {
                                const json = JSON.parse(text);
                                text = json.data || json.content || json.html || text;
                            } catch (e) {}
                        }

                        // Geçerli HTML içeriği kontrolü
                        if (text && typeof text === 'string' && text.length > 100) {
                            return { success: true, text, index: index + 1, proxy: proxy.url.split('/')[2] };
                        }
                    }
                } catch (error) {
                    // Hataları sessizce yakala, bir sonraki proxy'ye geç
                    return { success: false, error: error.message, index: index + 1 };
                }
                return { success: false, error: 'Invalid response', index: index + 1 };
            });

            // Tüm sonuçları bekle ve ilk başarılı olanı döndür
            const results = await Promise.allSettled(promises);

            for (const result of results) {
                if (result.status === 'fulfilled' && result.value.success) {
                    console.log(`✓ Proxy başarılı: ${result.value.index}. servis (${result.value.proxy})`);
                    return result.value.text;
                }
            }

            // Tüm proxy'ler başarısız olduysa detaylı hata mesajı
            const errors = results
                .filter(r => r.status === 'fulfilled' && !r.value.success)
                .map(r => `Proxy ${r.value.index}: ${r.value.error}`)
                .join(', ');

            throw new Error(`Tüm proxy servisleri başarısız oldu. Hatalar: ${errors || 'Bilinmeyen hata'}. Lütfen daha sonra tekrar deneyin veya fiyatları manuel olarak kontrol edin.`);
        }

        // D&R fiyat çekme
        async function fetchDRPrice(bookTitle, isbn) {
            // Retry mekanizması - 2 kez dene
            for (let attempt = 0; attempt < 2; attempt++) {
                try {
                    const searchUrl = `https://www.dr.com.tr/search?q=${encodeURIComponent(isbn || bookTitle)}`;
                    const html = await fetchWithProxy(searchUrl);

                if (!html || html.length < 100) {
                    throw new Error('HTML içeriği yetersiz');
                }

                // JSON-LD structured data'dan fiyat çek (en güvenilir)
                const jsonLdRegex = /<script[^>]*type=["']application\/ld\+json["'][^>]*>(.*?)<\/script>/gis;
                const jsonMatches = html.match(jsonLdRegex);
                if (jsonMatches) {
                    for (const match of jsonMatches) {
                        try {
                            const jsonStr = match.replace(/<script[^>]*>|<\/script>/gi, '');
                            const json = JSON.parse(jsonStr);
                            if (json.offers && json.offers.price) {
                                const price = parseFloat(json.offers.price);
                                if (price > 10 && price < 10000) {
                                    console.log('D&R JSON fiyat bulundu:', price);
                                    return price;
                                }
                            }
                            if (json.price) {
                                const price = parseFloat(json.price);
                                if (price > 10 && price < 10000) {
                                    console.log('D&R JSON price bulundu:', price);
                                    return price;
                                }
                            }
                        } catch (e) {}
                    }
                }

                // Daha kapsamlı fiyat regex'leri
                const pricePatterns = [
                    /data-price=["']([0-9,\.]+)["']/gi,
                    /data-price=([0-9,\.]+)/gi,
                    /"price":\s*"([0-9,\.]+)"/gi,
                    /"price":\s*([0-9,\.]+)/gi,
                    /price["']?\s*:\s*["']?([0-9,\.]+)/gi,
                    /<span[^>]*class[^>]*["']price["'][^>]*>[\s]*([0-9,\.]+)[\s]*(?:TL|₺)?/gi,
                    /<div[^>]*class[^>]*["']price["'][^>]*>[\s]*([0-9,\.]+)[\s]*(?:TL|₺)?/gi,
                    /(?:fiyat|price)[^>]*>[\s]*([0-9]{1,4}(?:[.,][0-9]{2})?)[\s]*(?:TL|₺)/gi
                ];

                const foundPrices = [];
                for (const pattern of pricePatterns) {
                    const matches = html.match(pattern);
                    if (matches) {
                        for (const match of matches) {
                            const priceText = match.replace(/[^0-9,.]/g, '').replace(',', '.');
                            const price = parseFloat(priceText);
                            if (price > 10 && price < 10000 && !foundPrices.includes(price)) {
                                foundPrices.push(price);
                            }
                        }
                    }
                }

                // En yaygın fiyatı bul (en çok geçen)
                if (foundPrices.length > 0) {
                    const priceCounts = {};
                    foundPrices.forEach(p => {
                        priceCounts[p] = (priceCounts[p] || 0) + 1;
                    });
                    const mostCommonPrice = Object.keys(priceCounts).reduce((a, b) =>
                        priceCounts[a] > priceCounts[b] ? a : b
                    );
                    const finalPrice = parseFloat(mostCommonPrice);
                    console.log('D&R fiyat bulundu:', finalPrice);
                    return finalPrice;
                }

                // Genel fiyat arama (son çare) - daha spesifik
                const generalPriceRegex = /([0-9]{2,4}(?:\.[0-9]{2})?)[\s]*(?:TL|₺|lira|TRY)/gi;
                const generalMatches = html.match(generalPriceRegex);
                if (generalMatches) {
                    const prices = generalMatches.map(m => parseFloat(m.replace(/[^0-9.]/g, '')))
                        .filter(p => p > 10 && p < 10000);
                    if (prices.length > 0) {
                        // Ortalama fiyatı al (daha güvenilir)
                        const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                        console.log('D&R genel fiyat bulundu:', avgPrice);
                        return Math.round(avgPrice * 100) / 100;
                    }
                }

                // Fiyat bulunamadıysa ve son deneme değilse tekrar dene
                if (attempt < 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 saniye bekle
                    continue;
                }
                } catch (error) {
                    console.error(`D&R fiyat çekme hatası (deneme ${attempt + 1}/2):`, error.message);
                    if (attempt < 1) {
                        // Son deneme değilse tekrar dene
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }
                    // Son deneme de başarısız oldu, sessizce devam et
                }
            }
            return null;
        }

        // BKM Kitap fiyat çekme
        async function fetchBKMPrice(bookTitle, isbn) {
            try {
                let searchUrl;
                if (isbn) {
                    searchUrl = `https://www.bkmkitap.com/kitap/${isbn.replace(/[-\s]/g, '')}`;
                } else {
                    searchUrl = `https://www.bkmkitap.com/arama?q=${encodeURIComponent(bookTitle)}`;
                }

                const html = await fetchWithProxy(searchUrl);

                // JSON-LD structured data'dan fiyat çek (en güvenilir)
                const jsonLdRegex = /<script[^>]*type=["']application\/ld\+json["'][^>]*>(.*?)<\/script>/gis;
                const jsonMatches = html.match(jsonLdRegex);
                if (jsonMatches) {
                    for (const match of jsonMatches) {
                        try {
                            const jsonStr = match.replace(/<script[^>]*>|<\/script>/gi, '');
                            const json = JSON.parse(jsonStr);
                            if (json.offers && json.offers.price) {
                                const price = parseFloat(json.offers.price);
                                if (price > 10 && price < 10000) {
                                    console.log('BKM JSON fiyat bulundu:', price);
                                    return price;
                                }
                            }
                            if (json.price) {
                                const price = parseFloat(json.price);
                                if (price > 10 && price < 10000) {
                                    console.log('BKM JSON price bulundu:', price);
                                    return price;
                                }
                            }
                        } catch (e) {}
                    }
                }

                // BKM fiyat regex'leri
                const pricePatterns = [
                    /(?:fiyat|price|amount)[^>]*>[\s]*([0-9]{1,3}(?:\.[0-9]{2})?)[\s]*(?:TL|₺)/gi,
                    /<span[^>]*class[^>]*price[^>]*>[\s]*([0-9,\.]+)[\s]*(?:TL|₺)/gi,
                    /data-price=["']([0-9,\.]+)["']/gi,
                    /"price":\s*"([0-9,\.]+)"/gi,
                    /"price":\s*([0-9,\.]+)/gi,
                    /class="price"[^>]*>[\s]*([0-9,\.]+)/gi
                ];

                for (const pattern of pricePatterns) {
                    const matches = html.match(pattern);
                    if (matches) {
                        for (const match of matches) {
                            const priceText = match.replace(/[^0-9,.]/g, '').replace(',', '.');
                            const price = parseFloat(priceText);
                            if (price > 10 && price < 10000) {
                                console.log('BKM fiyat bulundu:', price);
                                return price;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('BKM fiyat çekme hatası:', error);
            }
            return null;
        }

        // Kitapyurdu fiyat çekme
        async function fetchKitapyurduPrice(bookTitle, isbn) {
            try {
                let searchUrl;
                if (isbn) {
                    searchUrl = `https://www.kitapyurdu.com/index.php?route=product/search&filter_name=${encodeURIComponent(isbn)}`;
                } else {
                    searchUrl = `https://www.kitapyurdu.com/index.php?route=product/search&filter_name=${encodeURIComponent(bookTitle)}`;
                }

                const html = await fetchWithProxy(searchUrl);

                // Kitapyurdu fiyat regex'leri
                const pricePatterns = [
                    /(?:fiyat|price)[^>]*>[\s]*([0-9]{1,3}(?:\.[0-9]{2})?)[\s]*(?:TL|₺)/gi,
                    /<span[^>]*class[^>]*price[^>]*>[\s]*([0-9,\.]+)[\s]*(?:TL|₺)/gi,
                    /data-price=["']([0-9,\.]+)["']/gi,
                    /"price":\s*"([0-9,\.]+)"/gi,
                    /class="price"[^>]*>[\s]*([0-9,\.]+)/gi,
                    /<div[^>]*class[^>]*fiyat[^>]*>[\s]*([0-9,\.]+)/gi
                ];

                for (const pattern of pricePatterns) {
                    const matches = html.match(pattern);
                    if (matches) {
                        for (const match of matches) {
                            const priceText = match.replace(/[^0-9,.]/g, '').replace(',', '.');
                            const price = parseFloat(priceText);
                            if (price > 10 && price < 10000) {
                                console.log('Kitapyurdu fiyat bulundu:', price);
                                return price;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Kitapyurdu fiyat çekme hatası:', error);
            }
            return null;
        }

        // Hepsiburada fiyat çekme
        async function fetchHepsiburadaPrice(bookTitle, isbn) {
            try {
                const searchUrl = `https://www.hepsiburada.com/ara?q=${encodeURIComponent(isbn || bookTitle)}`;
                const html = await fetchWithProxy(searchUrl);

                // Hepsiburada fiyat regex'leri
                const pricePatterns = [
                    /(?:fiyat|price|amount)[^>]*>[\s]*([0-9]{1,3}(?:\.[0-9]{2})?)[\s]*(?:TL|₺)/gi,
                    /<span[^>]*class[^>]*price[^>]*>[\s]*([0-9,\.]+)[\s]*(?:TL|₺)/gi,
                    /data-price=["']([0-9,\.]+)["']/gi,
                    /"price":\s*"([0-9,\.]+)"/gi,
                    /"price":\s*([0-9,\.]+)/gi,
                    /class="price"[^>]*>[\s]*([0-9,\.]+)/gi
                ];

                for (const pattern of pricePatterns) {
                    const matches = html.match(pattern);
                    if (matches) {
                        for (const match of matches) {
                            const priceText = match.replace(/[^0-9,.]/g, '').replace(',', '.');
                            const price = parseFloat(priceText);
                            if (price > 10 && price < 10000) {
                                console.log('Hepsiburada fiyat bulundu:', price);
                                return price;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Hepsiburada fiyat çekme hatası:', error);
            }
            return null;
        }

        // Trendyol fiyat çekme
        async function fetchTrendyolPrice(bookTitle, isbn) {
            try {
                const searchUrl = `https://www.trendyol.com/sr?q=${encodeURIComponent(isbn || bookTitle)}`;
                const html = await fetchWithProxy(searchUrl);

                // Trendyol fiyat regex'leri
                const pricePatterns = [
                    /(?:fiyat|price|amount)[^>]*>[\s]*([0-9]{1,3}(?:\.[0-9]{2})?)[\s]*(?:TL|₺)/gi,
                    /<span[^>]*class[^>]*price[^>]*>[\s]*([0-9,\.]+)[\s]*(?:TL|₺)/gi,
                    /data-price=["']([0-9,\.]+)["']/gi,
                    /"price":\s*"([0-9,\.]+)"/gi,
                    /"price":\s*([0-9,\.]+)/gi,
                    /class="price"[^>]*>[\s]*([0-9,\.]+)/gi
                ];

                for (const pattern of pricePatterns) {
                    const matches = html.match(pattern);
                    if (matches) {
                        for (const match of matches) {
                            const priceText = match.replace(/[^0-9,.]/g, '').replace(',', '.');
                            const price = parseFloat(priceText);
                            if (price > 10 && price < 10000) {
                                console.log('Trendyol fiyat bulundu:', price);
                                return price;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Trendyol fiyat çekme hatası:', error);
            }
            return null;
        }

        // Amazon fiyat çekme
        async function fetchAmazonPrice(bookTitle, isbn) {
            try {
                const searchUrl = `https://www.amazon.com.tr/s?k=${encodeURIComponent(isbn || bookTitle)}`;
                const html = await fetchWithProxy(searchUrl);

                // Amazon fiyat regex'leri
                const pricePatterns = [
                    /(?:fiyat|price|amount)[^>]*>[\s]*([0-9]{1,3}(?:\.[0-9]{2})?)[\s]*(?:TL|₺)/gi,
                    /<span[^>]*class[^>]*price[^>]*>[\s]*([0-9,\.]+)[\s]*(?:TL|₺)/gi,
                    /data-price=["']([0-9,\.]+)["']/gi,
                    /"price":\s*"([0-9,\.]+)"/gi,
                    /"price":\s*([0-9,\.]+)/gi,
                    /class="a-price"[^>]*>[\s]*([0-9,\.]+)/gi
                ];

                for (const pattern of pricePatterns) {
                    const matches = html.match(pattern);
                    if (matches) {
                        for (const match of matches) {
                            const priceText = match.replace(/[^0-9,.]/g, '').replace(',', '.');
                            const price = parseFloat(priceText);
                            if (price > 10 && price < 10000) {
                                console.log('Amazon fiyat bulundu:', price);
                                return price;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Amazon fiyat çekme hatası:', error);
            }
            return null;
        }

        // Modal dışına tıklandığında kapat
        document.addEventListener('click', function(e) {
            const singleModal = document.getElementById('singleBookPriceModal');
            if (e.target === singleModal) {
                closeSingleBookPriceModal();
            }
        });


        // Sayfa yüklendiğinde favori sayısını güncelle ve event listener'ları ekle
        document.addEventListener('DOMContentLoaded', function() {
            // localStorage başlatması
            if (!localStorage.getItem("searchCount")) localStorage.setItem("searchCount", 0);
            if (!localStorage.getItem("ownedBadges")) localStorage.setItem("ownedBadges", "[]");

            // Splash screen'i kapat (yumuşak geçiş)
            setTimeout(function() {
                try {
                    const splashScreen = document.getElementById('splash-screen');
                    if (splashScreen && !splashScreen.classList.contains('splash-hidden')) {
                        splashScreen.classList.remove('splash-visible');
                        splashScreen.classList.add('splash-hidden');
                        // Animasyon bittikten sonra DOM'dan kaldır
                        setTimeout(function() {
                            if (splashScreen) {
                                splashScreen.classList.add('splash-removed');
                            }
                        }, 1200);
                    }
                } catch (e) {
                    // Sessizce devam et
                }
            }, 2800); // 2.8 saniye

            // Tema tercihini yükle
            const savedTheme = getThemePreference();
            applyTheme(savedTheme);

            // Sistem teması değişikliğini dinle (sadece auto modda)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (getThemePreference() === 'auto') {
                    applyTheme('auto');
                }
            });

            updateFavoritesCount();

            // Ünvanı güncelle
            updateActiveTitle();
            
            // Yeni rozet var mı kontrol et (kırmızı bildirim noktası)
            checkForNewBadges();

            // Arama input event listener'ları
            const searchInput = document.getElementById('searchInput');
            const searchHistoryDropdown = document.getElementById('searchHistoryDropdown');
            const sortSelect = document.getElementById('sortSelect');

            // Input odaklandığında arama geçmişini göster
            if (searchInput) {
                searchInput.addEventListener('focus', function() {
                    showSearchHistory();
                });

                // Input'tan çıkıldığında dropdown'ı kapat (kısa bir gecikme ile)
                searchInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        hideSearchHistory();
                    }, 200); // Tıklama işleminin tamamlanması için gecikme
                });

                // Enter tuşu ile arama
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchBooks();
                    } else if (e.key === 'Escape') {
                        hideSearchHistory();
                    }
                });
            }

            // Sıralama seçeneği değiştiğinde
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    currentOrderBy = this.value;
                    // Eğer arama terimi varsa otomatik olarak yeniden ara
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm) {
                        searchBooks();
                    }
                });
            }

            // Rastgele Kitap butonu event listener
        });

        // displayResults fonksiyonu zaten favori durumunu kontrol ediyor, ek bir wrapper'a gerek yok
        // Native reklam verilerini sakla
        let nativeAdData = null;
        
        function showNativeAd(headline, body, cta, imageUrl) {
            try {
                // Native reklam verilerini sakla (kitaplar arasında göstermek için)
                nativeAdData = {
                    headline: headline || 'Sponsorlu İçerik',
                    body: body || '',
                    cta: cta || 'Detayları Gör',
                    imageUrl: imageUrl || ''
                };
                
                // Eğer sonuçlar zaten gösterilmişse, reklamı ekle
                insertNativeAdIntoResults();
                
            } catch (error) {
                console.error('Native reklam verisi kaydedilirken hata:', error);
            }
        }
        
        // Native reklamı kitapların arasına ekle (3. kitaptan sonra)
        function insertNativeAdIntoResults() {
            if (!nativeAdData) return;
            
            // Mevcut native reklam varsa kaldır
            const existingAd = document.getElementById('native-ad-card');
            if (existingAd) {
                existingAd.remove();
            }
            
            // Sonuç container'ını bul
            const resultsContainer = document.getElementById('results-normal');
            if (!resultsContainer || resultsContainer.style.display === 'none') {
                // Sonuçlar görünmüyorsa ad-placeholder'a ekle
                const adPlaceholder = document.getElementById('ad-placeholder');
                if (adPlaceholder) {
                    adPlaceholder.innerHTML = '';
                    adPlaceholder.appendChild(createNativeAdCard());
                }
                return;
            }
            
            // Kitap kartlarını bul
            const bookCards = resultsContainer.querySelectorAll('.book-card:not(#native-ad-card)');
            
            if (bookCards.length >= 3) {
                // 3. kitaptan sonra ekle
                const thirdBook = bookCards[2];
                thirdBook.parentNode.insertBefore(createNativeAdCard(), thirdBook.nextSibling);
            } else if (bookCards.length > 0) {
                // 3'ten az kitap varsa en sona ekle
                resultsContainer.appendChild(createNativeAdCard());
            } else {
                // Hiç kitap yoksa ad-placeholder'a ekle
                const adPlaceholder = document.getElementById('ad-placeholder');
                if (adPlaceholder) {
                    adPlaceholder.innerHTML = '';
                    adPlaceholder.appendChild(createNativeAdCard());
                }
            }
        }
        
        // Native reklam kartı oluştur
        function createNativeAdCard() {
            const safeHeadline = escapeHtml(nativeAdData.headline);
            const safeBody = escapeHtml(nativeAdData.body);
            const safeCta = escapeHtml(nativeAdData.cta);
            const safeImageUrl = nativeAdData.imageUrl;
            const placeholderId = 'placeholder-native-ad';

            // Görsel varsa kullan, yoksa placeholder göster
            let imageHtml = '';
            if (safeImageUrl && safeImageUrl.trim() !== '') {
                imageHtml = `<img src="${escapeHtml(safeImageUrl)}" alt="${safeHeadline}" class="book-cover" style="max-width: 100%; height: auto;" onerror="this.style.display='none'; const placeholder = this.nextElementSibling; if(placeholder) placeholder.classList.add('show');">${createPlaceholderImage(nativeAdData.headline || 'Reklam', false, placeholderId)}`;
            } else {
                imageHtml = createPlaceholderImage(nativeAdData.headline || 'Reklam', true, placeholderId);
            }

            const adCard = document.createElement('div');
            adCard.className = 'book-card';
            adCard.id = 'native-ad-card';
            adCard.setAttribute('role', 'listitem');
            adCard.setAttribute('aria-label', `Reklam: ${safeHeadline}`);
            adCard.style.border = '2px solid rgba(255, 193, 7, 0.5)';
            adCard.style.background = 'linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.05))';

            adCard.innerHTML = `
                <div class="ad-badge" style="
                    position: absolute;
                    top: 8px;
                    left: 8px;
                    background: linear-gradient(135deg, #ffc107, #ff9800);
                    color: #000;
                    padding: 3px 8px;
                    border-radius: 4px;
                    font-size: 10px;
                    font-weight: bold;
                    z-index: 10;
                ">REKLAM</div>
                ${imageHtml}
                <div class="book-info">
                    <div class="book-title" style="margin-top: 5px;">
                        ${safeHeadline}
                    </div>
                    <div class="book-author" style="color: #888;">Sponsorlu içerik</div>
                    <div class="book-summary">${safeBody}</div>
                    <div class="purchase-links" role="group" aria-label="Sponsor bağlantısı">
                        <a href="#" class="purchase-link" style="background: linear-gradient(135deg, #ffc107, #ff9800); color: #000;" onclick="onNativeAdClick(event)">
                            ${safeCta}
                        </a>
                    </div>
                </div>
            `;

            return adCard;
        }

        // Native ad tıklama handler
        function onNativeAdClick(event) {
            event.preventDefault();
            try {
                if (window.AndroidBridge && AndroidBridge.onNativeAdClicked) {
                    AndroidBridge.onNativeAdClicked();
                }
            } catch (err) {
                console.error("Native ad click error:", err);
            }
        }

        // Modal Kapatma (Genel)
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Rozet verileri
        const badges = [
            { level: 10, name: "Kitap Meraklısı", icon: "📘" },
            { level: 20, name: "Kitap Kurdu", icon: "📚" },
            { level: 30, name: "Okuma Ustası", icon: "🧠" },
            { level: 40, name: "Kitap Yolcusu", icon: "🗺️" },
            { level: 50, name: "Kitap Kâşifi", icon: "🔭" },
            { level: 100, name: "Kitap Profesörü", icon: "🎓" }
        ];

        // Yeni rozet olup olmadığını kontrol et ve kırmızı nokta göster
        function checkForNewBadges() {
            let count = Number(localStorage.getItem("searchCount") || 0);
            let owned = JSON.parse(localStorage.getItem("ownedBadges") || "[]");
            
            let hasUnclaimed = false;
            badges.forEach(b => {
                const earned = count >= b.level;
                const alreadyOwned = owned.includes(b.level);
                if (earned && !alreadyOwned) hasUnclaimed = true;
            });
            
            const notifEl = document.getElementById("badgeNotif");
            if (notifEl) {
                notifEl.classList.toggle("active", hasUnclaimed);
            }
            
            return hasUnclaimed;
        }
        
        // Rozetleri ekranda listeleyen fonksiyon
        function openBadges() {
            document.getElementById("badgesModal").style.display = "flex";

            let count = Number(localStorage.getItem("searchCount") || 0);
            let owned = JSON.parse(localStorage.getItem("ownedBadges") || "[]");

            const grid = document.getElementById("badgeGrid");
            grid.innerHTML = "";

            let hasUnclaimed = false;

            badges.forEach(b => {
                const earned = count >= b.level;
                const alreadyOwned = owned.includes(b.level);

                if (earned && !alreadyOwned) hasUnclaimed = true;

                grid.innerHTML += `
                    <div class="badge-card ${earned ? 'unlocked' : ''}">
                        <div style="font-size:36px">${b.icon}</div>
                        <div style="margin-top:4px">${b.name}</div>
                        <small>${b.level} arama gerekli</small>
                        ${
                            earned && !alreadyOwned 
                                ? `<button onclick="claimBadge(${b.level}, '${b.name}', '${b.icon}')">AL</button>`
                                : alreadyOwned 
                                    ? `<small style='color:#4caf50;'>Alındı ✓</small>`
                                    : ``
                        }
                    </div>
                `;
            });

            document.getElementById("badgeNotif").classList.toggle("active", hasUnclaimed);
        }

        // Ünvanı sayfaya yazdıran fonksiyon
        function updateActiveTitle() {
            const title = localStorage.getItem("activeTitle") || "—";
            const activeTitleEl = document.getElementById("activeTitle");
            if (activeTitleEl) {
                activeTitleEl.innerText = title;
            }
        }

        // Rozet alma fonksiyonu
        function claimBadge(level, name, icon) {
            let owned = JSON.parse(localStorage.getItem("ownedBadges") || "[]");
            if (!owned.includes(level)) {
                owned.push(level);
            }
            localStorage.setItem("ownedBadges", JSON.stringify(owned));
            // Emoji + ünvan adı birlikte kaydet
            localStorage.setItem("activeTitle", `${icon} ${name}`);

            updateActiveTitle();  // Ünvan hemen yenilensin
            openBadges();         // Rozet ekranı yenilensin
        }

        // Modal kapatma fonksiyonu
        function closeBadges() {
            document.getElementById("badgesModal").style.display = "none";
        }

    </script>
    <script src="./scripts/badges.js?v=2.0.0"></script>
    
    <!-- AdSense Footer Ad -->
    <div class="ad-container ad-footer" data-ad-slot="footer-ad">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-xxxxxxxxxx"
             data-ad-slot="YYYYYYYY"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>
    
    <div id="banner-space"></div>
    
    <!-- AdSense Lazyload & Optimization Script -->
    <script>
        // AdSense yükleme optimizasyonu
        let activeAdCount = 0;
        const MAX_ACTIVE_ADS = 3;
        const adQueue = [];
        
        // Ad container CSS
        const adStyle = document.createElement('style');
        adStyle.textContent = `
            .ad-container {
                margin: 20px auto;
                text-align: center;
                min-height: 100px;
                max-width: 100%;
                overflow: hidden;
            }
            .ad-banner-top {
                margin: 20px 0;
                padding: 10px 0;
            }
            .ad-footer {
                margin-top: 30px;
                margin-bottom: 10px;
            }
            .ad-inline {
                margin: 20px 0;
            }
            @media (max-width: 768px) {
                .ad-container {
                    margin: 15px 10px;
                    min-height: 50px;
                }
            }
            
            /* Sponsor Box */
            .sponsor-box {
                background: rgba(255, 255, 255, 0.07);
                padding: 10px 14px;
                border-radius: 8px;
                margin: 15px 0;
                border-left: 4px solid #00ff9d;
                font-size: 14px;
            }
            body.dark-mode .sponsor-box {
                background: rgba(0, 0, 0, 0.35);
            }
            .sponsor-box a {
                color: #00ffa2;
                font-weight: 600;
                text-decoration: none;
            }
            .sponsor-box a:hover {
                text-decoration: underline;
            }
            
            /* Dark Mode Reklam Paleti */
            body.dark-mode .adsbygoogle iframe {
                filter: brightness(0.82) contrast(1.05);
                border-radius: 8px;
            }
            body.light-mode .adsbygoogle iframe {
                filter: brightness(1) contrast(1);
            }
            @media (prefers-color-scheme: dark) {
                body:not(.light-mode):not(.dark-mode) .adsbygoogle iframe {
                    filter: brightness(0.82) contrast(1.05);
                    border-radius: 8px;
                }
            }
            
            /* Native Ad Card */
            .native-ad-card {
                margin: 20px auto;
                padding: 15px;
                background: var(--card-bg, white);
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                position: relative;
                max-width: 100%;
            }
            body.dark-mode .native-ad-card {
                background: var(--card-bg, #2d2d2d);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }
            .ad-label {
                position: absolute;
                top: 8px;
                right: 8px;
                font-size: 10px;
                color: #999;
                text-transform: uppercase;
                letter-spacing: 1px;
            }
            body.dark-mode .ad-label {
                color: #666;
            }
        `;
        document.head.appendChild(adStyle);
        
        // Lazyload için Intersection Observer
        const adObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && activeAdCount < MAX_ACTIVE_ADS) {
                    const adContainer = entry.target;
                    const adSlot = adContainer.getAttribute('data-ad-slot');
                    if (adSlot && !adContainer.classList.contains('ad-loaded')) {
                        loadAd(adContainer);
                    }
                }
            });
        }, { rootMargin: '50px' });
        
        // Ad yükleme fonksiyonu
        function loadAd(container) {
            if (activeAdCount >= MAX_ACTIVE_ADS) {
                adQueue.push(container);
                return;
            }
            
            activeAdCount++;
            container.classList.add('ad-loaded');
            
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {
                console.error('AdSense error:', e);
            }
        }
        
        // Sayfa yüklendiğinde görünür reklamları gözlemle
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.ad-container').forEach(ad => {
                adObserver.observe(ad);
            });
        });
        
        // Aktif reklam sayısı azaldığında kuyruktan yükle
        setInterval(() => {
            if (activeAdCount < MAX_ACTIVE_ADS && adQueue.length > 0) {
                const nextAd = adQueue.shift();
                loadAd(nextAd);
            }
        }, 1000);
        
        // Kitap kartları arasına 4. karttan sonra ad ekleme fonksiyonu
        function insertAdAfterCard(container, cardIndex) {
            if (cardIndex === 4) {
                const adDiv = document.createElement('div');
                adDiv.className = 'ad-container ad-inline';
                adDiv.setAttribute('data-ad-slot', 'inline-ad-' + Date.now());
                adDiv.innerHTML = `
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-xxxxxxxxxx"
                         data-ad-slot="YYYYYYYY"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                `;
                const cards = container.querySelectorAll('.book-card');
                if (cards[3]) {
                    cards[3].insertAdjacentElement('afterend', adDiv);
                    adObserver.observe(adDiv);
                }
            }
        }
        
        // Mevcut searchBooks fonksiyonunu bulup güncelle (eğer varsa)
        const originalSearchBooks = window.searchBooks;
        if (originalSearchBooks) {
            window.searchBooks = function(...args) {
                const result = originalSearchBooks.apply(this, args);
                setTimeout(() => {
                    const resultsContainer = document.getElementById('results-normal');
                    if (resultsContainer) {
                        insertAdAfterCard(resultsContainer, 4);
                    }
                }, 500);
                return result;
            };
        }
        
        // Scroll Sonrası Reklam Tekrarı
        let adsLoaded = 0;
        window.addEventListener("scroll", () => {
            if (window.scrollY > window.innerHeight * 1.7 && adsLoaded < 1) {
                loadExtraAd();
                adsLoaded++;
            }
        });
        
        function loadExtraAd() {
            const contentArea = document.querySelector("#results-normal") || document.querySelector(".results-container") || document.querySelector(".container");
            if (!contentArea) return;
            
            const ad = document.createElement("div");
            ad.className = "native-ad-card";
            ad.innerHTML = `
                <div class="ad-label">Sponsorlu</div>
                <ins class="adsbygoogle"
                    style="display:block"
                    data-ad-client="ca-pub-xxxxxxxxxx"
                    data-ad-slot="33333333"
                    data-ad-format="auto"
                    data-full-width-responsive="true"></ins>
            `;
            contentArea.appendChild(ad);
            
            // AdSense'i yükle
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {
                console.error('AdSense scroll ad error:', e);
            }
        }
    </script>
</body>
</html>